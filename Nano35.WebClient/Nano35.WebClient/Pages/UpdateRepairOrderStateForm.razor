@using Nano35.WebClient.Services
@using Nano35.Contexts.Http.Repair
@inject HttpClient HttpClient
@inject RequestManager RequestManager
@inject ISessionProvider SessionProvider
@inject HealthService HealthService
@inject NavigationManager NavigationManager
@inject HttpPost PostRequest

<LoadingContent IsLoaded="_isLoaded">
    <EditForm Model="_model" OnSubmit="HandleValidSubmit">
        <DataAnnotationsValidator/>
        <InputField Title="Статус">
            <Controls>
                <RadzenDropDown Data=@(StateTypes.Select(a => new {Id = a.Item1, Name = a.Item2}))
                                TextProperty="Name"
                                ValueProperty="Id"
                                TValue="int"
                                @bind-Value="@_model.TypeId"
                                Style="width: 100%;"
                                Placeholder="..."
                                FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                FilterOperator="StringFilterOperator.Contains"
                                AllowFiltering="true"/>
            </Controls>
            <Validation>
                <ValidationMessage For="@(() => _model.TypeId)" />
            </Validation>
        </InputField>
        @if(_model.TypeId != (int) RepairOrderStateType.Completed)
        {
            <InputField Title="Комментарий">
                <Controls>
                    <RadzenTextBox Style="width: 100%;" 
                                   Placeholder="..."
                                   @bind-Value="@_model.Comment"/>
                </Controls>
                <Validation><ValidationMessage For="@(() => _model.Comment)" /></Validation>
            </InputField>
        }
        <RadzenButton type="submit" Text="Создать" ButtonStyle="ButtonStyle.Primary" Style="width: 100%" />
    </EditForm>
</LoadingContent>

@code
{
    private enum RepairOrderStateType
    {
        InWork = 1,
        Completed = 2,
        Stopped = 3,
        OnWait = 4
    }
    
    [CascadingParameter] BlazoredModalInstance ModalInstance { get; set; }
    [Parameter] public Guid RepairOrderId { get; set; }
    private bool _isLoaded;
    private CreateRepairOrderStateHttpBody _model;
    private List<Tuple<int, string>> StateTypes { get; set; } = new();
    
    protected override async Task OnInitializedAsync()
    {
        _model = new CreateRepairOrderStateHttpBody()
        {
            NewId = Guid.NewGuid(),
            RepairOrderId = RepairOrderId
        };
        
        StateTypes.Add(new Tuple<int, string>(1, "В работе"));
        StateTypes.Add(new Tuple<int, string>(2, "Завершен"));
        StateTypes.Add(new Tuple<int, string>(3, "Приостановлен"));
        StateTypes.Add(new Tuple<int, string>(4, "Ожиждает запчасти"));
        _isLoaded = true;
    }

    private async Task HandleValidSubmit()
    {
        await PostRequest.InvokeAsync<CreateRepairOrderStateHttpResponse, CreateRepairOrderStateHttpBody>($"RepairOrders/State", _model,
            resp =>
            {
                if (resp.IsSuccess())
                {
                    
                }
                else
                {
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
        
        await ModalInstance.CloseAsync();
    }
}