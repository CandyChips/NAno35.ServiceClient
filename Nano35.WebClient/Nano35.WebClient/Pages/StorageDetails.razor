@using Nano35.HttpContext.storage
@using Nano35.WebClient.Services
@inject HttpClient HttpClient
@inject IRequestManager RequestManager
@inject ISessionProvider SessionProvider


@if (_loading)
{
    <div class="d-flex justify-content-center" style="margin-top: 5rem; margin-bottom: 5rem">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden"></span>
        </div>
    </div>
}
else
{
    <RadzenFieldset Text="Информация"
                    Style="width: 100%;">
        <ul class="list-group" >
            <li class="list-group-item" role="alert" style="width: 100%; display: flex;">
                    @if (ArticleEdit == null)
                    {
                        <b style="display: flex; width: 85%; align-items: center">Артикул: @StorageItem.Article</b>
                                                        
                        <RadzenButton Click="@(_ => EditArticle())"
                                      Text="Изменить"
                                      Size="ButtonSize.Small"
                                      Style="display: flex"
                                      ButtonStyle="ButtonStyle.Primary"/>
                    }
                    else
                    {
                        <b style="display: flex; width: 85%; align-items: center">
                            <InputField Title="Артикул">
                                <Controls>
                                    <RadzenDropDown style="display: flex; align-items: center"
                                                    AllowClear="true" 
                                                    TValue="Guid"
                                                    Data=@(Articles.Select(g=> new {Id = g.Id, Name = $"{g.Brand} {g.Model}"}))
                                                    TextProperty="Name" 
                                                    ValueProperty="Id"
                                                    @bind-Value="ArticleEdit.ArticleId"/>
                                </Controls>
                            </InputField>
                        </b> 
                        <div style="display: flex; align-items: center">
                        <RadzenButton Click="@(_ => UpdateArticle())"
                                      Text="Обновить"
                                      Size="ButtonSize.Small"
                                      Style="display: flex; align-items: center;height: 40px; margin-right: 25px;"
                                      ButtonStyle="ButtonStyle.Primary"/>
                                
                        <RadzenButton Click=@(_ => { ArticleEdit = null; })
                                      ButtonStyle="ButtonStyle.Danger"
                                      Icon="close"
                                      Style="height: 40px; width: 40px"
                                      Size="ButtonSize.Small"/>
                        </div>
                    }
            </li>
            <li class="list-group-item" role="alert" style="width: 100%; display: flex; align-content: center">
                @if (PurchasePriceEdit == null)
                {
                    <b style="display: flex; width: 85%; align-items: center">Закупочная цена: @StorageItem.PurchasePrice</b>
                                                    
                    <RadzenButton Click="@(_ => EditPurchasePrice())"
                                  Text="Изменить"
                                  Size="ButtonSize.Small"
                                  Style="display: flex"
                                  ButtonStyle="ButtonStyle.Primary"/>
                }
                else
                {
                    <b style="display: flex; align-items: center; width: 85%">
                        <InputField title="Закупочная цена: ">
                            <Controls>
                                <RadzenNumeric style="display: flex; "
                                               @bind-Value="PurchasePriceEdit.PurchasePrice"
                                               ShowUpDown="false"
                                               Placeholder="@StorageItem.PurchasePrice.ToString()"
                                               Min="0"/>
                    
                            </Controls>
                        </InputField>
                    </b>
                    
                    <div style="display: flex; align-items: center">
                    <RadzenButton Click="@(_ => UpdatePurchasePrice())"
                                  Text="Обновить"
                                  Size="ButtonSize.Small"
                                  Style="display: flex; align-items: center;height: 40px; margin-right: 25px;"
                                  ButtonStyle="ButtonStyle.Primary"/>
                   
                    <RadzenButton Click=@(_ => { PurchasePriceEdit = null; })
                                  ButtonStyle="ButtonStyle.Danger"
                                  Icon="close"
                                  Style="height: 40px; width: 40px"
                                  Size="ButtonSize.Small"/>
                    </div>
                }
            </li>
            <li class="list-group-item" role="alert" style="width: 100%; display: flex;">
                @if (RetailPriceEdit == null)
                {
                    <b style="display: flex;  width: 85%; align-items: center">Цена продажи: @StorageItem.RetailPrice</b>
                                                    
                    <RadzenButton Click="@(_ => EditRetailPrice())"
                                  Text="Изменить"
                                  Size="ButtonSize.Small"
                                  Style="display: flex"
                                  ButtonStyle="ButtonStyle.Primary"/>
                }
                else
                {
                    <b style="display: flex; align-items: center; width: 85%"> 
                        <InputField Title="Цена продажи:">
                            <Controls>
                                <RadzenNumeric style="display: flex; align-items: center"
                                               @bind-Value="RetailPriceEdit.RetailPrice"
                                               ShowUpDown="false"
                                               Placeholder="@StorageItem.RetailPrice.ToString()"
                                               Min="0"/>
                            
                            </Controls>
                        </InputField>
                    </b>
                    
                    <div style="display: flex; align-items: center">
                    <RadzenButton Click="@(_ => UpdateRetailPrice())"
                                  Text="Обновить"
                                  Size="ButtonSize.Small"
                                  Style="display: flex; align-items: center;height: 40px; margin-right: 25px;"
                                  ButtonStyle="ButtonStyle.Primary"/>
                    <RadzenButton Click=@(_ => { RetailPriceEdit = null; })
                                  ButtonStyle="ButtonStyle.Danger"
                                  Icon="close"
                                  Style="height: 40px; width: 40px"
                                  Size="ButtonSize.Small"/>
                    </div>
                }
            </li>
            <li class="list-group-item" role="alert" style="width: 100%; display: flex;">
                @if (ConditionEdit == null)
                {
                    <b style="display: flex;  width: 85%; align-items: center">Состояние: @StorageItem.Condition</b>
                                                    
                    <RadzenButton Click="@(_ => EditCondition())"
                                  Text="Изменить"
                                  Size="ButtonSize.Small"
                                  Style="display: flex"
                                  ButtonStyle="ButtonStyle.Primary"/>
                }
                else
                {
                    <b style="display: flex; align-items: center; width: 85%"> 
                        <InputField Title="Состояние:">
                            <Controls>
                                <RadzenDropDown style="display: flex; "
                                                AllowClear="true" 
                                                TValue="Guid"
                                                Data=@(Conditions.Select(g=> new {Id = g.Id, Name = g.Name}))
                                                TextProperty="Name" 
                                                ValueProperty="Id"
                                                @bind-Value="ConditionEdit.ConditionId"/>
                            
                            </Controls>
                        </InputField>
                    </b>
                    
                    <div style="display: flex; align-items: center">
                        <RadzenButton Click="@(_ => UpdateCondition())"
                                      Text="Обновить"
                                      Size="ButtonSize.Small"
                                      Style="display: flex; align-items: center;height: 40px; margin-right: 25px;"
                                      ButtonStyle="ButtonStyle.Primary"/>
                        <RadzenButton Click=@(_ => { ConditionEdit = null; })
                                      ButtonStyle="ButtonStyle.Danger"
                                      Icon="close"
                                      Style="height: 40px; width: 40px"
                                      Size="ButtonSize.Small"/>
                    </div>
                }
            </li>
            <li class="list-group-item" role="alert" style="width: 100%; display: flex;">
                @if (CommentEdit == null)
                {
                    <b style="display: flex;  width: 85%; align-items: center">Комментарий: @StorageItem.Comment</b>
                                                    
                    <RadzenButton Click="@(_ => EditComment())"
                                  Text="Изменить"
                                  Size="ButtonSize.Small"
                                  Style="margin: 1rem 0; float: right; display: flex "
                                  ButtonStyle="ButtonStyle.Primary"/>
                }
                else
                {
                    <b style="display: flex; align-items: center; width: 85%"> 
                        <InputField Title="Комментарий:">
                            <Controls>
                                <RadzenTextBox style="display: flex;align-items: center"
                                               @bind-Value="CommentEdit.Comment"
                                               Placeholder="@StorageItem.Comment"/>
                            </Controls>
                        </InputField>
                    </b>
                    
                    <div style="display: flex; align-items: center">
                        <RadzenButton Click="@(_ => UpdateComment())"
                                      Text="Обновить"
                                      Size="ButtonSize.Small"
                                      Style="display: flex; align-items: center;height: 40px; margin-right: 25px;"
                                      ButtonStyle="ButtonStyle.Primary"/>
                        <RadzenButton Click=@(_ => { CommentEdit = null; })
                                  ButtonStyle="ButtonStyle.Danger"
                                  Icon="close"
                                  Style="height: 40px; width: 40px"
                                  Size="ButtonSize.Small"/>
                    </div>
                }
            </li>
            
        <li class="list-group-item" role="alert" style="width: 100%; display: flex;">
                @if (HiddenCommentEdit == null)
                {
                    <b style="display: flex;  width: 85%; align-items: center">Скрытый комментарий: @StorageItem.HiddenComment</b>
                                                    
                    <RadzenButton Click="@(_ => EditHiddenComment())"
                                  Text="Изменить"
                                  Size="ButtonSize.Small"
                                  Style="margin: 1rem 0; float: right; display: flex "
                                  ButtonStyle="ButtonStyle.Primary"/>
                }
                else
                {
                    <b style="display: flex; align-items: center; width: 85%"> 
                        <InputField Title="Скрытый комментарий:">
                            <Controls>
                                <RadzenTextBox style="display: flex;align-items: center"
                                               @bind-Value="HiddenCommentEdit.HiddenComment"
                                               Placeholder="@StorageItem.HiddenComment"/>
                            
                            
                            </Controls>
                        </InputField>
                    </b>
                    
                    <div style="display: flex; align-items: center">
                        <RadzenButton Click="@(_ => UpdateHiddenComment())"
                                      Text="Обновить"
                                      Size="ButtonSize.Small"
                                      Style="display: flex; align-items: center;height: 40px; margin-right: 25px;"
                                      ButtonStyle="ButtonStyle.Primary"/>
                        <RadzenButton Click=@(_ => { HiddenCommentEdit = null; })
                                  ButtonStyle="ButtonStyle.Danger"
                                  Icon="close"
                                  Style="height: 40px; width: 40px"
                                  Size="ButtonSize.Small"/>
                    </div>
                }
            </li>
        </ul>
    </RadzenFieldset>

    <RadzenFieldset Text="Товары в наличии"
                    Style="width: 60rem">
        <RadzenGrid Data="@(Places)"
                    EmptyText="Нет занятых мест в текущем подразделении..."
                    TItem="PlaceWithStorageItemOnUnit">
            <Columns>
                <RadzenGridColumn TItem="PlaceWithStorageItemOnUnit"
                                  Property="Name"
                                  Title="Место на складе"/>
                <RadzenGridColumn TItem="PlaceWithStorageItemOnUnit"
                                  Property="Count"
                                  Title="Количество"/>
            </Columns>
        </RadzenGrid>
    </RadzenFieldset>
}

@code
{
    [CascadingParameter] public IModalService Modal { get; set; }
    [CascadingParameter] BlazoredModalInstance ModalInstance { get; set; }

    [Parameter] public StorageItemOnInstanceViewModel Item { get; set; }
    private StorageItemViewModel StorageItem { get; set; } = new ();
    private List<PlaceWithStorageItemOnUnit> Places { get; set; } = new();

    private UpdateStorageItemArticleHttpBody ArticleEdit { get; set; }
    private List<ArticleViewModel> Articles { get; set; } = new();
    
    private UpdateStorageItemPurchasePriceHttpBody PurchasePriceEdit { get; set; }
    
    private UpdateStorageItemRetailPriceHttpBody RetailPriceEdit { get; set; }
    
    private UpdateStorageItemConditionHttpBody ConditionEdit { get; set; }
    private List<StorageItemConditionViewModel> Conditions { get; set; } = new();
    
    private UpdateStorageItemCommentHttpBody CommentEdit { get; set; }
    
    private UpdateStorageItemHiddenCommentHttpBody HiddenCommentEdit { get; set; }
    
    private bool _loading = true;

    
    protected override async Task OnInitializedAsync()
    {
        _loading = true;
        StorageItem = (await new GetStorageItemByIdRequest(RequestManager, HttpClient, new GetStorageItemByIdHttpQuery() {Id = Item.Item.Id}).Send()).Data;
        Places = (await new GetAllPlacesOfStorageItemOnUnitRequest(RequestManager, HttpClient, new GetAllPlacesOfStorageItemOnUnitHttpQuery(){StorageItemId = Item.Item.Id, UnitContainsStorageItemId = await SessionProvider.GetCurrentUnitId()}).Send()).Contains;
        _loading = false;
    }

    private async Task EditArticle(){Articles = (await (new GetAllArticlesRequest(RequestManager, HttpClient, new GetAllArticlesHttpQuery(){InstanceId = await SessionProvider.GetCurrentInstanceId()}).Send())).Data;ArticleEdit = new UpdateStorageItemArticleHttpBody(){Id = StorageItem.Id};}
    private async Task EditCondition(){Conditions = (await (new GetAllStorageItemConditionsRequest(RequestManager, HttpClient, new GetAllStorageItemConditionsHttpQuery(){}).Send())).Data;ConditionEdit = new UpdateStorageItemConditionHttpBody(){Id = StorageItem.Id};}
    private async Task EditPurchasePrice() => PurchasePriceEdit = new UpdateStorageItemPurchasePriceHttpBody(){Id = StorageItem.Id};
    private async Task EditRetailPrice() => RetailPriceEdit = new UpdateStorageItemRetailPriceHttpBody(){Id = StorageItem.Id};
    private async Task EditComment() => CommentEdit = new UpdateStorageItemCommentHttpBody(){Id = StorageItem.Id};
    private async Task EditHiddenComment() => HiddenCommentEdit = new UpdateStorageItemHiddenCommentHttpBody(){Id = StorageItem.Id};
    private async Task UpdateArticle(){await new UpdateStorageItemArticleRequest(RequestManager, HttpClient, ArticleEdit).Send(); ArticleEdit = null;}
    private async Task UpdatePurchasePrice(){await new UpdateStorageItemPurchasePriceRequest(RequestManager, HttpClient, PurchasePriceEdit).Send(); PurchasePriceEdit = null;}
    private async Task UpdateRetailPrice(){await new UpdateStorageItemRetailPriceRequest(RequestManager, HttpClient, RetailPriceEdit).Send(); RetailPriceEdit = null;}
    private async Task UpdateCondition(){await new UpdateStorageItemConditionRequest(RequestManager, HttpClient, ConditionEdit).Send(); ConditionEdit = null;}    
    private async Task UpdateComment(){await new UpdateStorageItemCommentRequest(RequestManager, HttpClient, CommentEdit).Send(); CommentEdit = null;}
    private async Task UpdateHiddenComment(){await new UpdateStorageItemHiddenCommentRequest(RequestManager, HttpClient, HiddenCommentEdit).Send(); HiddenCommentEdit = null;}
    private void CloseUpdateComment() => CommentEdit = null;
    private void CloseUpdateHiddenComment() => HiddenCommentEdit = null;
    private void CloseUpdateCondition() => ConditionEdit = null;
    private void CloseUpdateRetailPrice() => RetailPriceEdit = null;
    private void CloseUpdatePurchasePrice() => PurchasePriceEdit = null;
    private void CloseUpdateArticle() => ArticleEdit = null;

    
	

    public delegate T Proc<out T>();
    
    private TOut Helper<TOut>(Proc<TOut> exp)
    {
        return exp();
    }
}
