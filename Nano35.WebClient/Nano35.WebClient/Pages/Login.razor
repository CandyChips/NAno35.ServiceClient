@page "/log-in"
@using Nano35.WebClient.Services
@using Nano35.HttpContext.identity
@using System.Text.RegularExpressions
@using System.Threading
@inject IAuthService AuthService
@inject IRequestManager RequestManager
@inject NavigationManager NavigationManager
@inject HttpClient HttpClient

<div class="col-md-4 offset-md-4 mt-5">
    <LoadingContent IsLoaded="_isLoaded">
        <RadzenPanel>
            <ChildContent>
                <RadzenHeading Text="Авторизация"/>
                <EditForm Model="@_model" OnValidSubmit="HandleValidSubmit">
                    <DataAnnotationsValidator />
                    <InputField Title="Номер телефона">
                        <Controls><RadzenTextBox Style="width: 100%;" @bind-Value="Phone" Change=@(PhoneMask) /></Controls>
                        <Validation><ValidationMessage For="@(() => _model.Login)" /></Validation>
                    </InputField>
                    <InputField Title="Пароль">
                        <Controls><InputText @bind-Value="_model.Password" type="password" class="form-control"/></Controls>
                        <Validation><ValidationMessage For="@(() => _model.Password)" /></Validation>
                    </InputField>
                    <RadzenButton type="submit" Text="Войти" ButtonStyle="ButtonStyle.Primary"/>
                    <NavLink href="registration">
                        <RadzenButton type="button" Text="Регистрация" ButtonStyle="ButtonStyle.Secondary"/>
                    </NavLink>
                    @if (!string.IsNullOrEmpty(_error))
                    {
                        <div class="alert alert-danger mt-3 mb-0">@_error</div>
                    }
                </EditForm>
            </ChildContent>
        </RadzenPanel>
    </LoadingContent>
</div>

@code
{
    private GenerateUserTokenHttpBody _model = new();
    private bool _isLoaded = true;
    private string _error;
    private string Phone { get ; set ; } = "+7";

    protected override void OnInitialized()
    {
        _isLoaded = true;
    }

    private async Task HandleValidSubmit()
    {
        try
        {
            var response = await new HttpPostRequest<GenerateUserTokenHttpBody,GenerateUserTokenHttpResponse>(HttpClient, $"{RequestManager.IdentityServer}/Identity/Authenticate").PostAsync(_model); 
            await AuthService.Login(response.Token);
            NavigationManager.NavigateTo("/");
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }
    
    private void PhoneMask()
    {

        Phone = Regex.Replace(Phone, @"[^\d]", "");
        
        var countryCode = "+7";
        
        if (Phone.StartsWith("7"))
            Phone = Phone.Remove(0,1);
        
        if (Phone.StartsWith("8"))
            Phone = Phone.Remove(0,1);
        
        _model.Login = Phone;
        
        if (Phone.Length < 10)
            Phone = Phone.PadRight(10);

        if (Phone.Length > 10)
            Phone = Phone.Substring(0, 10);

        Phone = $"{countryCode}({Phone.Substring(0, 3)}) {Phone.Substring(3, 3)}-{Phone.Substring(6, 2)}-{Phone.Substring(8, 2)}";
        
        
    }
}
