@using Nano35.WebClient.Services
@using Nano35.HttpContext.instance
@inject HttpClient _httpClient
@inject IRequestManager _requestManager
@inject ISessionProvider _sessionProvider

<BoxedContent Width="40">
    <ClientsForm FormSubmitted="Submit" Model="_model" Error="@Error"/>
</BoxedContent>

@code
{
    [CascadingParameter] public IModalService Modal { get; set; }
    [CascadingParameter] BlazoredModalInstance ModalInstance { get; set; }
    
    private CreateClientHttpBody _model = new()
    {
        NewId = Guid.NewGuid(),
        InstanceId = Guid.Empty,
    };
    
    private string Error { get; set; }
    
    private async Task Submit()
    {
        try
        {
            Console.WriteLine("tre");
            await new HttpPostRequest<CreateClientHttpBody, CreateClientHttpResponse>(_httpClient, $"{_requestManager.InstanceServer}/Clients").PostAsync(_model);
            await ModalInstance.CloseAsync(ModalResult.Ok(""));
        }
        catch (Exception e)
        {
            Error = e.Message;
        }
    }
    
    protected override async Task OnInitializedAsync()
    {
        _model = new CreateClientHttpBody
        {
            NewId = Guid.NewGuid(),
            InstanceId = await _sessionProvider.GetCurrentInstanceId()
        };
    }
}
