@using Nano35.WebClient.Services
@using Nano35.HttpContext.instance
@using Nano35.Contracts.Instance.Models
@using System.Text.RegularExpressions
@using System.ComponentModel.DataAnnotations
@inject HttpClient _httpClient
@inject IRequestManager RequestManager
@inject IInstanceService InstanceService


<LoadingContent IsLoaded="_isLoaded">
    
    <EditForm Model="@Model" 
          OnValidSubmit="HandleValidSubmit">
        <DataAnnotationsValidator />
        
        <InputField Title="Статус клиента">
            <Controls>
                <RadzenDropDown Data=@(_state.Select(a => new {a.Id, a.Name}))
                                TextProperty="Name"
                                ValueProperty="Id"
                                TValue="Guid"
                                @bind-Value="Model.ClientStateId"
                                style="width: 100%"
                                Placeholder="Выберите статус клиента..."/>
            </Controls>
            <Validation><ValidationMessage For="@(() => Model.ClientStateId)" /></Validation>
        </InputField>
        
        <InputField Title="Тип клиента">
            <Controls>
                <RadzenDropDown Data=@(_types.Select(a => new {a.Id, a.Name}))
                                TextProperty="Name"
                                ValueProperty="Id"
                                TValue="Guid"
                                @bind-Value="Model.ClientTypeId"
                                style="width: 100%"
                                Placeholder="Выберите тип клиента..."/>
            </Controls>
            <Validation><ValidationMessage For="@(() => Model.ClientTypeId)" /></Validation>
        </InputField>
        
        <InputField Title="@(Model.ClientStateId != Guid.Empty && 
                             Model.ClientStateId == _state.First().Id ?
                               "Название организации" : 
                               "ФИО клиента")">
            <Controls><RadzenTextBox Style="width: 100%;" Placeholder="..." @bind-Value="Model.Name"/></Controls>
            <Validation><ValidationMessage For="@(() => Model.Name)" /></Validation>
        </InputField>
        
        <InputField Title="Эл почта">
            <Controls><RadzenTextBox Style="width: 100%;" @bind-Value="Model.Email"/></Controls>
            <Validation><ValidationMessage For="@(() => Model.Email)" /></Validation>
        </InputField>
        
        <InputField Title="Номер телефона">
            <Controls><RadzenTextBox Style="width: 100%;" @bind-Value="Phone" Change=@(PhoneMask) /></Controls>
            <Validation><ValidationMessage For="@(() => Phone)" /></Validation>
        </InputField>
        
        <InputField Title="Скидка">
            <Controls><RadzenNumeric Style="width: 100%;" @bind-Value="Model.Selle"/></Controls>
            <Validation><ValidationMessage For="@(() => Model.Selle)" /></Validation>
        </InputField>
        
        <RadzenButton type="submit"
                      Text="Создать"
                      ButtonStyle="ButtonStyle.Primary"
                      Style="width: 100%" />
        
        @if (!string.IsNullOrEmpty(Error))
        {
            <div class="alert alert-danger mt-3 mb-0">@Error</div>
        }
    </EditForm>
</LoadingContent>

@code
{
    [CascadingParameter] public IModalService Modal { get; set; }
    [CascadingParameter] BlazoredModalInstance ModalInstance { get; set; }
    [Parameter] public CreateClientHttpBody Model { get; set; }
    [Parameter] public EventCallback FormSubmitted { get; set; }
    [Parameter] public string Error { get; set; }

    private string Phone { get ; set ; } = "+7";

    private List<ClientTypeViewModel> _types = new();
    private List<ClientStateViewModel> _state = new();
    private bool _isLoaded;

    protected override async Task OnInitializedAsync()
    {
        _isLoaded = false;
        
        _state = new List<ClientStateViewModel>((await new HttpGetRequest<GetAllClientStatesHttpResponse>(_httpClient, $"{RequestManager.InstanceServer}/ClientsStates").GetAsync()).Data);
        _types = new List<ClientTypeViewModel>((await new HttpGetRequest<GetAllClientTypesHttpResponse>(_httpClient, $"{RequestManager.InstanceServer}/ClientsTypes").GetAsync()).Data);
        
        _isLoaded = true;
    }

    private async Task HandleValidSubmit()
    {
        Model.Phone = Phone;
        await FormSubmitted.InvokeAsync();
        await ModalInstance.CloseAsync();
    }

    private async Task PhoneMask()
    {

        Phone = Regex.Replace(Phone, @"[^\d]", "");
        
        var countryCode = "+7";
        
        if (Phone.StartsWith("7"))
            Phone = Phone.Remove(0,1);
        
        if (Phone.StartsWith("8"))
            Phone = Phone.Remove(0,1);
        
        if (Phone.Length < 10)
            Phone = Phone.PadRight(10);

        if (Phone.Length > 10)
            Phone = Phone.Substring(0, 10);

        Phone = $"{countryCode}({Phone.Substring(0, 3)}) {Phone.Substring(3, 3)}-{Phone.Substring(6, 2)}-{Phone.Substring(8, 2)}";
        
        Model.Phone = Phone;
    }
}
