@using Nano35.WebClient.Services
@using Nano35.Contexts.Http.storage
@inject HttpClient HttpClient
@inject RequestManager RequestManager
@inject ISessionProvider SessionProvider
@inject NotificationService NotificationService
@inject HealthService HealthService
@inject NavigationManager NavigationManager
@inject HttpGet GetRequest
@inject HttpPatch PatchRequest


<LoadingContent IsLoaded="_isLoaded">
    <FieldList Title="Информация">
        <FieldListItem Title="Категория">
            <EditableField OnCancel="@(() => CategoryEdit = null)"
                           OnEdit="@(() => CategoryEdit = new UpdateArticleCategoryHttpBody(){Id = Article.Id})"
                           OnSave="@(() => UpdateCategory())">
                <View><p>@Article.Category</p></View>
                <Edit>
                    <RadzenDropDown style="display: flex;"
                                    AllowClear="true"
                                    TValue="Guid"
                                    Data=@(Categories.Select(g => new {g.Id, g.Name}))
                                    TextProperty="Name"
                                    ValueProperty="Id"
                                    @bind-Value="CategoryEdit.CategoryId">
                        <Template Context="data">
                            <div style="display: flex; flex-direction: row">
                                <div style="width: 90%;">@(data.Name)</div>
                                <RadzenButton 
                                    Click="@(_ => OpenCategoryDetails(data.Id, data.Name))"
                                    Size="ButtonSize.Small"
                                    Text="🖉"
                                    Style="height: 20px; display: flex; padding-left: revert; padding-right: revert; align-items: center;"/>
                            </div>
                        </Template>
                    </RadzenDropDown>
                </Edit>
            </EditableField>
        </FieldListItem>
        
        <FieldListItem Title="Бренд">
            <EditableField OnCancel="@(() => BrandEdit = null)"
                           OnEdit="@(() => BrandEdit = new UpdateArticleBrandHttpBody() {Id = Article.Id})"
                           OnSave="@(() => UpdateBrand())">
                <View><p>@Article.Brand</p></View>
                <Edit><RadzenTextBox style="display: flex;align-items: center" @bind-Value="BrandEdit.Brand" Placeholder="@Article.Brand"/></Edit>
            </EditableField>
        </FieldListItem>
        
        <FieldListItem Title="Модель">
            <EditableField OnCancel="@(() => ModelEdit = null)"
                           OnEdit="@(() => ModelEdit = new UpdateArticleModelHttpBody(){Id = Article.Id})"
                           OnSave="@(() => UpdateModel())">
                <View><p>@Article.Model</p></View>
                <Edit><RadzenTextBox style="display: flex;align-items: center" @bind-Value="ModelEdit.Model" Placeholder="@Article.Model"/></Edit>
            </EditableField>
        </FieldListItem>
        
        <FieldListItem Title="Информация">
            <EditableField OnCancel="@(() => InfoEdit = null)"
                           OnEdit="@(() => InfoEdit = new UpdateArticleInfoHttpBody(){Id = Article.Id})"
                           OnSave="@(() => UpdateInfo())">
                <View><p>@Article.Info</p></View>
                <Edit><RadzenTextBox style="display: flex;align-items: center" @bind-Value="InfoEdit.Info" Placeholder="@Article.Info"/></Edit>
            </EditableField>
        </FieldListItem>
        
    </FieldList>
        
    <RadzenFieldset Text="Характеристики" Style="width: 60rem">
        <RadzenGrid Data="@(Article.Specs)" EmptyText="Нет указаных характеристик" TItem="SpecHttpContext">
            <Columns>
                <RadzenGridColumn TItem="SpecHttpContext" Property="Key" Title="Характеристика"/>
                <RadzenGridColumn TItem="SpecHttpContext" Property="Value" Title="Значение"/>
            </Columns>
        </RadzenGrid>
    </RadzenFieldset>
</LoadingContent>

@code
{
    [CascadingParameter] public IModalService Modal { get; set; }
    [CascadingParameter] BlazoredModalInstance ModalInstance { get; set; }
    [Parameter] public Guid Id { get; set; }
    
    private ArticleViewModel Article { get; set; } = new ();
    private List<ArticleCategoryViewModel> Categories { get; set; }
    private UpdateArticleInfoHttpBody InfoEdit { get; set; }
    private UpdateArticleModelHttpBody ModelEdit { get; set; }
    private UpdateArticleCategoryHttpBody CategoryEdit { get; set; }
    private UpdateArticleBrandHttpBody BrandEdit { get; set; }
    private bool _isLoaded;

    protected override async Task OnInitializedAsync()
    {
        _isLoaded = false;
        await LoadData();
        _isLoaded = true;
    }

    private async Task LoadData()
    {
        await GetRequest.InvokeAsync<GetArticleByIdSuccessHttpResponse>($"Articles/{Id}",
            resp =>
            {
                if (resp.IsSuccess())
                {
                    Article = resp.Success.Data;
                }
                else
                {
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
        await GetRequest.InvokeAsync<GetAllArticleCategoriesSuccessHttpResponse>(
            $"ArticleCategories?I{await SessionProvider.GetCurrentInstanceId()}&ParentId={Guid.Parse("F50EBC56-3D91-481C-8F61-16E47555B136")}",
            resp =>
            {
                if (resp.IsSuccess())
                {
                    Categories = resp.Success.Data;
                }
                else
                {
                    NavigationManager.NavigateTo("/instance-view");
                }
            });

        StateHasChanged();
    }
    

    private async Task UpdateCategory()
    {
        await PatchRequest.InvokeAsync<UpdateArticleCategorySuccessHttpResponse, UpdateArticleCategoryHttpBody>(
            $"Articles/Category", CategoryEdit,
            resp =>
            {
                if (resp.IsSuccess())
                {
                    
                }
                else
                {
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
        CategoryEdit = null;
        await LoadData();
    }

    private async Task UpdateBrand()
    {
        await PatchRequest.InvokeAsync<UpdateArticleBrandSuccessHttpResponse, UpdateArticleBrandHttpBody>(
            $"Articles/Brand", BrandEdit,
            resp =>
            {
                if (resp.IsSuccess())
                {
                    
                }
                else
                {
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
        BrandEdit = null;
        await LoadData();
    }

    private async Task UpdateModel()
    {
        await PatchRequest.InvokeAsync<UpdateArticleModelSuccessHttpResponse, UpdateArticleModelHttpBody>(
            $"Articles/Model", ModelEdit,
            resp =>
            {
                if (resp.IsSuccess())
                {
                    
                }
                else
                {
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
        ModelEdit = null;
        await LoadData();
    }

    private async Task UpdateInfo()
    {
        await PatchRequest.InvokeAsync<UpdateArticleInfoSuccessHttpResponse, UpdateArticleInfoHttpBody>(
            $"Articles/Info", InfoEdit,
            resp =>
            {
                if (resp.IsSuccess())
                {
                    
                }
                else
                {
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
        InfoEdit = null;
        await LoadData();
    }
    
    private async Task OpenCategoryDetails(Guid id, string name)
    {
        var item = Categories.First(g => g.Id == id);
        Console.WriteLine(item.Id);
        Console.WriteLine(item.Name);
        var parameters = new ModalParameters();
        parameters.Add(nameof(CategoryDetails.Category), item);
        var modal = Modal.Show<CategoryDetails>($"{name}", parameters);
        await modal.Result;
    }
}
