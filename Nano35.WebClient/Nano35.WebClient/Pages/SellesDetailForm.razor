@using Nano35.WebClient.Services
@using Nano35.HttpContext.storage
@inject HttpClient HttpClient
@inject IRequestManager RequestManager
@inject ISessionProvider SessionProvider
@inject NotificationService NotificationService

<EditForm Model="@(_model)"
          OnValidSubmit="HandleValidSubmit">
    @if (_isLoaded)
    {
        <DataAnnotationsValidator/>
        
        <InputField Title="Товар">
            <Controls>
                <RadzenDropDown Data=@(StorageItems
                                         .Select(a => 
                                             new {Id = a.Id, 
                                                 Name = $"{a.Article + " " + a.Condition}"}))
                                TextProperty="Name"
                                ValueProperty="Id"
                                TValue="Guid"
                                @bind-Value="_model.StorageItemId"
                                Style="width: 100%;"
                                Placeholder="..."
                                FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                FilterOperator="StringFilterOperator.Contains"
                                AllowFiltering="true"
                                Change="@GetAllPlacesOfStorageItem"/>

            </Controls>
            <Validation>
                <ValidationMessage For="@(() => _model.StorageItemId)" />
            </Validation>
        </InputField>
        
        <InputField Title="Ячейка на складе">
            <Controls>
                <RadzenDropDown Data=@(Warehouse
                                         .Select(a => 
                                             new {Name = a.Name}))
                                TextProperty="Name"
                                ValueProperty="Name"
                                TValue="string"
                                @bind-Value="_model.PlaceOnStorage"
                                Style="width: 100%;"
                                Placeholder="..."
                                FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                FilterOperator="StringFilterOperator.Contains"
                                AllowFiltering="true"
                                Change="PlaceOnStorageChanged"/>
            </Controls>
            <Validation>
                <ValidationMessage For="@(() => _model.PlaceOnStorage)" />
            </Validation>
        </InputField>
        
        <InputField Title="Количество">
            <Controls>
                <RadzenNumeric Style="width: 100%;" 
                               Placeholder="@(_maxItems.ToString())"
                               @bind-Value="_model.Count"
                               Max="@_maxItems"
                               Min="1"/>
            </Controls>
            <Validation>
                <ValidationMessage For="@(() => _model.Count)" />
            </Validation>
        </InputField>
        
        <InputField Title="Цена">
            <Controls>
                <RadzenNumeric style="width: 100%;"
                               Placeholder="..."
                               TValue="double"
                               @bind-Value="_model.Price"/>
            </Controls>
            <Validation>
                <ValidationMessage For="@(() => _model.Price)" />
            </Validation>
        </InputField>

        <RadzenButton type="submit"
                      Text="Создать"
                      ButtonStyle="ButtonStyle.Primary"
                      Style="width: 100%" />
    }
</EditForm>

@code
{
    [CascadingParameter] public IModalService Modal { get; set; }
    [CascadingParameter] BlazoredModalInstance ModalInstance { get; set; }
    
    private CreateSelleDetailViewModel _model = new CreateSelleDetailViewModel(){NewId = Guid.NewGuid(), Count = 1,};
    private List<StorageItemViewModel> StorageItems { get; set; } = new();
    private List<PlaceWithStorageItemOnUnit> Warehouse { get; set; } = new();
    private bool _isLoaded;
    private int _maxItems;

    protected override async Task OnInitializedAsync()
    {
        StorageItems = await GetAllStorageItems();
        _isLoaded = true;
    }

    private async Task GetAllPlacesOfStorageItem()
    {
        Warehouse =  (await new HttpGetRequest<GetAllPlacesOfStorageItemOnUnitSuccessHttpResponse>(HttpClient, NotificationService,
            $"{RequestManager.StorageServer}/Warehouse/PlacesOfStorageItemOnUnit?StorageItemId={_model.StorageItemId}&UnitContainsStorageItemId={await SessionProvider.GetCurrentUnitId()}").GetAsync()).Contains.ToList();
        
        _model.Price = Decimal.ToDouble(StorageItems.FirstOrDefault(a=> a.Id == _model.StorageItemId).RetailPrice);
    }
    
    private async Task HandleValidSubmit() 
    {
        await ModalInstance.CloseAsync(ModalResult.Ok(_model));
    }
    
    private async Task<List<StorageItemViewModel>> GetAllStorageItems() => 
        (await new HttpGetRequest<GetAllStorageItemsSuccessHttpResponse>(HttpClient, NotificationService,
            $"{RequestManager.StorageServer}/StorageItems?InstanceId={await SessionProvider.GetCurrentInstanceId()}").GetAsync()).Data.ToList();


    private async Task PlaceOnStorageChanged()
    {
        _maxItems = Warehouse.FirstOrDefault(a=> a.Name == _model.PlaceOnStorage).Count;
    }
}
