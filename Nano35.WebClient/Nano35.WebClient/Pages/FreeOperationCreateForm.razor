@using Nano35.WebClient.Services
@using Nano35.Contracts.Instance.Models
@using Nano35.Contexts.Http.storage
@using Nano35.Contexts.Http.Instance
@using Nano35.Contexts.Http.Cashbox
@using Nano35.Contracts.Cashbox.Models
@inject HttpClient HttpClient
@inject RequestManager RequestManager
@inject ISessionProvider SessionProvider
@inject NotificationService NotificationService
@inject HealthService HealthService
@inject NavigationManager NavigationManager
@inject HttpGet GetRequest
@inject HttpPost PostRequest

<div style="width: 40rem;">
        <LoadingContent IsLoaded="_isLoaded">
            <EditForm Model="@Model" OnValidSubmit="@(_ => HandleValidSubmit())">
                <DataAnnotationsValidator />
                <InputField Title="Примечание прочего прихода">
                    <Controls><RadzenTextBox Style="width: 100%;" @bind-Value="Model.Description"/></Controls>
                    <Validation><ValidationMessage For="@(() => Model.Description)" /></Validation>
                </InputField>
                <InputField Title="Сумма прочего прихода">
                    <Controls><RadzenNumeric Style="width: 100%;" @bind-Value="Model.Cash"/> </Controls>
                    <Validation><ValidationMessage For="@(() => Model.Cash)" /></Validation>
                </InputField>
                <InputField>
                    <Controls> <RadzenDropDown Style="width: 100%;" 
                                               @bind-Value="Model.Type"
                                               AllowClear="true"
                                               TextProperty="Text"
                                               ValueProperty="Value"
                                               Placeholder="..."
                                               Data="@(Enum.GetValues(typeof(FreeOperationType)).Cast<FreeOperationType>().Select(t => new { Text = t, Value = t }))"                 /> 
                        </Controls>
                <Validation><ValidationMessage For="@(() => Model.Type)" /></Validation>
                </InputField>
                <RadzenButton type="submit" Text="Провести" ButtonStyle="ButtonStyle.Primary" Style="width: 100%" />
            </EditForm>
    </LoadingContent>
</div>



@code
{
    [CascadingParameter] public IModalService Modal { get; set; }
    [CascadingParameter] BlazoredModalInstance ModalInstance { get; set; }
    private CreateFreeOperationHttpBody Model { get; set; } = new();
    private string Error { get; set; }
    private enum FreeOperationType
    {
        Приход = 0,
        Уход = 1
    }

    private bool _isLoaded;
    private int Count;
    
    protected override async Task OnInitializedAsync()
    {
        _isLoaded = false;
        Model.NewId = Guid.NewGuid();
        Model.Type = Contracts.Cashbox.Models.FreeOperationType.Input;
        _isLoaded = true;
    }
    
    private async Task HandleValidSubmit()
    {
        try
        {
            Model.CashboxId = await SessionProvider.GetCurrentUnitId();
            await PostRequest.InvokeAsync<CreateFreeOperationHttpResponse, CreateFreeOperationHttpBody>(
                $"cashbox/Cashbox/FreeCashOperation", Model,
                resp =>
                {
                    if (resp.IsSuccess()) { }
                    else
                    {
                        Console.WriteLine(resp.Error);
                        NavigationManager.NavigateTo("/instance-view");
                    }
                });

            await ModalInstance.CloseAsync(ModalResult.Ok(""));
        }
        catch (Exception e)
        {
            Error = e.Message;
        }
    }

}
