@using Nano35.WebClient.Services
@using Nano35.HttpContext.storage
@inject HttpClient HttpClient
@inject IRequestManager RequestManager
@inject ISessionProvider SessionProvider
@inject IAuthService AuthService

<BoxedContent Width="40">
    <ArticlesForm FormSubmitted="Submit" Model="@_model" Error="@Error" IsExpandedView="@IsExpandedView"/>
</BoxedContent>

@code
{
    [CascadingParameter] public IModalService Modal { get; set; }
    [CascadingParameter] BlazoredModalInstance ModalInstance { get; set; }
    [Parameter] public bool IsExpandedView { get; set; } = true;
    private CreateArticleHttpBody _model = new();
    private string Error { get; set; } = "";
    
    private async Task Submit()
    {
        try
        {
            await new HttpPostRequest<CreateArticleHttpBody,CreateArticleSuccessHttpResponse>(HttpClient, $"{RequestManager.StorageServer}/Articles").PostAsync(_model);
            await ModalInstance.CloseAsync(ModalResult.Ok(_model.NewId));
        }
        catch (Exception e)
        {
            Error = e.Message;
        }
    }
    
    protected override async Task OnInitializedAsync()
    {
        _model = new CreateArticleHttpBody
        {
            NewId = Guid.NewGuid(),
            InstanceId = await SessionProvider.GetCurrentInstanceId(),
            Specs = new List<SpecHttpContext>()
        };
    }
}