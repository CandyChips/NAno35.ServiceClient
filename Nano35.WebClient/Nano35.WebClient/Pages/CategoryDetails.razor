@using Nano35.WebClient.Services
@using Nano35.Contexts.Http.storage
@inject HttpClient HttpClient
@inject RequestManager RequestManager
@inject ISessionProvider SessionProvider
@inject NotificationService NotificationService
@inject NavigationManager NavigationManager
@inject HttpGet GetRequest
@inject HttpPatch PatchRequest

<LoadingContent IsLoaded="_loading">
        <FieldListItem Title="Наследуемая категория">
            <EditableField OnCancel="@(() => ParentEdit = null)"
                           OnEdit="@(() => ParentEdit = new UpdateCategoryParentCategoryHttpBody() {Id = Category.Id})"
                           OnSave="@(() => UpdateParent())">
                <View>
                    <p>@(Categories.FirstOrDefault(f=> f.Id == Category.ParentCategoryId)?.Name)</p></View>
                <Edit>
                    <RadzenDropDown style="display: flex; "
                                    AllowClear="true"
                                    TValue="Guid"
                                    Data=@(Categories.Select(g => new {Id = g.Id, Name = g.Name}))
                                    TextProperty="Name"
                                    ValueProperty="Id"
                                    @bind-Value="ParentEdit.ParentCategoryId">
                    </RadzenDropDown>
                </Edit>
            </EditableField>
        </FieldListItem>
        
        <FieldListItem Title="Бренд">
                    <EditableField OnCancel="@(() => NameEdit = null)"
                                   OnEdit="@(() => NameEdit = new UpdateCategoryNameHttpBody() {Id = Category.Id})"
                                   OnSave="@(() => UpdateName())">
                        <View>
                            <p>@Category.Name</p></View>
                        <Edit>
                            <RadzenTextBox style="display: flex;align-items: center"
                                           @bind-Value="NameEdit.Name"
                                           Placeholder="@Category.Name"/>
                        </Edit>
        	</EditableField>
        </FieldListItem>
</LoadingContent>

@code
{
    [CascadingParameter] public IModalService Modal { get; set; }
    [CascadingParameter] BlazoredModalInstance ModalInstance { get; set; }
    
    [Parameter]public ArticleCategoryViewModel Category { get; set; } = new();
    private List<ArticleCategoryViewModel> Categories { get; set; } = new();
    
    private UpdateCategoryNameHttpBody NameEdit { get; set; }
    private UpdateCategoryParentCategoryHttpBody ParentEdit { get; set; }
    
    private bool _loading = true;

    
    protected override async Task OnInitializedAsync()
    {
        _loading = true;
        Categories = await GetCategories();
        _loading = false;
    }

    private async Task<List<ArticleCategoryViewModel>> GetCategories()
    {
        var data = new List<ArticleCategoryViewModel>();
        await GetRequest.InvokeAsync<GetAllArticleCategoriesSuccessHttpResponse>($"ArticleCategories?InstanceId={await SessionProvider.GetCurrentInstanceId()}",
            resp =>
            {
                if (resp.IsSuccess()) {data = resp.Success.Data;}
                else
                {
                    Console.WriteLine(resp.Error);
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
        
        return data;
    }
    

    private async Task UpdateName()
    {
        _loading = true;
        await PatchRequest.InvokeAsync<UpdateCategoryNameSuccessHttpResponse, UpdateCategoryNameHttpBody>($"Category/Name", NameEdit,
            resp =>
            {
                if (resp.IsSuccess()) {}
                else
                {
                    Console.WriteLine(resp.Error);
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
        NameEdit = null;
        Categories = await GetCategories(); 
        StateHasChanged();
        _loading = false;
    }
    
    private async Task UpdateParent()
    {
        _loading = true;
        await PatchRequest.InvokeAsync<UpdateCategoryParentCategoryIdSuccessHttpResponse, UpdateCategoryParentCategoryHttpBody>($"Category/ParentCategoryId", ParentEdit,
            resp =>
            {
                if (resp.IsSuccess()) {}
                else
                {
                    Console.WriteLine(resp.Error);
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
        ParentEdit = null;
        Categories = await GetCategories();
        StateHasChanged();
        _loading = false;
    }
}
