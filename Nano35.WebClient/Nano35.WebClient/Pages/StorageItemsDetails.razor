@using Nano35.WebClient.Services
@using System.Globalization
@using Nano35.Contexts.Http.storage
@inject HttpClient HttpClient
@inject RequestManager RequestManager
@inject ISessionProvider SessionProvider
@inject NotificationService NotificationService
@inject HealthService HealthService
@inject NavigationManager NavigationManager
@inject HttpGet GetRequest
@inject HttpPatch PatchRequest

<LoadingContent IsLoaded="_isLoaded">
        <FieldList Title="Информация">
            <FieldListItem Title="Артикул">
                <EditableField OnCancel="@(() => ArticleEdit = null)"
                               OnEdit="@(() => ArticleEdit = new UpdateStorageItemArticleHttpBody(){Id = StorageItem.Id})"
                               OnSave="@(async () => await UpdateArticle())">
                    <View>@StorageItem.Article</View>
                    <Edit>
                        <RadzenDropDown AllowClear="true"
                                        TValue="Guid"
                                        Data=@(Articles.Select(g => new {g.Id, Name = $"{g.Brand} {g.Model}"}))
                                        TextProperty="Name"
                                        ValueProperty="Id"
                                        @bind-Value="ArticleEdit.ArticleId">
                            <Template Context="data">
                                <div style="display: flex; flex-direction: row">
                                    <div style="width: 90%;">@(data.Name)</div>
                                    <RadzenButton
                                        Click="@(_ => OpenArticleDetails(data.Id, data.Name))"
                                        Size="ButtonSize.Small"
                                        Text="🖉"
                                        Style="height: 20px;
                                           display: flex;
                                           padding-left: revert;
                                           padding-right: revert;
                                           align-items: center;"/>
                                </div>
                            </Template>
                        </RadzenDropDown>
                    </Edit>
                </EditableField>
            </FieldListItem>
            
            <FieldListItem Title="Закупочная цена">
                <EditableField OnCancel="@(() => PurchasePriceEdit = null)"
                               OnEdit="@(() => PurchasePriceEdit = new UpdateStorageItemPurchasePriceHttpBody(){Id = StorageItem.Id, PurchasePrice = StorageItem.PurchasePrice})"
                               OnSave="@(async () => await UpdatePurchasePrice())">
                    <View>@StorageItem.PurchasePrice.ToString(CultureInfo.InvariantCulture)</View>
                    <Edit>
                        <RadzenNumeric style="display: flex; "
                                       @bind-Value="PurchasePriceEdit.PurchasePrice"
                                       ShowUpDown="false"
                                       Placeholder="@StorageItem.PurchasePrice.ToString(CultureInfo.InvariantCulture)"
                                       Min="0"/>
                    </Edit>
                </EditableField>
            </FieldListItem>
            
            <FieldListItem Title="Цена продажи">
                <EditableField OnCancel="@(() => RetailPriceEdit = null)"
                               OnEdit="@(() => RetailPriceEdit = new UpdateStorageItemRetailPriceHttpBody(){Id = StorageItem.Id, RetailPrice = StorageItem.RetailPrice})"
                               OnSave="@(async () => await UpdateRetailPrice())">
                    <View>@StorageItem.RetailPrice</View>
                    <Edit>
                        <RadzenNumeric style="display: flex; align-items: center"
                                       @bind-Value="RetailPriceEdit.RetailPrice"
                                       ShowUpDown="false"
                                       Placeholder="@StorageItem.RetailPrice.ToString(CultureInfo.InvariantCulture)"
                                       Min="0"/>
                    </Edit>
                </EditableField>
            </FieldListItem>
            
            <FieldListItem Title="Состояние">
                <EditableField OnCancel="@(() => ConditionEdit = null)"
                               OnEdit="@(() => ConditionEdit = new UpdateStorageItemConditionHttpBody(){Id = StorageItem.Id})"
                               OnSave="@(async () => await UpdateCondition())">
                    <View>@StorageItem.Condition</View>
                    <Edit>
                        <RadzenDropDown style="display: flex; "
                                        AllowClear="true"
                                        TValue="Guid"
                                        Data=@(Conditions.Select(g => new {g.Id, g.Name}))
                                        TextProperty="Name"
                                        ValueProperty="Id"
                                        @bind-Value="ConditionEdit.ConditionId"/>
                    </Edit>
                </EditableField>
            </FieldListItem>
            
            <FieldListItem Title="Комментарий">
                <EditableField OnCancel="@(() => CommentEdit = null)"
                               OnEdit="@(() => CommentEdit = new UpdateStorageItemCommentHttpBody(){Id = StorageItem.Id})"
                               OnSave="@(async () => await UpdateComment())">
                    <View>@StorageItem.Comment</View>
                    <Edit>
                        <RadzenTextBox style="display: flex;align-items: center"
                                       @bind-Value="CommentEdit.Comment"
                                       Placeholder="@StorageItem.Comment"/>
                    </Edit>
                </EditableField>
            </FieldListItem>
            
            <FieldListItem Title="Скрытый комментарий">
                <EditableField OnCancel="@(() => HiddenCommentEdit = null)"
                               OnEdit="@(() => HiddenCommentEdit = new UpdateStorageItemHiddenCommentHttpBody(){Id = StorageItem.Id})"
                               OnSave="@(async () => await UpdateHiddenComment())">
                    <View>@StorageItem.HiddenComment</View>
                    <Edit>
                        <RadzenTextBox style="display: flex;align-items: center"
                                       @bind-Value="HiddenCommentEdit.HiddenComment"
                                       Placeholder="@StorageItem.HiddenComment"/>
                    </Edit>
                </EditableField>
            </FieldListItem>
        </FieldList>

        <RadzenFieldset Text="Товары в наличии"
                    Style="width: 60rem">
        <RadzenGrid Data="@(Places)"
                    EmptyText="Нет занятых мест в текущем подразделении..."
                    TItem="PlaceWithStorageItemOnUnit">
            <Columns>
                <RadzenGridColumn TItem="PlaceWithStorageItemOnUnit"
                                  Property="Name"
                                  Title="Место на складе"/>
                <RadzenGridColumn TItem="PlaceWithStorageItemOnUnit"
                                  Property="Count"
                                  Title="Количество"/>
            </Columns>
        </RadzenGrid>
    </RadzenFieldset>
</LoadingContent>

@code
{
    [CascadingParameter] public IModalService Modal { get; set; }
    [CascadingParameter] BlazoredModalInstance ModalInstance { get; set; }

    [Parameter] public StorageItemOnUnitViewModel Item { get; set; }
    
    private StorageItemViewModel StorageItem { get; set; } = new ();
    private List<PlaceWithStorageItemOnUnit> Places { get; set; } = new();

    private UpdateStorageItemArticleHttpBody ArticleEdit { get; set; }
    private List<ArticleViewModel> Articles { get; set; } = new();
    
    private UpdateStorageItemPurchasePriceHttpBody PurchasePriceEdit { get; set; }
    
    private UpdateStorageItemRetailPriceHttpBody RetailPriceEdit { get; set; }
    
    private UpdateStorageItemConditionHttpBody ConditionEdit { get; set; }
    private List<StorageItemConditionViewModel> Conditions { get; set; } = new();
    
    private UpdateStorageItemCommentHttpBody CommentEdit { get; set; }
    
    private UpdateStorageItemHiddenCommentHttpBody HiddenCommentEdit { get; set; }
    
    private bool _isLoaded;

    
    protected override async Task OnInitializedAsync()
    {
        _isLoaded = false;
        await LoadData();
        _isLoaded = true;
    }

    private async Task LoadData()
    {
        await GetRequest.InvokeAsync<GetStorageItemByIdSuccessHttpResponse>($"StorageItems/{Item.Item.Id}",
            resp =>
            {
                if (resp.IsSuccess()) {StorageItem = resp.Success.Data;}
                else
                {
                    Console.WriteLine(resp.Error);
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
        await GetRequest.InvokeAsync<GetAllPlacesOfStorageItemOnUnitSuccessHttpResponse>($"Warehouse/PlacesOfStorageItemOnUnit?StorageItemId={Item.Item.Id}&UnitContainsStorageItemId={await SessionProvider.GetCurrentUnitId()}",
            resp =>
            {
                if (resp.IsSuccess()) {Places = resp.Success.Contains;}
                else
                {
                    Console.WriteLine(resp.Error);
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
        await GetRequest.InvokeAsync<GetAllStorageItemConditionsSuccessHttpResponse>($"StorageItemConditions",
            resp =>
            {
                if (resp.IsSuccess()) {Conditions = resp.Success.Data;}
                else
                {
                    Console.WriteLine(resp.Error);
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
        await GetRequest.InvokeAsync<GetAllArticlesSuccessHttpResponse>($"Articles?InstanceId={await SessionProvider.GetCurrentInstanceId()}",
            resp =>
            {
                if (resp.IsSuccess()) {Articles = resp.Success.Data;}
                else
                {
                    Console.WriteLine(resp.Error);
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
        StateHasChanged();
    }
    
    private async Task UpdateArticle()
    {
        await PatchRequest.InvokeAsync<UpdateStorageItemArticleSuccessHttpResponse, UpdateStorageItemArticleHttpBody>($"StorageItems/Article", ArticleEdit,
            resp =>
            {
                if (resp.IsSuccess()) {}
                else
                {
                    Console.WriteLine(resp.Error);
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
        ArticleEdit = null;
        await LoadData();
    }

    private async Task UpdatePurchasePrice()
    {
        await PatchRequest.InvokeAsync<UpdateStorageItemPurchasePriceSuccessHttpResponse, UpdateStorageItemPurchasePriceHttpBody>($"StorageItems/PurchasePrice", PurchasePriceEdit,
            resp =>
            {
                if (resp.IsSuccess()) {}
                else
                {
                    Console.WriteLine(resp.Error);
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
        PurchasePriceEdit = null;
        await LoadData();
    }

    private async Task UpdateRetailPrice() 
    {
        await PatchRequest.InvokeAsync<UpdateStorageItemRetailPriceSuccessHttpResponse, UpdateStorageItemRetailPriceHttpBody>($"StorageItems/RetailPrice", RetailPriceEdit,
            resp =>
            {
                if (resp.IsSuccess()) {}
                else
                {
                    Console.WriteLine(resp.Error);
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
        RetailPriceEdit = null;
        await LoadData();
    }
    
    private async Task UpdateCondition() 
    {
        await PatchRequest.InvokeAsync<UpdateStorageItemConditionSuccessHttpResponse, UpdateStorageItemConditionHttpBody>($"StorageItems/Condition", ConditionEdit,
            resp =>
            {
                if (resp.IsSuccess()) {}
                else
                {
                    Console.WriteLine(resp.Error);
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
        ConditionEdit = null;
        await LoadData();
    }    
    private async Task UpdateComment()
    {
        await PatchRequest.InvokeAsync<UpdateStorageItemCommentSuccessHttpResponse, UpdateStorageItemCommentHttpBody>($"StorageItems/Comment", CommentEdit,
            resp =>
            {
                if (resp.IsSuccess()) {}
                else
                {
                    Console.WriteLine(resp.Error);
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
        CommentEdit = null;
        await LoadData();
    }
    
    private async Task UpdateHiddenComment()
    {
        await PatchRequest.InvokeAsync<UpdateStorageItemHiddenCommentSuccessHttpResponse, UpdateStorageItemHiddenCommentHttpBody>($"StorageItems/HiddenComment", HiddenCommentEdit,
            resp =>
            {
                if (resp.IsSuccess()) {}
                else
                {
                    Console.WriteLine(resp.Error);
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
        HiddenCommentEdit = null;
        await LoadData();
    }

    private async Task OpenArticleDetails(Guid id, string name)
    {
        var parameters = new ModalParameters();
        parameters.Add(nameof(ArticleDetails.Id), id);
        var modal = Modal.Show<ArticleDetails>($"{name}", parameters);
        await modal.Result;
    }
}
