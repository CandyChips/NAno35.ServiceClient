@using Nano35.WebClient.Services
@using Nano35.HttpContext.storage
@inject HttpClient HttpClient
@inject IRequestManager RequestManager
@inject ISessionProvider SessionProvider
@inject NotificationService NotificationService
@inject HttpGet GetRequest
@inject NavigationManager NavigationManager

<LoadingContent IsLoaded="_isLoaded">
    <EditForm Model="@_model" OnValidSubmit="HandleValidSubmit">
        <DataAnnotationsValidator/>
        <InputField Title="Товар">
            <Controls>
                <div style="display: flex; width: 100%">
                    <RadzenDropDown Data=@(_storageItems.Select(a => new {Id = a.Id, Name = $"{a.Article + " " + a.Condition}"}))
                                    TextProperty="Name"
                                    ValueProperty="Id"
                                    TValue="Guid"
                                    @bind-Value="_model.StorageItemId"
                                    Style="width: 100%;"
                                    FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                    FilterOperator="StringFilterOperator.Contains"
                                    AllowFiltering="true"
                                    Change="StorageItemSelected"/>
                    <RadzenButton Click=@(_ => OpenCreateStorageItem()) Text="Добавить" ButtonStyle="ButtonStyle.Secondary"/>
                </div>
            </Controls>
            <Validation><ValidationMessage For="@(() => _model.StorageItemId)" /></Validation>
        </InputField>
        
        <InputField Title="Ячейка на складе">
            <Controls><SelectComingDetailPlaceOnStorage @bind-PlaceOnStorage="_model.PlaceOnStorage"/></Controls>
            <Validation><ValidationMessage For="@(() => _model.PlaceOnStorage)" /></Validation>
        </InputField>
        
        <InputField Title="Количество">
            <Controls><RadzenNumeric style="width: 100%;" @bind-Value="_model.Count"/></Controls>
            <Validation><ValidationMessage For="@(() => _model.Count)" /></Validation>
        </InputField>
        
        <InputField Title="Цена за еденицу">
            <Controls><RadzenNumeric style="width: 100%;" @bind-Value="_model.Price"/></Controls>
            <Validation><ValidationMessage For="@(() => _model.Price)" /></Validation>
        </InputField>

        <RadzenButton type="submit" Text="Создать" ButtonStyle="ButtonStyle.Primary" Style="width: 100%" />
    </EditForm>
</LoadingContent>

@code
{
    [CascadingParameter] public IModalService Modal { get; set; }
    [CascadingParameter] BlazoredModalInstance ModalInstance { get; set; }
    private CreateComingDetailViewModel _model = new();
    private List<StorageItemViewModel> _storageItems = new();
    private List<PlaceWithStorageItemOnInstance> _places = new();
    private bool _isLoaded;

    protected override async Task OnInitializedAsync()
    {
        _model = new CreateComingDetailViewModel()
        {
            NewId = Guid.NewGuid(),
            Count = 1
        };
        _storageItems = await GetAllStorageItems();
        _isLoaded = true;
    }

    private async Task HandleValidSubmit()
    {
        await ModalInstance.CloseAsync(ModalResult.Ok(_model));
    }

    private async Task OpenCreateStorageItem()
    {
        var modalOpts = new ModalOptions(){DisableBackgroundCancel = true, FocusFirstElement = true};
        var moviesModal = Modal.Show<StorageItemsCreateForm>("Новая позиция к списанию", modalOpts);
        var res = await moviesModal.Result;
        if (!res.Cancelled)
        {
            _model.StorageItemId = (Guid) res.Data;
        }
        _isLoaded = false;
        await GetAllStorageItems();
        _isLoaded = true;
    }
    
    private async Task<List<StorageItemViewModel>> GetAllStorageItems()
    {
        var data = new List<StorageItemViewModel>();
        await GetRequest.InvokeAsync<GetAllStorageItemsSuccessHttpResponse>(
            RequestManager.StorageServer, $"StorageItems",
            resp =>
            {
                if (resp.IsSuccess()) {data = resp.Success.Data;}
                else
                {
                    Console.WriteLine(resp.Error);
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
        
        return data;
    }

    private async Task StorageItemSelected()
    {
        await GetRequest.InvokeAsync<GetAllPlacesOfStorageItemOnInstanceSuccessHttpResponse>(
            RequestManager.StorageServer, $"Warehouse/PlacesOfStorageItemOnInstance",
            resp =>
            {
                if (resp.IsSuccess()) {_places = resp.Success.Contains.ToList();}
                else
                {
                    Console.WriteLine(resp.Error);
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
    }
    
}
