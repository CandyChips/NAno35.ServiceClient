@using Nano35.WebClient.Services
@using Nano35.HttpContext.storage
@inject HttpClient HttpClient
@inject IRequestManager RequestManager
@inject ISessionProvider SessionProvider

<EditForm Model="@_model" OnValidSubmit="HandleValidSubmit">
    @if (_isLoaded)
    {
        <DataAnnotationsValidator/>
        
        <InputField Title="Товар">
            <Controls>
                <RadzenDropDown Data=@(StorageItems.Select(a => new {Id = a.Id, Name = $"{a.Article + " " + a.Condition}"}))
                                TextProperty="Name"
                                ValueProperty="Id"
                                TValue="Guid"
                                style="flex: auto;"
                                AllowClear="true"
                                Placeholder="..."
                                FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                FilterOperator="StringFilterOperator.Contains"
                                AllowFiltering="true"/>
                <RadzenButton Click=@(args => { _isNewStorageItemDisplay = true; })
                              Text="Добавить"
                              ButtonStyle="ButtonStyle.Secondary"
                              Style="width: 150px"/>
                <Modal Title="Новый товар" 
                       IsDisplay="@_isNewStorageItemDisplay">
                    <Form>
                        <CreateStorageItem />  
                    </Form>
                </Modal>
            </Controls>
        </InputField>
        
        <InputField Title="Ячейка на складе">
            <Controls>
                <SelectComingDetailPlaceOnStorage 
                    @bind-PlaceOnStorage="_model.PlaceOnStorage"/>
            </Controls>
        </InputField>
        
        <InputField Title="Количество">
            <Controls>
                <RadzenNumeric style="width: 100%;" 
                               Placeholder="..."
                               @bind-Value="_model.Count"/>
            </Controls>
        </InputField>
        
        <InputField Title="Цена за еденицу">
            <Controls>
                <RadzenNumeric style="width: 100%;" 
                               Placeholder="..."
                               @bind-Value="_model.Price"/>
            </Controls>
        </InputField>

        <RadzenButton type="submit"
                      Text="Создать"
                      ButtonStyle="ButtonStyle.Primary"
                      Style="width: 100%" />
    }
</EditForm>

@code
{
    [Parameter] public EventCallback<CreateComingDetailViewModel> OnAddNewComingDetail { get; set; }
        
    private CreateComingDetailViewModel _model = new CreateComingDetailViewModel();
    private List<StorageItemViewModel> StorageItems { get; set; }
    private bool _isNewStorageItemDisplay = false;
    private bool _isLoaded = false;

    protected override async Task OnInitializedAsync()
    {
        _model.Count = 1;
        StorageItems = await GetAllStorageItems();
        _isLoaded = true;
    }

    private void HandleValidSubmit()
    {
        OnAddNewComingDetail.InvokeAsync(_model);
    }
    
    private async Task<List<StorageItemViewModel>> GetAllStorageItems() => 
        (await new GetAllStorageItemsRequest(RequestManager, HttpClient, new GetAllStorageItemsQuery() {InstanceId = await SessionProvider.GetCurrentInstanceId()}).Send()).Data.ToList();

}
