@using Nano35.WebClient.Services
@using Nano35.Contracts.Repair.Models
@using Nano35.Contexts.Http.Repair
@using Nano35.Contexts.Http.storage
@inject HttpClient HttpClient
@inject RequestManager RequestManager
@inject ISessionProvider SessionProvider
@inject NotificationService NotificationService
@inject HealthService HealthService
@inject NavigationManager NavigationManager
@inject HttpGet GetRequest
@inject HttpPost PostRequest

<LoadingContent IsLoaded="_isLoaded">
    <EditForm Model="Model" OnValidSubmit="HandleValidSubmit">
        <DataAnnotationsValidator/>
        <InputField Title="Работа"
                    Helper="...">
            <Controls>
                <div style="display: flex; width: 100%;">
                    <RadzenDropDown Data=@(Works.Select(a => new {Id = a.Id, Name = a.Name}))
                                    TextProperty="Name"
                                    ValueProperty="Id"
                                    TValue="Guid"
                                    @bind-Value="Model.WorkId"
                                    Style="width: 100%;"
                                    Disabled="!Works.Any()"
                                    Placeholder="Выберите выполняемую работу..."
                                    FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                    FilterOperator="StringFilterOperator.Contains"
                                    AllowFiltering="true"
                                    Change="@WorkChanged"/>
                    <RadzenButton Click=@(_ => NewWork())
                                  Text="Добавить"
                                  ButtonStyle="ButtonStyle.Secondary"/>
                </div>
            </Controls>
        </InputField>
        <InputField Title=""
                    Helper="...">
            <Controls>
                <RadzenDropDown Data=@(StorageItems.Select(a => new {Id = a.Item.Id, Name = a.Item.Name}))
                                TextProperty="Name"
                                ValueProperty="Id"
                                TValue="Guid"
                                @bind-Value="@StorageItemId"
                                Style="width: 100%;"
                                Placeholder="Выберите используемый предмет..."
                                FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                FilterOperator="StringFilterOperator.Contains"
                                AllowFiltering="true"
                                Change="@StorageItemChanged"/>
            </Controls>
        </InputField>
        <InputField Title=""
                    Helper="...">
            <Controls>
                <RadzenDropDown Data=@(Places.Select(a => new {Id = a.Id, Name = a.Name}))
                                TextProperty="Name"
                                ValueProperty="Name"
                                TValue="string"
                                @bind-Value="@PlaceOnStorage"
                                Style="width: 100%;"
                                Placeholder="Выберите место предмета на складе..."
                                FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                FilterOperator="StringFilterOperator.Contains"
                                AllowFiltering="true"/>
            </Controls>
        </InputField>
        <InputField Title="Цена"
                    Helper="...">
            <Controls>
                <RadzenNumeric ShowUpDown="false" 
                               TValue="double"
                               Placeholder="..."
                               @bind-Value="@Model.Price"/>
            </Controls>
        </InputField>
        <RadzenButton type="submit"
                      Text="Создать"
                      ButtonStyle="ButtonStyle.Primary"
                      Style="width: 100%" />
    </EditForm>
</LoadingContent>

@code
{
    [CascadingParameter] BlazoredModalInstance ModalInstance { get; set; }
    [CascadingParameter] public IModalService Modal { get; set; }
    [Parameter] public Guid RepairOrderId { get; set; }
    
    private bool _isLoaded;
    private CreateRepairOrderWorkHttpBody Model { get; set; } = new();
    private List<WorkViewModel>  Works { get; set; } = new();
    private List<StorageItemOnUnitViewModel> StorageItems { get; set; } = new();
    private List<PlaceWithStorageItemOnUnit> Places { get; set; } = new();
    private string PlaceOnStorage = "";
    private Guid StorageItemId { get; set; }

    protected override async Task OnInitializedAsync()
    {
        _isLoaded = false;
        Model.NewId = Guid.NewGuid();
        Model.RepairOrderId = RepairOrderId;
        Model.UnitId = await SessionProvider.GetCurrentUnitId();
        Model.InstanceId = await SessionProvider.GetCurrentInstanceId();
        
        await GetRequest.InvokeAsync<GetAllWorksHttpResponse>($"Works?InstanceId={await SessionProvider.GetCurrentInstanceId()}",
            resp =>
            {
                if (resp.IsSuccess())
                {
                    Works = resp.Success.Data;
                }
                else
                {
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
        
        await GetRequest.InvokeAsync<GetAllStorageItemsOnUnitSuccessHttpResponse>($"Warehouse/StorageItemsOnUnit?UnitId={await SessionProvider.GetCurrentUnitId()}",
            resp =>
            {
                if (resp.IsSuccess())
                {
                    StorageItems = resp.Success.Contains;
                }
                else
                {
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
        _isLoaded = true;
    }

    private async Task HandleValidSubmit()
    {
        Console.WriteLine(PlaceOnStorage);
        if (StorageItemId != Guid.Empty)
        {
            Model.UsesDeviceFrom = new CreateCancellationDetailViewModel()
            {
                NewId = Guid.NewGuid(),
                StorageItemId = StorageItemId,
                Count = 1,
                PlaceOnStorage = PlaceOnStorage
            };
        }
        
        await PostRequest.InvokeAsync<CreateRepairOrderWorkHttpResponse, CreateRepairOrderWorkHttpBody>($"RepairOrders/Work", Model,
            resp =>
            {
                if (resp.IsSuccess())
                {
                    
                }
                else
                {
                    
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
        
        await ModalInstance.CloseAsync();
    }

    private async Task NewWork()
    {
        var modal = Modal.Show<WorkCreateForm>($"Новая работа");
        await modal.Result;
        
        await GetRequest.InvokeAsync<GetAllWorksHttpResponse>($"Works?InstanceId={await SessionProvider.GetCurrentInstanceId()}",
            resp =>
            {
                if (resp.IsSuccess())
                {
                    Works = resp.Success.Data;
                }
                else
                {
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
    }

    private async Task WorkChanged()
    {
        Model.Price = Works.FirstOrDefault(a=> a.Id == Model.WorkId).Price;
    }
    
    private async Task StorageItemChanged()
    {
        await GetRequest.InvokeAsync<GetAllPlacesOfStorageItemOnUnitSuccessHttpResponse>(
            $"Warehouse/PlacesOfStorageItemOnUnit?StorageItemId={StorageItemId}&UnitContainsStorageItemId={await SessionProvider.GetCurrentUnitId()}",
            resp =>
            {
                if (resp.IsSuccess())
                {
                    Places = resp.Success.Contains.ToList();
                }
                else
                {
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
        
        Model.Price = Works.First(a=> a.Id == Model.WorkId).Price;
        Model.Price += StorageItems.First(a => a.Item.Id == StorageItemId).Item.PurchasePrice;
    }

    
}