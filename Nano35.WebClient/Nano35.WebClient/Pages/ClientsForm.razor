@using Nano35.WebClient.Services
@using Nano35.HttpContext.instance
@inject HttpClient HttpClient
@inject IRequestManager RequestManager
@inject IInstanceService InstanceService

@if (_loaded)
{
    <EditForm Model="@Model" 
          OnValidSubmit="HandleValidSubmit">
        <DataAnnotationsValidator />
        
        <InputField Title="Статус клиента">
            <Controls>
                <RadzenDropDown Data=@(_state.Select(a => new {a.Id, a.Name}))
                                TextProperty="Name"
                                ValueProperty="Id"
                                TValue="Guid"
                                @bind-Value="Model.ClientStateId"
                                style="width: 100%"
                                Placeholder="Выберите статус клиента..."/>
            </Controls>
            <Validation>
                <ValidationMessage For="@(() => Model.ClientStateId)" />
            </Validation>
        </InputField>
        
        <InputField Title="Тип клиента">
            <Controls>
                <RadzenDropDown Data=@(_types.Select(a => new {a.Id, a.Name}))
                                TextProperty="Name"
                                ValueProperty="Id"
                                TValue="Guid"
                                @bind-Value="Model.ClientTypeId"
                                style="width: 100%"
                                Placeholder="Выберите тип клиента..."/>
            </Controls>
            <Validation>
                <ValidationMessage For="@(() => Model.ClientTypeId)" />
            </Validation>
        </InputField>
        
        <InputField Title="@(Model.ClientStateId != Guid.Empty && 
                             Model.ClientStateId == _state.First().Id ?
                               "Название организации" : 
                               "ФИО клиента")">
            <Controls>
                <RadzenTextBox Style="width: 100%;" 
                               Placeholder="..."
                               @bind-Value="Model.Name"/>
            </Controls>
            <Validation>
                <ValidationMessage For="@(() => Model.Name)" />
            </Validation>
        </InputField>
        
        <InputField Title="Эл почта">
            <Controls>
                <RadzenTextBox Style="width: 100%;" 
                               Placeholder="..."
                               @bind-Value="Model.Email"/>
            </Controls>
            <Validation>
                <ValidationMessage For="@(() => Model.Email)" />
            </Validation>
        </InputField>
        
        <InputField Title="Номер телефона">
            <Controls>
                <RadzenTextBox Style="width: 100%;" 
                               Placeholder="..."
                               @bind-Value="Model.Phone"/>
            </Controls>
            <Validation>
                <ValidationMessage For="@(() => Model.Phone)" />
            </Validation>
        </InputField>
        
        <InputField Title="Скидка">
            <Controls>
                <RadzenNumeric Style="width: 100%;" 
                               Placeholder="..."
                               @bind-Value="Model.Selle"/>
            </Controls>
            <Validation>
                <ValidationMessage For="@(() => Model.Selle)" />
            </Validation>
        </InputField>
        
        @if (!string.IsNullOrEmpty(Error))
        {
            <div class="alert alert-danger mt-3 mb-0">@Error</div>
        }
        
        <RadzenButton type="submit"
                      Text="Создать"
                      ButtonStyle="ButtonStyle.Primary"
                      Style="width: 100%" />
    </EditForm>
}
else
{
    <div class="d-flex justify-content-center" style="margin-top: 5rem; margin-bottom: 5rem">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden"></span>
        </div>
    </div>
}

@code
{
    [CascadingParameter] public IModalService Modal { get; set; }
    [CascadingParameter] BlazoredModalInstance ModalInstance { get; set; }
    [Parameter] public CreateClientHttpBody Model { get; set; }
    [Parameter] public EventCallback FormSubmitted { get; set; }
    [Parameter] public string Error { get; set; }
    [Parameter] public Guid TypeId { get; set; }

    private List<ClientTypeViewModel> _types = new();
    private List<ClientStateViewModel> _state = new();
    private bool _loaded;

    protected override async Task OnInitializedAsync()
    {
        if (TypeId != Guid.Empty)
        {
            Model.ClientTypeId = TypeId;
            Console.WriteLine(@$"Model.ClientTypeId = {Model.ClientTypeId}");
            StateHasChanged();
        }
        _loaded = false;
        _state = (await (new GetAllClientStatesRequest(RequestManager, HttpClient, new GetAllClientStatesHttpQuery())).Send()).Data.ToList();
        _types = (await (new GetAllClientTypesRequest(RequestManager, HttpClient, new GetAllClientTypesHttpQuery()).Send())).Data.ToList();
        _loaded = true;
    }

    private async Task HandleValidSubmit()
    {
        await FormSubmitted.InvokeAsync();
        await ModalInstance.CloseAsync();
    }
}
