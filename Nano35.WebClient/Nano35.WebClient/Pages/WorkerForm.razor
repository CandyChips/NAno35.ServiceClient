@using Nano35.WebClient.Services
@using Nano35.HttpContext.instance
@using System.Text.RegularExpressions
@inject HttpClient HttpClient

<EditForm Model="@_model" OnSubmit="HandleValidSubmit">
    <DataAnnotationsValidator />
    
    <InputField Title="Фио*">
        <Controls>
            <InputText @bind-Value="_model.Name" 
                        class="form-control"/>
        </Controls>
        <Validation>
            <ValidationMessage For="@(() => _model.Name)" />
        </Validation>
    </InputField>
    
    <InputField Title="Эл почта">
        <Controls>
            <InputText @bind-Value="_model.Email" 
                        class="form-control"/>
        </Controls>
        <Validation>
                    <ValidationMessage For="@(() => _model.Email)" />
        </Validation>
    </InputField>
    
    <InputField Title="Номер телефона*">

        <Controls>
            <RadzenTextBox Style="width: 100%;" 
                           class="form-control" 
                           @bind-Value="Phone" 
                           Change=@(PhoneMask) />
        </Controls>
        <Validation>
            <ValidationMessage For="@(() => _model.Phone)" />
        </Validation>
    </InputField>
    
    <InputField Title="Пароль*">
        <Controls>
            <InputText @bind-Value="_model.Password" 
                        class="form-control"/>
        </Controls>
        <Validation>
            <ValidationMessage For="@(() => _model.Password)" />
        </Validation>
    </InputField>
    
    <InputField Title="Подтверждение пароля*">
        <Controls>
            <InputText @bind-Value="_model.PasswordConfirm" 
                        class="form-control"/>
        </Controls>
        <Validation>
            <ValidationMessage For="@(() => _model.PasswordConfirm)" />
        </Validation>
    </InputField>
    
    <InputField Title="Примечание">
        <Controls>
            <InputText @bind-Value="_model.Comment" 
                        class="form-control"/>
        </Controls>
        <Validation>
            <ValidationMessage For="@(() => _model.Comment)" />
        </Validation>
    </InputField>
    
    <InputField Title="Должности*">
        <Controls>
            <RadzenCheckBoxList @bind-Value=@roles TValue="Guid" Orientation="Orientation.Horizontal">
                <Items>
                    <RadzenCheckBoxListItem Text="Администратор" Value=@Roles.Admin />
                    <RadzenCheckBoxListItem Text="Кладовщик" Value=@Roles.Storage />
                    <RadzenCheckBoxListItem Text="Менеджер" Value=@Roles.Manager />
                    <RadzenCheckBoxListItem Text="Бухгалтер" Value=@Roles.Cashbox />
                    <RadzenCheckBoxListItem Text="Мастер" Value=@Roles.Master />
                </Items>
            </RadzenCheckBoxList>
        </Controls>
        <Validation>
            <ValidationMessage For="@(() => _model.Roles)"/>
        </Validation>
    </InputField>
    
    @if (!string.IsNullOrEmpty(_error))
    {
        <div class="alert alert-danger mt-3 mb-0">@_error</div>
    }
    
    <RadzenButton type="submit"
                  Text="Создать"
                  ButtonStyle="ButtonStyle.Primary"
                  Style="width: 100%" />
</EditForm>

@code
{
    [Inject] private IRequestManager RequestManager { get; set; }
    [Inject] private IInstanceService InstanceService { get; set; }
    [Parameter] public EventCallback OnHideModalNewWorker { get; set; }
    [CascadingParameter] BlazoredModalInstance ModalInstance { get; set; }
    private IEnumerable<Guid> roles = new Guid[] {};
    private CreateWorkerHttpBody _model = new();
    private string _error = "";

    private string Phone { get; set; } = "+7";

    protected override async Task OnInitializedAsync()
    {
        _model.NewId = Guid.NewGuid();
        _model.InstanceId = InstanceService.GetCurrentInstance().Id;
    }

    private async Task HandleValidSubmit()
    {
        _model.Roles = roles.ToList();
        await new HttpPostRequest<CreateWorkerHttpBody,CreateWorkerHttpResponse>(HttpClient, $"{RequestManager.InstanceServer}/Workers").PostAsync(_model);
        //await new HttpRequestWrapper<CreateWorkerHttpBody, CreateWorkerSuccessHttpResponse>(HttpClient).PostAsync($"{RequestManager.InstanceServer}/Workers", _model);
        await OnHideModalNewWorker.InvokeAsync();
        await ModalInstance.CloseAsync(ModalResult.Ok(""));
    }
    
    private async Task PhoneMask()
    {

        Phone = Regex.Replace(Phone, @"[^\d]", "");
        
        var countryCode = "+7";
        
        if (Phone.StartsWith("7"))
            Phone = Phone.Remove(0,1);
        
        if (Phone.StartsWith("8"))
            Phone = Phone.Remove(0,1);
        
        if (Phone.Length < 10)
            Phone = Phone.PadRight(10);

        if (Phone.Length > 10)
            Phone = Phone.Substring(0, 10);

        Phone = $"{countryCode}({Phone.Substring(0, 3)}) {Phone.Substring(3, 3)}-{Phone.Substring(6, 2)}-{Phone.Substring(8, 2)}";
        
        _model.Phone = Phone;
    }
}
