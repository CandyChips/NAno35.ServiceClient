@using Nano35.WebClient.Services
@using Nano35.HttpContext.storage
@inject HttpClient HttpClient
@inject IRequestManager RequestManager
@inject ISessionProvider SessionProvider

<EditForm Model="@(_model)"
          OnValidSubmit="HandleValidSubmit">
    @if (_isLoaded)
    {
        <DataAnnotationsValidator/>
        
        <InputField Title="Товар">
            <Controls>
                <RadzenDropDown Data=@(StorageItems.Select(a => new { a.Id, Name = $"{a.Article + " " + a.Condition}" }))
                                TextProperty="Name"
                                ValueProperty="Id"
                                TValue="Guid"
                                @bind-Value="_model.StorageItemId"
                                Style="width: 100%;"
                                Placeholder="..."
                                FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                FilterOperator="StringFilterOperator.Contains"
                                AllowFiltering="true"
                                Change="@GetAllPlacesOfStorageItem"/>

            </Controls>
            <Validation>
                <ValidationMessage For="@(() => _model.StorageItemId)" />
            </Validation>
        </InputField>
        
        <InputField Title="Ячейка на складе отправителя">
            <Controls>
                <RadzenDropDown Data=@(FromPlaceOnStorage
                                         .Select(a => 
                                             new {Name = a.Name}))
                                TextProperty="Name"
                                ValueProperty="Name"
                                TValue="string"
                                @bind-Value="_model.FromPlaceOnStorage"
                                Style="width: 100%;"
                                Placeholder="Выберите ячейку"
                                FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                FilterOperator="StringFilterOperator.Contains"
                                AllowFiltering="true"
                                Change="PlaceOnStorageChanged"/>
            </Controls>
            <Validation>
                <ValidationMessage For="@(() => _model.FromPlaceOnStorage)" />
            </Validation>
        </InputField>
        
        @if(ToPlaceOnStorage.Any())
                {
                    <InputField Title="Ячейка на складе получателя">
                    <Controls>
                        <RadzenDropDown Data=@(ToPlaceOnStorage.Select(a => new { Name = a.Name}))
                                        TextProperty="Name"
                                        ValueProperty="Name"
                                        TValue="string"
                                        @bind-Value="_model.ToPlaceOnStorage"
                                        Style="width: 100%;"
                                        Disabled="@(!StorageItems.Any())"
                                        Placeholder="Выберите из доступных ячеек"
                                        FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                        FilterOperator="StringFilterOperator.Contains"
                                        AllowFiltering="true"/>
                    </Controls>
                    <Validation>
                        <ValidationMessage For="@(() => _model.ToPlaceOnStorage)" />
                    </Validation>
                </InputField>
                }
                else
                {
                    <InputField Title="Ячейка на складе получателя">
                        <Controls>
                            <RadzenTextBox style="display: flex; width: 100%"
                                           @bind-Value="_model.ToPlaceOnStorage"
                                           Placeholder="Введите название новой ячейки"/>
                        </Controls>
                        <Validation>
                            <ValidationMessage For="@(() => _model.ToPlaceOnStorage)" />
                        </Validation>
                    </InputField>
                }
        
        <InputField Title="Количество">
                    <Controls>
                        <RadzenNumeric Style="width: 100%;" 
                                       Placeholder="@(_maxItems.ToString())"
                                       @bind-Value="_model.Count"
                                       ShowUpDown="false"
                                       Max="@_maxItems"/>
                    </Controls>
                    <Validation>
                        <ValidationMessage For="@(() => _model.Count)" />
                    </Validation>
                </InputField>

        <RadzenButton type="submit"
                      Text="Создать"
                      ButtonStyle="ButtonStyle.Primary"
                      Style="width: 100%" />
    }
</EditForm>

@code
{
    [CascadingParameter] BlazoredModalInstance ModalInstance { get; set; }
    [Parameter] public Guid ToUnitId { get; set; }
    [Parameter] public Guid FromUnitId { get; set; }

    private CreateMoveDetailViewModel _model = new() {NewId = Guid.NewGuid(), Count = 1,};
    private List<StorageItemViewModel> StorageItems { get; set; } = new();
    private List<PlaceWithStorageItemOnUnit> FromPlaceOnStorage { get; set; } = new();
    private List<PlaceWithStorageItemOnUnit> ToPlaceOnStorage { get; set; } = new();
    private bool _isLoaded;
    private int _maxItems;

    protected override async Task OnInitializedAsync()
    {
        StorageItems = await GetAllStorageItems();
        _isLoaded = true;
    }

    private async Task GetAllPlacesOfStorageItem()
    {
        FromPlaceOnStorage = (await new HttpGetRequest<GetAllPlacesOfStorageItemOnUnitSuccessHttpResponse>(HttpClient,
            $"{RequestManager.StorageServer}/Warehouse/PlacesOfStorageItemOnUnit?StorageItemId={_model.StorageItemId}&UnitContainsStorageItemId={FromUnitId}").GetAsync()).Contains.ToList();
        
        ToPlaceOnStorage =   (await new HttpGetRequest<GetAllPlacesOfStorageItemOnUnitSuccessHttpResponse>(HttpClient, 
            $"{RequestManager.StorageServer}/Warehouse/PlacesOfStorageItemOnUnit?StorageItemId={_model.StorageItemId}&UnitContainsStorageItemId={ToUnitId}").GetAsync()).Contains.ToList();
    }
    
    private async Task HandleValidSubmit() 
    {
        await ModalInstance.CloseAsync(ModalResult.Ok(_model));
    }
    
    private async Task<List<StorageItemViewModel>> GetAllStorageItems() => 
        (await new HttpGetRequest<GetAllStorageItemsSuccessHttpResponse>(HttpClient, $"{RequestManager.StorageServer}/StorageItems?InstanceId={await SessionProvider.GetCurrentInstanceId()}").GetAsync()).Data.ToList();
    

    private async Task PlaceOnStorageChanged()
    {
        _maxItems = FromPlaceOnStorage.FirstOrDefault(a=> a.Name == _model.FromPlaceOnStorage).Count;
        Console.WriteLine("12312313");
    }
}
