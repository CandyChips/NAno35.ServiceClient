@using Nano35.WebClient.Services
@using Nano35.HttpContext.storage
@inject IRequestManager RequestManager
@inject ISessionProvider SessionProvider 
@inject HttpClient HttpClient 

<EditForm Model="@Model" OnValidSubmit="Create">
    <DataAnnotationsValidator />

    <InputField Title="Наименование*">
        <Controls>
            <div style="display: flex; width: 100%">
                <RadzenDropDown Data=@(_articles.Select(a => new {Id = a.Id, Name = $"{a.Category} {a.Model}"}))
                                TextProperty="Name"
                                ValueProperty="Id"
                                TValue="Guid"
                                @bind-Value="Model.ArticleId"
                                Disabled="@(!_articles.Any())"
                                style="width: 100%;"
                                AllowClear="true"
                                Placeholder="Выберите наименование товара"
                                FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                FilterOperator="StringFilterOperator.Contains"
                                AllowFiltering="true"/>
                <RadzenButton Click="@(_ => OpenCreateArticle())"
                              Text="Добавить"
                              ButtonStyle="ButtonStyle.Secondary"/>
            </div>
        </Controls>
    </InputField>

    <InputField Title="Состояние*">
        <Controls>
            <RadzenDropDown Data="@(_conditions.Select(a => new {Id = a.Id, Name = a.Name}))"
                            TextProperty="Name"
                            ValueProperty="Id"
                            TValue="Guid"
                            @bind-Value="Model.ConditionId"
                            style="flex: auto;"
                            AllowClear="true"
                            Placeholder="Выберите состояние товара"
                            FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                            FilterOperator="StringFilterOperator.Contains"
                            AllowFiltering="true"/>
        </Controls>
    </InputField>
                
    <InputField Title="Комментарий">
        <Controls>
            <RadzenTextBox Style="width: 100%;" 
                           Placeholder="Укажите комментарий к товару"
                           @bind-Value="Model.Comment"/>
        </Controls>
    </InputField>
                
    <InputField Title="Скрытый комментарий">
        <Controls>
            <RadzenTextBox Style="width: 100%;" 
                           Placeholder="Укажите скрытый комментарий к товару"
                           @bind-Value="Model.HiddenComment"/>
        </Controls>
    </InputField>
                
    <InputField Title="Закупочная цена">
        <Controls>
            <RadzenNumeric Style="width: 100%;" 
                           Placeholder="0"
                           @bind-Value="Model.RetailPrice"/>
        </Controls>
    </InputField>
                
    <InputField Title="Цена продажи">
        <Controls>
            <RadzenNumeric Style="width: 100%;" 
                           Placeholder="0"
                           @bind-Value="Model.PurchasePrice"/>
        </Controls>
    </InputField>
    
    <InputFile OnChange="@OnInputFileChange" multiple />

    @if (files.Count > 0)
    {
        <div class="card">
            <div class="card-body">
                <ul>
                    @foreach (var file in files)
                    {
                        <li>
                            File: @file.Name
                            <br>
                            @if (FileUpload(uploadResults, file.Name, out var result))
                            {
                                <span>
                                    Stored File Name: @result.StoredFileName
                                </span>
                            }
                            else
                            {
                                <span>
                                    There was an error uploading the file
                                    (Error: @result.ErrorCode).
                                </span>
                            }
                        </li>
                    }
                </ul>
            </div>
        </div>
    }
            
    @if (!string.IsNullOrEmpty(Error))
    {
        <div class="alert alert-danger mt-3 mb-0">@Error</div>
    }

    <RadzenButton type="submit"
                  Text="Создать"
                  ButtonStyle="ButtonStyle.Primary"
                  Style="width: 100%" />
</EditForm>

@code
{
    [Parameter] public CreateStorageItemHttpBody Model { get; set; }
    [Parameter] public EventCallback FormSubmitted { get; set; }
    [Parameter] public string Error { get; set; }
    [CascadingParameter] public IModalService Modal { get; set; }
    [CascadingParameter] BlazoredModalInstance ModalInstance { get; set; }
    
    private bool _isLoaded;
    private List<ArticleViewModel> _articles = new List<ArticleViewModel>();
    private List<StorageItemConditionViewModel> _conditions = new List<StorageItemConditionViewModel>();
    private IList<File> files = new List<File>();
    private IList<UploadResult> uploadResults = new List<UploadResult>();
    private int maxAllowedFiles = 3;
    private bool shouldRender;

    protected override async Task OnInitializedAsync()
    {
        _isLoaded = false;
        _conditions = (await new GetAllStorageItemConditionsRequest(RequestManager, HttpClient, new GetAllStorageItemConditionsHttpQuery()).Send()).Data.ToList();
        _articles = (await new GetAllArticlesRequest(RequestManager, HttpClient, new GetAllArticlesHttpQuery() {InstanceId = await SessionProvider.GetCurrentInstanceId()}).Send()).Data.ToList();
        _isLoaded = true;
    }
    
    private async Task Create()
    { 
        await FormSubmitted.InvokeAsync();
        await ModalInstance.CloseAsync();    
    }

    private async Task OpenCreateArticle()
    {
        var moviesModal = Modal.Show<ArticlesCreate>("Новое наименование");
        await moviesModal.Result;
        _articles = (await new GetAllArticlesRequest(RequestManager, HttpClient, new GetAllArticlesHttpQuery() {InstanceId = await SessionProvider.GetCurrentInstanceId()}).Send()).Data.ToList();
    }
    
    private async Task OnInputFileChange(InputFileChangeEventArgs e)
    {
        shouldRender = false;
        long maxFileSize = 1024 * 1024 * 15;
        var upload = false;

        using var content = new MultipartFormDataContent();

        foreach (var file in e.GetMultipleFiles(maxAllowedFiles))
        {
            if (uploadResults.SingleOrDefault(
                f => f.FileName == file.Name) is null)
            {
                var fileContent = new StreamContent(file.OpenReadStream());

                files.Add(
                    new File()
                    {
                        Name = file.Name,
                    });

                if (file.Size < maxFileSize)
                {
                    content.Add(
                        content: fileContent,
                        name: "\"files\"",
                        fileName: file.Name);

                    upload = true;
                }
                else
                {
                    uploadResults.Add(
                        new UploadResult()
                        {
                            FileName = file.Name,
                            ErrorCode = 6,
                            Uploaded = false,
                        });
                }
            }
        }

        if (upload)
        {
            var response = await HttpClient.PostAsync($"http://localhost:5006/Images/CreateStorageItemImage?storageITemId={Model.NewId}", content);

            var newUploadResults = await response.Content
                .ReadFromJsonAsync<IList<UploadResult>>();

            uploadResults = uploadResults.Concat(newUploadResults).ToList();
        }

        shouldRender = true;
    }

    private static bool FileUpload(IList<UploadResult> uploadResults,
        string fileName, out UploadResult result)
    {
        result = uploadResults.SingleOrDefault(f => f.FileName == fileName);

        if (result is null)
        {
            result = new UploadResult();
            result.ErrorCode = 5;
        }

        return result.Uploaded;
    }

    private class File
    {
        public string Name { get; set; }
    }

    public class UploadResult
    {
        public int ErrorCode { get; set; }
        public string StoredFileName { get; set; }
        public string FileName { get; set; }
        public bool Uploaded { get; set; }
    }
}
