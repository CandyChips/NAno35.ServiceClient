@using Nano35.WebClient.Services
@using Nano35.HttpContext.storage
@inject HttpClient HttpClient
@inject IRequestManager RequestManager
@inject ISessionProvider SessionProvider

<EditForm Model="@(_model)"
          OnValidSubmit="HandleValidSubmit">
    @if (_isLoaded)
    {
        <DataAnnotationsValidator/>
        
        <InputField Title="Товар">
            <Controls>
                <RadzenDropDown Data=@(StorageItems
                                         .Select(a => 
                                             new {Id = a.Id, 
                                                 Name = $"{a.Article + " " + a.Condition}"}))
                                TextProperty="Name"
                                ValueProperty="Id"
                                TValue="Guid"
                                @bind-Value="_model.StorageItemId"
                                Style="width: 100%;"
                                Placeholder="..."
                                FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                FilterOperator="StringFilterOperator.Contains"
                                AllowFiltering="true"
                                Change="@GetAllPlacesOfStorageItem"/>

            </Controls>
        </InputField>
        
        <InputField Title="Ячейка на складе">
                    <Controls>
                        <RadzenDropDown Data=@(Warehouse
                                                 .Select(a => 
                                                     new {Name = a.Name}))
                                        TextProperty="Name"
                                        ValueProperty="Name"
                                        TValue="string"
                                        @bind-Value="_model.PlaceOnStorage"
                                        Style="width: 100%;"
                                        Placeholder="..."
                                        FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                        FilterOperator="StringFilterOperator.Contains"
                                        AllowFiltering="true"/>
            </Controls>
        </InputField>
        
        <InputField Title="Количество">
            <Controls>
                <RadzenNumeric style="width: 100%;" 
                               Placeholder="..."
                               @bind-Value="_model.Count"/>
            </Controls>
        </InputField>
        
        <InputField Title="Цена">
            <Controls>
                <RadzenNumeric style="width: 100%;" 
                               Placeholder="..."
                               @bind-Value="_model.Price"/>
            </Controls>
        </InputField>

        <RadzenButton type="submit"
                      Text="Создать"
                      ButtonStyle="ButtonStyle.Primary"
                      Style="width: 100%" />
    }
</EditForm>

@code
{
    [CascadingParameter] BlazoredModalInstance ModalInstance { get; set; }
    
    private CreateSelleDetailViewModel _model;
    private List<StorageItemViewModel> StorageItems { get; set; } = new List<StorageItemViewModel>();
    private List<PlaceWithStorageItemOnUnit> Warehouse { get; set; } = new List<PlaceWithStorageItemOnUnit>();
    private bool _isLoaded;

    protected override async Task OnInitializedAsync()
    {
        _model = new CreateSelleDetailViewModel()
        {
            NewId = Guid.NewGuid(),
            Count = 1,
        };
        StorageItems = await GetAllStorageItems();
        _isLoaded = true;
    }

    private async Task GetAllPlacesOfStorageItem()
    {
        var unitId = await SessionProvider.GetCurrentUnitId();
        Warehouse = (await new GetAllPlacesOfStorageItemOnUnitRequest(
            RequestManager, 
            HttpClient, 
            new GetAllPlacesOfStorageItemOnUnitHttpQuery()
            {
                StorageItemId = _model.StorageItemId,
                UnitContainsStorageItemId = unitId
                    
            })
            .Send())
            .Contains
            .ToList();

        _model.Price = Decimal.ToDouble(StorageItems.FirstOrDefault(a=> a.Id == _model.StorageItemId).RetailPrice);
    }
    
    private void HandleValidSubmit() 
    {
        ModalInstance.CloseAsync(ModalResult.Ok(_model));
    }
    
    private async Task<List<StorageItemViewModel>> GetAllStorageItems() => 
        (await new GetAllStorageItemsRequest(
            RequestManager, 
            HttpClient, 
            new GetAllStorageItemsQuery()
            {
                InstanceId = await SessionProvider.GetCurrentInstanceId()
            })
            .Send())
            .Data
            .ToList();

}
