@using Nano35.HttpContext.storage
@using Nano35.WebClient.Services
@inject HttpClient HttpClient
@inject IRequestManager RequestManager
@inject ISessionProvider SessionProvider

<LoadingContent IsLoaded="_isLoaded">
    <LoadedContent>
        <FieldList Title="Информация">
            <FieldListItem Title="Артикул">
                <EditableField OnCancel="@(() => ArticleEdit = null)"
                               OnEdit="@(() => ArticleEdit = new UpdateStorageItemArticleHttpBody(){Id = StorageItem.Id})"
                               OnSave="@(() => UpdateArticle())">
                    <View>@StorageItem.Article</View>
                    <Edit>
                        <RadzenDropDown AllowClear="true"
                                        TValue="Guid"
                                        Data=@(Articles.Select(g => new {g.Id, Name = $"{g.Brand} {g.Model}"}))
                                        TextProperty="Name"
                                        ValueProperty="Id"
                                        @bind-Value="ArticleEdit.ArticleId">
                            <Template Context="data">
                                <div style="display: flex; flex-direction: row">
                                    <div style="width: 90%;">@(data.Name)</div>
                                    <RadzenButton
                                        Click="@(_ => OpenArticleDetails(data.Id, data.Name))"
                                        Size="ButtonSize.Small"
                                        Text="🖉"
                                        Style="height: 20px;
                                           display: flex;
                                           padding-left: revert;
                                           padding-right: revert;
                                           align-items: center;"/>
                                </div>
                            </Template>
                        </RadzenDropDown>
                    </Edit>
                </EditableField>
            </FieldListItem>
            
            <FieldListItem Title="Закупочная цена">
                <EditableField OnCancel="@(() => PurchasePriceEdit = null)"
                               OnEdit="@(() => PurchasePriceEdit = new UpdateStorageItemPurchasePriceHttpBody(){Id = StorageItem.Id})"
                               OnSave="@(() => UpdatePurchasePrice())">
                    <View>@StorageItem.PurchasePrice</View>
                    <Edit>
                        <RadzenNumeric style="display: flex; "
                                       @bind-Value="PurchasePriceEdit.PurchasePrice"
                                       ShowUpDown="false"
                                       Placeholder="@StorageItem.PurchasePrice.ToString()"
                                       Min="0"/>
                    </Edit>
                </EditableField>
            </FieldListItem>
            
            <FieldListItem Title="Цена продажи">
                <EditableField OnCancel="@(() => RetailPriceEdit = null)"
                               OnEdit="@(() => RetailPriceEdit = new UpdateStorageItemRetailPriceHttpBody(){Id = StorageItem.Id})"
                               OnSave="@(() => UpdateRetailPrice())">
                    <View>@StorageItem.RetailPrice</View>
                    <Edit>
                        <RadzenNumeric style="display: flex; align-items: center"
                                       @bind-Value="RetailPriceEdit.RetailPrice"
                                       ShowUpDown="false"
                                       Placeholder="@StorageItem.RetailPrice.ToString()"
                                       Min="0"/>
                    </Edit>
                </EditableField>
            </FieldListItem>
            
            <FieldListItem Title="Состояние">
                <EditableField OnCancel="@(() => ConditionEdit = null)"
                               OnEdit="@(() => ConditionEdit = new UpdateStorageItemConditionHttpBody(){Id = StorageItem.Id})"
                               OnSave="@(() => UpdateCondition())">
                    <View>@StorageItem.Condition</View>
                    <Edit>
                        <RadzenDropDown style="display: flex; "
                                        AllowClear="true"
                                        TValue="Guid"
                                        Data=@(Conditions.Select(g => new {Id = g.Id, Name = g.Name}))
                                        TextProperty="Name"
                                        ValueProperty="Id"
                                        @bind-Value="ConditionEdit.ConditionId"/>
                    </Edit>
                </EditableField>
            </FieldListItem>
            
            <FieldListItem Title="Комментарий">
                <EditableField OnCancel="@(() => CommentEdit = null)"
                               OnEdit="@(() => CommentEdit = new UpdateStorageItemCommentHttpBody(){Id = StorageItem.Id})"
                               OnSave="@(() => UpdateComment())">
                    <View>@StorageItem.Comment</View>
                    <Edit>
                        <RadzenTextBox style="display: flex;align-items: center"
                                       @bind-Value="CommentEdit.Comment"
                                       Placeholder="@StorageItem.Comment"/>
                    </Edit>
                </EditableField>
            </FieldListItem>
            
            <FieldListItem Title="Скрытый комментарий">
                <EditableField OnCancel="@(() => HiddenCommentEdit = null)"
                               OnEdit="@(() => HiddenCommentEdit = new UpdateStorageItemHiddenCommentHttpBody(){Id = StorageItem.Id})"
                               OnSave="@(() => UpdateHiddenComment())">
                    <View>@StorageItem.HiddenComment</View>
                    <Edit>
                        <RadzenTextBox style="display: flex;align-items: center"
                                       @bind-Value="HiddenCommentEdit.HiddenComment"
                                       Placeholder="@StorageItem.HiddenComment"/>
                    </Edit>
                </EditableField>
            </FieldListItem>
        </FieldList>

        <RadzenFieldset Text="Товары в наличии"
                    Style="width: 60rem">
        <RadzenGrid Data="@(Places)"
                    EmptyText="Нет занятых мест в текущем подразделении..."
                    TItem="PlaceWithStorageItemOnUnit">
            <Columns>
                <RadzenGridColumn TItem="PlaceWithStorageItemOnUnit"
                                  Property="Name"
                                  Title="Место на складе"/>
                <RadzenGridColumn TItem="PlaceWithStorageItemOnUnit"
                                  Property="Count"
                                  Title="Количество"/>
            </Columns>
        </RadzenGrid>
    </RadzenFieldset>
    </LoadedContent>
</LoadingContent>

@code
{
    [CascadingParameter] public IModalService Modal { get; set; }
    [CascadingParameter] BlazoredModalInstance ModalInstance { get; set; }

    [Parameter] public StorageItemOnInstanceViewModel Item { get; set; }
    private StorageItemViewModel StorageItem { get; set; } = new ();
    private List<PlaceWithStorageItemOnUnit> Places { get; set; } = new();

    private UpdateStorageItemArticleHttpBody ArticleEdit { get; set; }
    private List<ArticleViewModel> Articles { get; set; } = new();
    
    private UpdateStorageItemPurchasePriceHttpBody PurchasePriceEdit { get; set; }
    
    private UpdateStorageItemRetailPriceHttpBody RetailPriceEdit { get; set; }
    
    private UpdateStorageItemConditionHttpBody ConditionEdit { get; set; }
    private List<StorageItemConditionViewModel> Conditions { get; set; } = new();
    
    private UpdateStorageItemCommentHttpBody CommentEdit { get; set; }
    
    private UpdateStorageItemHiddenCommentHttpBody HiddenCommentEdit { get; set; }
    
    private bool _isLoaded;

    
    protected override async Task OnInitializedAsync()
    {
        _isLoaded = false;
        
        StorageItem = (await new HttpGetRequest<GetStorageItemByIdSuccessHttpResponse>(HttpClient, $"{RequestManager.StorageServer}/StorageItems/{Item.Item.Id}").GetAsync()).Data;
        
        Places = (await new HttpGetRequest<GetAllPlacesOfStorageItemOnUnitSuccessHttpResponse>(HttpClient, $"{RequestManager.StorageServer}/Warehouse/PlacesOfStorageItemOnUnit?StorageItemId={Item.Item.Id}&UnitContainsStorageItemId={await SessionProvider.GetCurrentUnitId()}").GetAsync()).Contains;
        
        Conditions = (await new HttpGetRequest<GetAllStorageItemConditionsSuccessHttpResponse>(HttpClient, $"{RequestManager.StorageServer}/StorageItemConditions").GetAsync()).Data;
        
        Articles = (await new HttpGetRequest<GetAllArticlesSuccessHttpResponse>(HttpClient, $"{RequestManager.StorageServer}/Articles?InstanceId={await SessionProvider.GetCurrentInstanceId()}").GetAsync()).Data;
        
        _isLoaded = true;
    }
    private async Task UpdateArticle()
    {
        await new HttpPatchRequest<UpdateStorageItemArticleHttpBody, UpdateStorageItemArticleSuccessHttpResponse>(HttpClient, $"{RequestManager.StorageServer}/StorageItems/Article").PatchAsync(ArticleEdit);
        ArticleEdit = null;
    }

    private async Task UpdatePurchasePrice()
    {
        await new HttpPatchRequest<UpdateStorageItemPurchasePriceHttpBody, UpdateStorageItemPurchasePriceSuccessHttpResponse>(HttpClient, $"{RequestManager.StorageServer}/StorageItems/PurchasePrice").PatchAsync(PurchasePriceEdit);
        PurchasePriceEdit = null;
    }

    private async Task UpdateRetailPrice() 
    {
        await new HttpPatchRequest<UpdateStorageItemRetailPriceHttpBody, UpdateStorageItemRetailPriceSuccessHttpResponse>(HttpClient, $"{RequestManager.StorageServer}/StorageItems/RetailPrice").PatchAsync(RetailPriceEdit);
        RetailPriceEdit = null;
    }
    
    private async Task UpdateCondition() 
    {
        await new HttpPatchRequest<UpdateStorageItemConditionHttpBody, UpdateStorageItemConditionSuccessHttpResponse>(HttpClient, $"{RequestManager.StorageServer}/StorageItems/Condition").PatchAsync(ConditionEdit);
        ConditionEdit = null;
    }    
    private async Task UpdateComment()
    {
        await new HttpPatchRequest<UpdateStorageItemCommentHttpBody, UpdateStorageItemCommentSuccessHttpResponse>(HttpClient, $"{RequestManager.StorageServer}/StorageItems/Comment").PatchAsync(CommentEdit);
        CommentEdit = null;
    }
    
    private async Task UpdateHiddenComment()
    {
        await new HttpPatchRequest<UpdateStorageItemHiddenCommentHttpBody, UpdateStorageItemHiddenCommentSuccessHttpResponse>(HttpClient, $"{RequestManager.StorageServer}/StorageItems/HiddenComment").PatchAsync(HiddenCommentEdit);
        HiddenCommentEdit = null;
    }

    private async Task OpenArticleDetails(Guid id, string name)
    {
        var parameters = new ModalParameters();
        parameters.Add(nameof(ArticleDetails.Id), id);
        var modal = Modal.Show<ArticleDetails>($"{name}", parameters);
        await modal.Result;
    }
}
