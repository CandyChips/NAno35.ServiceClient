@using Nano35.WebClient.Services
@using Nano35.Contexts.Http.storage
@inject HttpClient HttpClient
@inject RequestManager RequestManager
@inject ISessionProvider SessionProvider
@inject NotificationService NotificationService
@inject HttpGet GetRequest
@inject NavigationManager NavigationManager

<LoadingContent IsLoaded="_isLoaded">
    <EditForm Model="@_model" OnValidSubmit="HandleValidSubmit">
        <DataAnnotationsValidator/>
        <InputField Title="Товар">
            <Controls>
                <RadzenDropDown Data=@(StorageItems.Select(a => new {a.Id, Name = $"{a.Article + " " + a.Condition}"}))
                                TextProperty="Name"
                                ValueProperty="Id"
                                TValue="Guid"
                                @bind-Value="_model.StorageItemId"
                                Style="width: 100%;"
                                FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                FilterOperator="StringFilterOperator.Contains"
                                AllowFiltering="true"
                                Change="@GetAllPlacesOfStorageItem"/>
            </Controls>
            <Validation><ValidationMessage For="@(() => _model.StorageItemId)" /></Validation>
        </InputField>
        <InputField Title="Ячейка на складе">
            <Controls>
                <RadzenDropDown Data=@(Warehouse.Select(a => new {a.Name}))
                                TextProperty="Name"
                                ValueProperty="Name"
                                TValue="string"
                                @bind-Value="_model.PlaceOnStorage"
                                Style="width: 100%;"
                                FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                FilterOperator="StringFilterOperator.Contains"
                                AllowFiltering="true"
                                Change="@PlaceOnStorageChanged"/>
            </Controls>
            <Validation><ValidationMessage For="@(() => _model.PlaceOnStorage)" /></Validation>
        </InputField>
        <InputField Title="Количество">
            <Controls>
                <RadzenNumeric Style="width: 100%;" 
                               Placeholder="@(_maxItems.ToString())"
                               @bind-Value="_model.Count"
                               ShowUpDown="false"
                               Max="@_maxItems"
                               Min="1"/>
            </Controls>
            <Validation><ValidationMessage For="@(() => _model.Count)" /></Validation>
        </InputField>
        <RadzenButton type="submit" Text="Создать" ButtonStyle="ButtonStyle.Primary" Style="width: 100%" />
    </EditForm>
</LoadingContent>

@code
{
    [CascadingParameter] BlazoredModalInstance ModalInstance { get; set; }
    [Parameter] public EventCallback FormSubmitted { get; set; }
    
    private CreateCancellationDetailViewModel _model;
    private List<StorageItemViewModel> StorageItems { get; set; } = new();
    private List<PlaceWithStorageItemOnUnit> Warehouse { get; set; } = new();
    private bool _isLoaded;
    private int _maxItems;

    protected override async Task OnInitializedAsync()
    {
        _model = new CreateCancellationDetailViewModel()
        {
            NewId = Guid.NewGuid(),
            Count = 1
        };
        StorageItems = await GetAllStorageItems();
        _isLoaded = true;
    }

    private async Task GetAllPlacesOfStorageItem()
    {
        await GetRequest.InvokeAsync<GetAllPlacesOfStorageItemOnUnitSuccessHttpResponse>($"Warehouse/PlacesOfStorageItemOnUnit?StorageItemId={_model.StorageItemId}&UnitContainsStorageItemId={await SessionProvider.GetCurrentUnitId()}",
            resp =>
            {
                if (resp.IsSuccess()) {Warehouse = resp.Success.Contains.ToList();}
                else
                {
                    Console.WriteLine(resp.Error);
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
    }
    private async Task HandleValidSubmit() 
    {
        await ModalInstance.CloseAsync(ModalResult.Ok(_model));
    }
    
    private async Task<List<StorageItemViewModel>> GetAllStorageItems()
    {
        var data = new List<StorageItemViewModel>();
        
        await GetRequest.InvokeAsync<GetAllStorageItemsSuccessHttpResponse>($"StorageItems?InstanceId={await SessionProvider.GetCurrentInstanceId()}",
            resp =>
            {
                if (resp.IsSuccess()) {data = resp.Success.Data.ToList();}
                else
                {
                    Console.WriteLine(resp.Error);
                    NavigationManager.NavigateTo("/instance-view");
                }
            });

        return data;
    }

    private async Task PlaceOnStorageChanged() =>
        _maxItems = Warehouse.First(a=> a.Name == _model.PlaceOnStorage).Count;
}
