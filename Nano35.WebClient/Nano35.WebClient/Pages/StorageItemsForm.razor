@using Nano35.WebClient.Services
@using Nano35.HttpContext.storage
@inject HttpClient HttpClient
@inject IRequestManager RequestManager
@inject ISessionProvider SessionProvider 

@if (!_loaded)
{
    <div class="d-flex justify-content-center" style="margin-top: 5rem; margin-bottom: 5rem">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden"></span>
        </div>
    </div>
}
else
{
    <EditForm Model="@Model" OnValidSubmit="Create">
        <DataAnnotationsValidator />

        <InputField Title="Наименование*">
            <Controls>
                <div style="display: flex; width: 100%">
                    <RadzenDropDown Data=@(_articles.Select(a => new {Id = a.Id, Name = $"{a.Category} {a.Brand} {a.Model}"}))
                                    TextProperty="Name"
                                    ValueProperty="Id"
                                    TValue="Guid"
                                    @bind-Value="Model.ArticleId"
                                    Disabled="@(!_articles.Any())"
                                    style="width: 100%;"
                                    AllowClear="true"
                                    Placeholder="Выберите наименование товара"
                                    FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                    FilterOperator="StringFilterOperator.Contains"
                                    AllowFiltering="true"/>
                    <RadzenButton Click="@(_ => OpenCreateArticle())"
                                  Text="Добавить"
                                  ButtonStyle="ButtonStyle.Secondary"/>
                </div>
            </Controls>
            <Validation>
                <ValidationMessage For="@(() => Model.ArticleId)" />
            </Validation>
        </InputField>

        <InputField Title="Состояние*">
            <Controls>
                <RadzenDropDown Data="@(_conditions.Select(a => new {Id = a.Id, Name = a.Name}))"
                                TextProperty="Name"
                                ValueProperty="Id"
                                TValue="Guid"
                                @bind-Value="Model.ConditionId"
                                style="flex: auto;"
                                AllowClear="true"
                                Placeholder="Выберите состояние товара"
                                FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                FilterOperator="StringFilterOperator.Contains"
                                AllowFiltering="true"/>
            </Controls>
            <Validation>
                <ValidationMessage For="@(() => Model.ConditionId)" />
            </Validation>
        </InputField>
                    
        <InputField Title="Комментарий">
            <Controls>
                <RadzenTextBox Style="width: 100%;" 
                               Placeholder="Укажите комментарий к товару"
                               @bind-Value="Model.Comment"/>
            </Controls>
            <Validation>
                <ValidationMessage For="@(() => Model.Comment)" />
            </Validation>
        </InputField>
                    
        <InputField Title="Скрытый комментарий">
            <Controls>
                <RadzenTextBox Style="width: 100%;" 
                               Placeholder="Укажите скрытый комментарий к товару"
                               @bind-Value="Model.HiddenComment"/>
            </Controls>
            <Validation>
                <ValidationMessage For="@(() => Model.HiddenComment)" />
            </Validation>
        </InputField>
                    
        <InputField Title="Закупочная цена">
            <Controls>
                <RadzenNumeric Style="width: 100%;" 
                               Placeholder="0"
                               @bind-Value="Model.RetailPrice"/>
            </Controls>
            <Validation>
                <ValidationMessage For="@(() => Model.RetailPrice)" />
            </Validation>
        </InputField>
                    
        <InputField Title="Цена продажи">
            <Controls>
                <RadzenNumeric Style="width: 100%;" 
                               Placeholder="0"
                               @bind-Value="Model.PurchasePrice"/>
            </Controls>
            <Validation>
                <ValidationMessage For="@(() => Model.PurchasePrice)" />
            </Validation>
        </InputField>
                    
        <InputField Title="Изображения">
            <Controls>
                <div class="custom-file">
                    <InputFile class="custom-file-input" OnChange="@OnInputFileChange" multiple />
                    <label class="custom-file-label"></label>
                </div>
            </Controls>
        </InputField>
        

        @if (_files.Count > 0)
        {
            <div class="card">
                <div class="card-body">
                    <ul>
                        @foreach (var file in _files)
                        {
                            <li>
                                @if (FileUpload(_uploadResults, file.Name, out var result))
                                {
                                    <img src="http://localhost:5006/StorageItems/@result.StoredFileName" alt="Image" style="width: 100px;"/>
                                }
                                else
                                {
                                    <span>
                                        There was an error uploading the file
                                        (Error: @result.ErrorCode).
                                    </span>
                                }
                            </li>
                        }
                    </ul>
                </div>
            </div>
        }
                
        @if (!string.IsNullOrEmpty(Error))
        {
            <div class="alert alert-danger mt-3 mb-0">@Error</div>
        }

        <RadzenButton type="submit"
                      Text="Создать"
                      ButtonStyle="ButtonStyle.Primary"
                      Style="width: 100%" />
    </EditForm>
}

@code
{
    [Parameter] public CreateStorageItemHttpBody Model { get; set; }
    [Parameter] public EventCallback FormSubmitted { get; set; }
    [Parameter] public string Error { get; set; }
    [CascadingParameter] public IModalService Modal { get; set; }
    [CascadingParameter] BlazoredModalInstance ModalInstance { get; set; }
    
    private bool _loaded;
    private List<ArticleViewModel> _articles = new();
    private List<StorageItemConditionViewModel> _conditions = new();
    private IList<File> _files = new List<File>();
    private IList<UploadResult> _uploadResults = new List<UploadResult>();
    private int _maxAllowedFiles = 3;
    private bool _shouldRender;

    protected override async Task OnInitializedAsync()
    {
        _loaded = false;
        _conditions = (await new HttpGetRequest<GetAllStorageItemConditionsSuccessHttpResponse>(HttpClient, $"{RequestManager.StorageServer}/StorageItemConditions").GetAsync()).Data.ToList();
        _articles = (await new HttpGetRequest<GetAllArticlesSuccessHttpResponse>(HttpClient, $"{RequestManager.StorageServer}/Articles?InstanceId={await SessionProvider.GetCurrentInstanceId()}").GetAsync()).Data.ToList();
        _loaded = true;
    }
    
    private async Task Create()
    { 
        await FormSubmitted.InvokeAsync();
        await ModalInstance.CloseAsync();    
    }

    private async Task OpenCreateArticle()
    {
        var moviesModal = Modal.Show<ArticlesCreate>("Новое наименование");
        await moviesModal.Result;
        _articles = (await new HttpGetRequest<GetAllArticlesSuccessHttpResponse>(HttpClient, $"{RequestManager.StorageServer}/Articles?InstanceId={await SessionProvider.GetCurrentInstanceId()}").GetAsync()).Data.ToList();
    }
    
    private async Task OnInputFileChange(InputFileChangeEventArgs e)
    {
        _shouldRender = false;
        long maxFileSize = 1024 * 1024 * 15;
        var upload = false;

        using var content = new MultipartFormDataContent();

        foreach (var file in e.GetMultipleFiles(_maxAllowedFiles))
        {
            if (_uploadResults.SingleOrDefault(
                f => f.FileName == file.Name) is null)
            {
                var fileContent = new StreamContent(file.OpenReadStream());

                _files.Add(
                    new File()
                    {
                        Name = file.Name,
                    });

                if (file.Size < maxFileSize)
                {
                    content.Add(
                        fileContent,
                        "\"files\"",
                        file.Name);

                    upload = true;
                }
                else
                {
                    _uploadResults.Add(
                        new UploadResult()
                        {
                            FileName = file.Name,
                            ErrorCode = 6,
                            Uploaded = false,
                        });
                }
            }
        }

        if (upload)
        {
            var response = await HttpClient.PostAsync($"http://192.168.100.124:5000/Images/CreateStorageItemImage?storageITemId={Model.NewId}", content);

            var newUploadResults = await response.Content
                .ReadFromJsonAsync<IList<UploadResult>>();

            _uploadResults = _uploadResults.Concat(newUploadResults).ToList();
        }

        _shouldRender = true;
    }

    private static bool FileUpload(IList<UploadResult> uploadResults,
        string fileName, out UploadResult result)
    {
        result = uploadResults.SingleOrDefault(f => f.FileName == fileName);

        if (result is null)
        {
            result = new UploadResult();
            result.ErrorCode = 5;
        }

        return result.Uploaded;
    }

    private class File
    {
        public string Name { get; set; }
    }

    public class UploadResult
    {
        public int ErrorCode { get; set; }
        public string StoredFileName { get; set; }
        public string FileName { get; set; }
        public bool Uploaded { get; set; }
    }
}
