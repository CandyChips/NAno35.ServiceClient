@using Nano35.WebClient.Services
@using Nano35.Contexts.Http.storage
@inject RequestManager RequestManager
@inject ISessionProvider SessionProvider 
@inject HttpClient HttpClient 
@inject HealthService HealthService
@inject NavigationManager NavigationManager
@inject HttpGet GetRequest
@inject HttpPost PostRequest

<BoxedContent Width="40">
<LoadingContent IsLoaded="_loaded">    
    <EditForm Model="@_model" OnValidSubmit="HandleValidSubmit">
        <DataAnnotationsValidator />
        <InputField Title="Наименование*">
            <Controls>
                <div style="display: flex; width: 100%">
                    <RadzenDropDown TValue="Guid" @bind-Value="_model.ArticleId"
                                    Data=@(_articles.Select(a => new {a.Id, Name = $"{a.Category} {a.Brand} {a.Model}"}))
                                    TextProperty="Name" ValueProperty="Id"
                                    Disabled="@(!_articles.Any())"
                                    style="width: 100%;"
                                    AllowClear="true"
                                    FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                    FilterOperator="StringFilterOperator.Contains"
                                    AllowFiltering="true"/>
                    <RadzenButton Click="@(_ => OpenCreateArticle())" Text="Добавить" ButtonStyle="ButtonStyle.Secondary"/>
                </div>
            </Controls>
            <Validation><ValidationMessage For="@(() => _model.ArticleId)" /></Validation>
        </InputField>

        <InputField Title="Состояние*">
            <Controls>
                <RadzenDropDown TValue="Guid" @bind-Value="_model.ConditionId"
                                Data="@(_conditions.Select(a => new {a.Id, a.Name}))"
                                TextProperty="Name" ValueProperty="Id"
                                style="flex: auto;"
                                AllowClear="true"
                                FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                FilterOperator="StringFilterOperator.Contains"
                                AllowFiltering="true"/>
            </Controls>
            <Validation>
                <ValidationMessage For="@(() => _model.ConditionId)" />
            </Validation>
        </InputField>
                    
        <InputField Title="Комментарий">
            <Controls><RadzenTextBox Style="width: 100%;" @bind-Value="_model.Comment"/></Controls>
            <Validation><ValidationMessage For="@(() => _model.Comment)" /></Validation>
        </InputField>
                    
        <InputField Title="Скрытый комментарий">
            <Controls><RadzenTextBox Style="width: 100%;" @bind-Value="_model.HiddenComment"/></Controls>
            <Validation><ValidationMessage For="@(() => _model.HiddenComment)" /></Validation>
        </InputField>
                    
        <InputField Title="Закупочная цена">
            <Controls><RadzenNumeric Style="width: 100%;" @bind-Value="_model.RetailPrice"/></Controls>
            <Validation><ValidationMessage For="@(() => _model.RetailPrice)" /></Validation>
        </InputField>
                    
        <InputField Title="Цена продажи">
            <Controls><RadzenNumeric Style="width: 100%;" @bind-Value="_model.PurchasePrice"/></Controls>
            <Validation><ValidationMessage For="@(() => _model.PurchasePrice)" /></Validation>
        </InputField>
                    
        <RadzenUpload @ref="upload"
                      Auto="false"
                      Multiple="true"
                      Url=@($"https://nano35.ru/files/images/CreateStorageItemImage/{_model.NewId}") 
                      Style="margin-bottom: 20px; width: 100%;"
                      Accept="image/*"
                      Progress=@(args => OnProgress(args, "Manual Upload")) />
        <RadzenButton Text="Upload" 
                      Click=@(args => upload.Upload()) 
                      ButtonStyle="ButtonStyle.Secondary"
                      Style="margin-bottom: 20px; width: 100%;" />
        
        @if (progress != 0)
        {
            <RadzenProgressBar @bind-Value="@progress" Style="margin-bottom: 20px" />
        }
                
        @if (!string.IsNullOrEmpty(Error))
        {
            <div class="alert alert-danger mt-3 mb-0">@Error</div>
        }
        
        <RadzenButton type="submit" Text="Создать" ButtonStyle="ButtonStyle.Primary" Disabled="@(progress != 0)" Style="width: 100%" />
    </EditForm>
</LoadingContent>
</BoxedContent>

@code
{
    [CascadingParameter] public IModalService Modal { get; set; }
    [CascadingParameter] BlazoredModalInstance ModalInstance { get; set; }
    private CreateStorageItemHttpBody _model = new();
    private string Error { get; set; } = "";
    private bool _loaded;
    double progress = 0;
    private bool shouldRender;
    private List<ArticleViewModel> _articles = new();
    private List<StorageItemConditionViewModel> _conditions = new();
    private readonly int _maxAllowedFiles = 3;
    RadzenUpload upload;
    
    private async Task HandleValidSubmit()
    {
        _loaded = false;
        try
        {
            if (await HealthService.CheckAsync() == false)
            NavigationManager.NavigateTo("/instance-view");
            
            await PostRequest.InvokeAsync<CreateStorageItemSuccessHttpResponse, CreateStorageItemHttpBody>($"StorageItems", _model,
                resp =>
                {
                    if (resp.IsSuccess()) {}
                    else
                    {
                        Console.WriteLine(resp.Error);
                        NavigationManager.NavigateTo("/instance-view");
                    }
                });
            await ModalInstance.CloseAsync(ModalResult.Ok(_model.NewId));
        }
        catch (Exception e)
        {
            Error = e.Message;
        }
        _loaded = true;
    }
    
    protected override async Task OnInitializedAsync()
    {
        _loaded = false;
        await GetRequest.InvokeAsync<GetAllStorageItemConditionsSuccessHttpResponse>($"StorageItemConditions",
            resp =>
            {
                if (resp.IsSuccess())
                {
                    _conditions = resp.Success.Data.ToList();
                }
                else
                {
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
        
        await GetRequest.InvokeAsync<GetAllArticlesSuccessHttpResponse>($"Articles?InstanceId={await SessionProvider.GetCurrentInstanceId()}",
            resp =>
            {
                if (resp.IsSuccess())
                {
                    _articles = resp.Success.Data.ToList();
                }
                else
                {
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
        _model = new CreateStorageItemHttpBody
        {
            InstanceId = await SessionProvider.GetCurrentInstanceId(),
            NewId = Guid.NewGuid()
        };
        _loaded = true;
    }

    private async Task OpenCreateArticle()
    {
        var modalOpts = new ModalOptions(){DisableBackgroundCancel = true, FocusFirstElement = true};
        var moviesModal = Modal.Show<ArticlesCreateForm>("Новое наименование", modalOpts);
        
        var res = await moviesModal.Result;
        if (!res.Cancelled)
        {
            _model.ArticleId = (Guid) res.Data;
        }
        
        await GetRequest.InvokeAsync<GetAllArticlesSuccessHttpResponse>($"Articles?InstanceId={await SessionProvider.GetCurrentInstanceId()}",
            resp =>
            {
                if (resp.IsSuccess())
                {
                    _articles = resp.Success.Data.ToList();
                }
                else
                {
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
    }
    
    void OnProgress(UploadProgressArgs args, string name)
    {
        this.progress = args.Progress;
        if (args.Progress == 100)
        {
            this.progress = 0;
        }
    }
}
