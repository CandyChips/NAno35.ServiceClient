@attribute [Authorize]
@layout InstanceLayout
@page "/instance/repairs"
@using Microsoft.AspNetCore.Authorization
@using Nano35.Contracts.Repair.Models
@using Nano35.HttpContext.Repair
@using Nano35.WebClient.Helpers
@using Nano35.WebClient.Services
@inject IRequestManager RequestManager
@inject ISessionProvider SessionProvider
@inject HttpClient HttpClient

<LoadingContent IsLoaded="_isLoaded">
    <LoadedContent>
        <RadzenHeading Text="Активные заказы на ремонт"/>
        
        <RadzenButton Click=@(_ => NewOrder()) 
                      Text="Создать"
                      Style="margin: 1rem 0;"
                      ButtonStyle="ButtonStyle.Primary"/>
        
        <RadzenGrid AllowFiltering="true"
                    FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                    FilterMode="FilterMode.Advanced"
                    EmptyText="Нет оприходований."
                    AllowPaging="true"
                    PageSize="10"
                    AllowSorting="true"
                    Data="@_data"
                    TItem="RepairOrderViewModel">
            <Columns>
                <RadzenGridColumn TItem="RepairOrderViewModel"
                                  Bubble="false"
                                  Filterable="false"
                                  Sortable="false"
                                  Title="Статус">
                    <Template Context="item">
                        @RepairOrderStateTypesHelper.GetName(item.CurrentState) - @item.LastStateDate
                    </Template>
                </RadzenGridColumn>
                <RadzenGridColumn TItem="RepairOrderViewModel"
                                  Property="Client"
                                  Filterable="false"
                                  Sortable="false"
                                  Title="Клиент"/>
                <RadzenGridColumn TItem="RepairOrderViewModel"
                                  Property="Device"
                                  Filterable="false"
                                  Sortable="false"
                                  Title="Изделие"/>
                <RadzenGridColumn TItem="RepairOrderViewModel"
                                  Bubble="false"
                                  Filterable="false"
                                  Sortable="false"
                                  TextAlign="TextAlign.Center" 
                                  Width="200px">
                    <Template Context="item">
                        <RadzenButton Click=@(_ => DetailsOpen(item.Id))
                                      Text="Информация"
                                      ButtonStyle="ButtonStyle.Info"/>
                    </Template>
                </RadzenGridColumn>
            </Columns>
        </RadzenGrid>
    </LoadedContent>
</LoadingContent>

@code {
    private bool _isLoaded;
    private List<RepairOrderViewModel> _data;
    [CascadingParameter] BlazoredModalInstance ModalInstance { get; set; }
    [CascadingParameter] public IModalService Modal { get; set; }
    
    protected override async Task OnInitializedAsync()
    {
        _data = await GetAllRepairOrders();
        _isLoaded = true;
    }

    private async Task<List<RepairOrderViewModel>> GetAllRepairOrders() =>
        (await new HttpGetRequest<GetAllRepairOrdersHttpResponse>(HttpClient, $"{RequestManager.RepairOrdersServer}/RepairOrders?InstanceId={await SessionProvider.GetCurrentInstanceId()}").GetAsync()).Data;
    
    private async Task DetailsOpen(Guid id)
    {
        var parameters = new ModalParameters();
        parameters.Add(nameof(RepairOrdersDetail.Id), id);
        var modal = Modal.Show<RepairOrdersDetail>($"Заказ наряд на ремонт", parameters);
        await modal.Result;
        _isLoaded = false;
        _data = await GetAllRepairOrders();
        _isLoaded = true;
    }
    
    private async Task NewOrder()
    {
        var modal = Modal.Show<RepairOrdersCreate>("Новый наряд на ремонт");
        await modal.Result;
        _isLoaded = false;
        _data = await GetAllRepairOrders();
        _isLoaded = true;

    }

}