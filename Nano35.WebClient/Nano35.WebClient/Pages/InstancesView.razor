@using Microsoft.AspNetCore.Authorization
@using Nano35.Contracts.Instance.Models
@using Nano35.HttpContext.instance
@using Nano35.WebClient.Services
@attribute [Authorize]
@page "/instances"
@inject IRequestManager RequestManager
@inject IInstanceService InstanceService 
@inject ISessionProvider SessionProvider
@inject HttpClient HttpClient
@inject HttpGet GetRequest
@inject NavigationManager NavigationManager

<AuthorizeView>
    <CenterContent Width="50">
        <LoadingContent IsLoaded="_loading">
            <RadzenHeading Text="Организации"/>
            <RadzenButton Click=@(_ => NewInstance()) 
                          Text="Создать"
                          Style="margin: 1rem 0;"
                          ButtonStyle="ButtonStyle.Secondary"/>
    
            <RadzenGrid Data=@(_data)
                        EmptyText="..."
                        TItem="InstanceViewModel">
                <Columns>
                    <RadzenGridColumn TItem="InstanceViewModel"
                                      Property="OrgName" 
                                      Title="Название" />
                    <RadzenGridColumn TItem="InstanceViewModel" 
                                      Property="OrgRealName" 
                                      Title="Организация" />
                    <RadzenGridColumn TItem="InstanceViewModel"
                                      Context="order"
                                      Bubble="false"
                                      TextAlign="TextAlign.Center" 
                                      Width="200px">
                        <Template Context="item">
                            <RadzenButton
                                ButtonStyle="ButtonStyle.Primary"
                                Click="@(_ => OpenOrg(item.Id))">
                                Войти
                            </RadzenButton>
                        </Template>
                    </RadzenGridColumn>
                </Columns>
            </RadzenGrid>
        </LoadingContent>
    </CenterContent>
</AuthorizeView>

@code
{
    private bool _loading;
    private IEnumerable<InstanceViewModel> _data;
    [CascadingParameter] public IModalService Modal { get; set; }
    
    protected override async Task OnInitializedAsync()
    {
        _loading = false;
        await GetRequest.InvokeAsync<GetAllInstancesHttpResponse>(
            RequestManager.InstanceServer, $"Instances/Current",
            resp =>
            {
                if (resp.IsSuccess()) {_data = resp.Success.Data;}
                else
                {
                    Console.WriteLine(resp.Error);
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
        
        _loading = true;
    }
    
    private async Task NewInstance()
    {
        var opts = new ModalOptions()
        {
            DisableBackgroundCancel = true,
            FocusFirstElement = true
        };
        var modal = Modal.Show<InstancesCreateForm>("Новая организация", opts);
        await modal.Result;
        _loading = false;
        await GetRequest.InvokeAsync<GetAllInstancesHttpResponse>(
            RequestManager.InstanceServer, $"Instances/Current",
            resp =>
            {
                if (resp.IsSuccess()) {_data = resp.Success.Data;}
                else
                {
                    Console.WriteLine(resp.Error);
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
        _loading = true;
    }

    private async Task OpenOrg(Guid id)
    {
        await InstanceService.SetInstanceById(id);     
        await SessionProvider.SetCurrentInstanceId(id);
        NavigationManager.NavigateTo("/instance-view");
    }
}
