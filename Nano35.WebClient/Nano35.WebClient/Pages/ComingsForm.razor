@using Nano35.HttpContext.storage
@using Nano35.WebClient.Services
@using Nano35.HttpContext.instance
@using Nano35.Contracts.Instance.Models
@using Nano35.WebClient.Helpers
@using Microsoft.AspNetCore.Mvc.Filters
@inject HttpClient HttpClient
@inject IRequestManager RequestManager
@inject ISessionProvider SessionProvider
@inject IAuthService AuthService

<EditForm Model="@(Model)" OnSubmit="Create">
    <DataAnnotationsValidator />
    <ValidationSummary/>
    <LoadingContent IsLoaded="_isLoaded"> 
        <InputField Title="Поставщик*">
            <Controls>
                <div style="display: flex; width: 100%;">
                    <RadzenDropDown Data=@(_clients.Select(a => new {a.Id, Name = $"{a.Name} - {a.Phone}"}))
                                    TextProperty="Name"
                                    ValueProperty="Id"
                                    TValue="Guid"
                                    @bind-Value="Model.ClientId"
                                    Style="width: 100%;"
                                    Disabled="@(!_clients.Any())"
                                    Placeholder="Выберите поставщика..."
                                    FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                    FilterOperator="StringFilterOperator.Contains"
                                    AllowFiltering="true"/>
                    <RadzenButton Click=@(_ => NewClient()) Text="Добавить" ButtonStyle="ButtonStyle.Secondary"/>
                </div>
            </Controls>
            <Validation><ValidationMessage For="@(() => Model.ClientId)" /></Validation>
        </InputField>
        
        <ConditionalContent IsLoaded="_roles.Contains(RolesHelper.Admin) || _roles.Contains(RolesHelper.Manager)">
            <AllowedContent>
                <InputField Title="Подразделение*">
                    <Controls>
                        <RadzenDropDown Data=@(_units.Select(a => new {a.Id, Name = $"{a.Name} - {a.Address}"}))
                                        TextProperty="Name" 
                                        ValueProperty="Id"
                                        TValue="Guid" 
                                        @bind-Value="Model.UnitId"
                                        Disabled="@(!_units.Any())"
                                        Style="width: 100%;"
                                        Placeholder="Выберите целевое подразделение..."
                                        FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" 
                                        FilterOperator="StringFilterOperator.Contains"
                                        AllowFiltering="true"/>
                    </Controls>
                    <Validation><ValidationMessage For="@(() => Model.UnitId)" /></Validation>
                </InputField>
            </AllowedContent>
        </ConditionalContent>

        <InputField Title="Комментарий">
                <Controls>
                    <RadzenTextBox Style="width: 100%;" @bind-Value="Model.Comment"/>
                </Controls>
                <Validation><ValidationMessage For="@(() => Model.Comment)" /></Validation>
            </InputField>
        
            <RadzenFieldset Text="Оприходуемые товары">           
                
            
                <RadzenGrid Data="@_details" EmptyText="Добавте оприходуемые товары..."TItem="CreateComingDetailViewModel">
                    <Columns>
                        <RadzenGridColumn TItem="CreateComingDetailViewModel" Property="PlaceOnStorage" Title="Товар" />
                        <RadzenGridColumn TItem="CreateComingDetailViewModel" Property="PlaceOnStorage" Title="Место на складе" />
                        <RadzenGridColumn TItem="CreateComingDetailViewModel" Property="Count" Title="Количество" />
                        <RadzenGridColumn TItem="CreateComingDetailViewModel" Property="Price" Title="Цена" />
                        <RadzenGridColumn TItem="CreateComingDetailViewModel" Context="order" Bubble="false" TextAlign="TextAlign.Center">
                            <Template Context="item">
                                <RadzenButton ButtonStyle="ButtonStyle.Danger" Icon="close" Size="ButtonSize.Small"></RadzenButton>
                                <a href="https://nano35.ru/api/Docs/StorageItems/GenerateTicket?storageItemId=@item.StorageItemId" target="_blank">Этикетка</a>
                            </Template>
                        </RadzenGridColumn>
                    </Columns>
                </RadzenGrid>
                <RadzenButton Click=@(_ => AddDetail()) Text="Добавить изделия" ButtonStyle="ButtonStyle.Secondary" Style="width: 100%" />
            </RadzenFieldset>
            <ValidationMessage For="@(() => Model.Details)" />
    </LoadingContent>
    @if (!string.IsNullOrEmpty(Error))
    {
        <div class="alert alert-danger mt-3 mb-0">@Error</div>
    }
    <RadzenButton type="submit" Text="Создать" ButtonStyle="ButtonStyle.Primary" Style="width: 100%; margin-top: 1rem;" />
</EditForm>

@code
{
    [Parameter] public CreateComingHttpBody Model { get; set; }
    [Parameter] public EventCallback FormSubmitted { get; set; }
    [Parameter] public string Error { get; set; }
    [CascadingParameter] public IModalService Modal { get; set; }
    [CascadingParameter] BlazoredModalInstance ModalInstance { get; set; }
    private List<Guid> _roles = new();

    private List<ClientViewModel> _clients = new();
    private List<UnitViewModel> _units = new();
    private List<CreateComingDetailViewModel> _details = new();
    
    private bool _isLoaded;

    private async Task Create()
    {
        await FormSubmitted.InvokeAsync();
        await ModalInstance.CloseAsync();
    }

    private async Task AddComingDetail(CreateComingDetailViewModel model)
    {
        _details.Add(model);
    }
    
    protected override async Task OnInitializedAsync()
    {
        _isLoaded = false;
        _roles = await AuthService.GetCurrentRoles();
        _clients = await LoadClients();
        _units = await LoadUnits();
        Model.NewId = Guid.NewGuid();
        Model.UnitId = await SessionProvider.GetCurrentUnitId();
        Model.InstanceId = await SessionProvider.GetCurrentInstanceId();
        _isLoaded = true;
    }
    
    private async Task<List<ClientViewModel>> LoadClients() => 
        (await new HttpGetRequest<GetAllClientsHttpResponse>(HttpClient, 
            $"{RequestManager.InstanceServer}/Clients?InstanceId={await SessionProvider.GetCurrentInstanceId()}").GetAsync()).Data.ToList();

    private async Task<List<UnitViewModel>> LoadUnits() => 
        (await new HttpGetRequest<GetAllUnitsHttpResponse>(HttpClient, 
            $"{RequestManager.InstanceServer}/Units?InstanceId={await SessionProvider.GetCurrentInstanceId()}").GetAsync()).Units.ToList();
    
    private async Task AddDetail()
    {
        var modalOpts = new ModalOptions()
        {
            DisableBackgroundCancel = true, FocusFirstElement = true
        };
        var modal = Modal.Show<ComingsDetailForm>($"Новая позиция к оприходованию", modalOpts);
        var result = await modal.Result;
        
        if (result.Data is CreateComingDetailViewModel success)
        {
            Model.Details ??= new List<CreateComingDetailViewModel>();
            Model.Details.Add((CreateComingDetailViewModel) (result).Data);
            _details.Add(success);
        }
    }
    
    private async Task NewClient()
    {
        var modalOpts = new ModalOptions()
        {
            DisableBackgroundCancel = true, FocusFirstElement = true
        };
        var modal = Modal.Show<ClientsCreate>($"Новый клиент", modalOpts);
        var res = await modal.Result;
        if (!res.Cancelled)
        {
            Model.ClientId = (Guid) res.Data;
        }

        _clients = await LoadClients();
        
    }
        
}
