@using Nano35.HttpContext.storage
@using Nano35.WebClient.Services
@using Nano35.Contracts.Storage.Models
@using ArticleViewModel = Nano35.HttpContext.storage.ArticleViewModel
@using Nano35.Contracts.Storage.Artifacts
@inject HttpClient HttpClient
@inject IRequestManager RequestManager
@inject ISessionProvider SessionProvider


<LoadingContent IsLoaded="_isLoaded">
    <LoadedContent>
    <FieldList Title="Информация">
        <FieldListItem Title="Категория">
            <EditableField OnCancel="@(() => CategoryEdit = null)"
                           OnEdit="@(() => CategoryEdit = new UpdateArticleCategoryHttpBody(){Id = Article.Id})"
                           OnSave="@(() => UpdateCategory())">
                <View><p>@Article.Category</p></View>
                <Edit>
                    <RadzenDropDown style="display: flex;"
                                    AllowClear="true"
                                    TValue="Guid"
                                    Data=@(Categories.Select(g => new {g.Id, g.Name}))
                                    TextProperty="Name"
                                    ValueProperty="Id"
                                    @bind-Value="CategoryEdit.CategoryId">
                        <Template Context="data">
                            <div style="display: flex; flex-direction: row">
                                <div style="width: 90%;">@(data.Name)</div>
                                <RadzenButton 
                                    Click="@(_ => OpenCategoryDetails(Categories.First(h=> h.Id == data.Id), data.Name))"
                                    Size="ButtonSize.Small"
                                    Text="🖉"
                                    Style="height: 20px; display: flex; padding-left: revert; padding-right: revert; align-items: center;"/>
                            </div>
                        </Template>
                    </RadzenDropDown>
                </Edit>
            </EditableField>
        </FieldListItem>
    </FieldList>
    <RadzenFieldset Text="Информация"
                    Style="width: 100%;">
        <ul class="list-group" >
            <li class="list-group-item" role="alert" style="width: 100%; display: flex;">
                @if (CategoryEdit == null)
                {
                    <b style="display: flex;  width: 85%; align-items: center">Категория: @Article.Category</b>
                                                    
                    <RadzenButton Click="@(_ => CategoryEdit = new UpdateArticleCategoryHttpBody(){Id = Article.Id})"
                                  Text="Изменить"
                                  Size="ButtonSize.Small"
                                  Style=" float: right; display: flex "
                                  ButtonStyle="ButtonStyle.Secondary"/>
                }
                else
                {
                    <EditForm Model="@CategoryEdit"
                              OnValidSubmit="@UpdateCategory"
                              style="display: flex;
                              width: 100%;">
                <b style="display: flex; 
                        width: 85%; 
                        align-items: center; 
                        height: 50px;
                        margin-top: 5px;"> 
                    <InputField Title="Категория:">
                        <Controls>
                            <RadzenDropDown style="display: flex; "
                                            AllowClear="true"
                                            TValue="Guid"
                                            Data=@(Categories.Select(g => new {Id = g.Id, Name = g.Name}))
                                            TextProperty="Name"
                                            ValueProperty="Id"
                                            @bind-Value="CategoryEdit.CategoryId">
                                <Template Context="data">
                                    <div style="display: flex; flex-direction: row">
                                        <div style="width: 90%;">@(data.Name)</div>
                                        <RadzenButton 
                                            Click="@(_ => OpenCategoryDetails(Categories.First(h=> h.Id == data.Id), data.Name))"
                                            Size="ButtonSize.Small"
                                            Text="🖉"
                                            Style="height: 20px;
                                                    display: flex;
                                                    padding-left: revert;
                                                    padding-right: revert;
                                                    align-items: center;"/>
                                    </div>
                                </Template>
                            </RadzenDropDown>
                        </Controls>
                    </InputField>
                </b>
                
                    <DataAnnotationsValidator/>
                <ValidationSummary/>
                
                    <div style="display: flex; align-items: center">
                        <RadzenButton type="submit"
                                      Text="Обновить"
                                      Size="ButtonSize.Small"
                                      Style="display: flex; 
                                             align-items: center;
                                             height: 28px; 
                                             margin-right: 25px; 
                                             width: min-content;"
                                      ButtonStyle="ButtonStyle.Secondary"/>
                        
                        <RadzenButton Click=@(_ => CategoryEdit = null)
                                  ButtonStyle="ButtonStyle.Danger"
                                  Icon="close"
                                  Style="height: 40px; width: 40px"
                                  Size="ButtonSize.Small"/>
                    </div>
                    </EditForm>
                }
            </li>
            <li class="list-group-item" role="alert" style="width: 100%; display: flex;">
                @if (BrandEdit == null)
                {
                    <b style="display: flex; width: 85%; align-items: center">Бренд: @Article.Brand</b>
                                                    
                    <RadzenButton Click="@(_ => BrandEdit = new UpdateArticleBrandHttpBody(){Id = Article.Id})"
                                  Text="Изменить"
                                  Size="ButtonSize.Small"
                                  Style=" float: right; display: flex "
                                  ButtonStyle="ButtonStyle.Secondary"/>
                }
                else
                {
                    <EditForm Model="@BrandEdit"
                           OnValidSubmit="@UpdateBrand"
                           style="display: flex;
                           width: 100%;">
                     <b style="display: flex; width: 85%; align-items: center; height: 50px; margin-top: 5px;">
                         <InputField Title="Бренд:">
                             <Controls>
                                 <RadzenTextBox style="display: flex;align-items: center"
                                                @bind-Value="BrandEdit.Brand"
                                                Placeholder="@Article.Brand"/>


                             </Controls>
                         </InputField>
                     </b>

                     <DataAnnotationsValidator/>
                     <ValidationSummary/>

                     <div style="display: flex; align-items: center">
                         <RadzenButton type="submit"
                                       Text="Обновить"
                                       Size="ButtonSize.Small"
                                       Style="display: flex; 
                                             align-items: center;
                                             height: 28px; 
                                             margin-right: 25px; 
                                             width: min-content;"
                                       ButtonStyle="ButtonStyle.Secondary"/>
                         <RadzenButton Click=@(_ => BrandEdit = null)
                                       ButtonStyle="ButtonStyle.Danger"
                                       Icon="close"
                                       Style="height: 40px; width: 40px"
                                       Size="ButtonSize.Small"/>
                     </div>
                 </EditForm>
                }
            </li>
            <li class="list-group-item" role="alert" style="width: 100%; display: flex;">
                @if (ModelEdit == null)
                {
                    <b style="display: flex;  width: 85%; align-items: center">Модель: @Article.Model</b>
                                                    
                    <RadzenButton Click="@(_ => ModelEdit = new UpdateArticleModelHttpBody()
                                         {
                                             Id = Article.Id
                                         })"
                                  Text="Изменить"
                                  Size="ButtonSize.Small"
                                  Style=" float: right; display: flex "
                                  ButtonStyle="ButtonStyle.Secondary"/>
                }
                else
                {
                    <EditForm Model="@ModelEdit"
                              OnValidSubmit="@UpdateModel"
                              style="display: flex;
                              width: 100%;">
                        <b style="display: flex; 
                           width: 85%; 
                           align-items: center; 
                           height: 50px;
                           margin-top: 5px;"> 
                            <InputField Title="Модель:">
                                <Controls>
                                    <RadzenTextBox style="display: flex;align-items: center"
                                                   @bind-Value="ModelEdit.Model"
                                                   Placeholder="@Article.Model"/>
                            
                            
                                </Controls>
                            </InputField>
                        </b>
                        <DataAnnotationsValidator/>
                        <ValidationSummary/>
                        <div style="display: flex; align-items: center">
                            <RadzenButton type="submit"
                                          Text="Обновить"
                                          Size="ButtonSize.Small"
                                          Style="display: flex; 
                                             align-items: center;
                                             height: 28px; 
                                             margin-right: 25px; 
                                             width: min-content;"
                                          ButtonStyle="ButtonStyle.Secondary"/>
                        
                            <RadzenButton Click=@(_ => ModelEdit = null)
                                          ButtonStyle="ButtonStyle.Danger"
                                          Icon="close"
                                          Style="height: 40px; width: 40px"
                                          Size="ButtonSize.Small"/>
                        </div>
                    </EditForm>
                }
            </li>
            <li class="list-group-item" role="alert" style="width: 100%; display: flex;">
                @if (InfoEdit == null)
                {
                    <b style="display: flex;  width: 85%; align-items: center">Информация: @Article.Info</b>
                                                    
                    <RadzenButton Click="@(_ => InfoEdit = new UpdateArticleInfoHttpBody()
                                         {
                                             Id = Article.Id
                                         })"
                                  Text="Изменить"
                                  Size="ButtonSize.Small"
                                  Style=" float: right; display: flex "
                                  ButtonStyle="ButtonStyle.Secondary"/>
                }
                else
                {
                    <EditForm Model="@InfoEdit"
                              OnValidSubmit="@UpdateInfo"
                              style="display: flex;
                              width: 100%;">
                    
                        <b style="display: flex; 
                                  width: 85%; 
                                  align-items: center; 
                                  height: 50px;
                                  margin-top: 5px;">
                            <InputField Title="Информация:">
                                <Controls>
                                    <RadzenTextBox style="display: flex;align-items: center"
                                                   @bind-Value="InfoEdit.Info"
                                                   Placeholder="@Article.Info"/>
                            
                            
                                </Controls>
                            </InputField>
                        </b>
                    
                        <DataAnnotationsValidator/>
                        <ValidationSummary/>

                        <div style="display: flex; align-items: center">
                            <RadzenButton type="submit"
                                          Text="Обновить"
                                          Size="ButtonSize.Small"
                                          Style="display: flex; align-items: center;height: 40px; margin-right: 25px;"
                                          ButtonStyle="ButtonStyle.Secondary"/>
                            <RadzenButton Click=@(_ => InfoEdit = null)
                                          ButtonStyle="ButtonStyle.Danger"
                                          Icon="close"
                                          Style="display: flex; 
                                             align-items: center;
                                             height: 28px; 
                                             margin-right: 25px; 
                                             width: min-content;"
                                          Size="ButtonSize.Small"/>
                        </div>
                    </EditForm>
                }
            </li>
        </ul>
    </RadzenFieldset>
    
    <RadzenFieldset Text="Характеристики"
                    Style="width: 60rem">
        <RadzenGrid Data="@(Article.Specs)"
                    EmptyText="Нет указаных характеристик"
                    TItem="SpecHttpContext">
            <Columns>
                <RadzenGridColumn TItem="SpecHttpContext"
                                  Property="Key"
                                  Title="Характеристика"/>
                <RadzenGridColumn TItem="SpecHttpContext"
                                  Property="Value"
                                  Title="Значение"/>
            </Columns>
        </RadzenGrid>
    </RadzenFieldset>
    </LoadedContent>
</LoadingContent>

@code
{
    [CascadingParameter] public IModalService Modal { get; set; }
    [CascadingParameter] BlazoredModalInstance ModalInstance { get; set; }

    [Parameter] public Guid Id { get; set; }
    private ArticleViewModel Article { get; set; } = new ();
    
    private List<ArticleCategoryViewModel> Categories { get; set; }
    
    private UpdateArticleInfoHttpBody InfoEdit { get; set; }
    private UpdateArticleModelHttpBody ModelEdit { get; set; }
    private UpdateArticleCategoryHttpBody CategoryEdit { get; set; }
    private UpdateArticleBrandHttpBody BrandEdit { get; set; }
    private bool _isLoaded;

    
    protected override async Task OnInitializedAsync()
    {
        _isLoaded = false;
        Article = (await new GetArticleByIdRequest(
            RequestManager,
            HttpClient, 
            new GetArticleByIdHttpQuery() {Id = Id}
            ).Send()).Data;
        
        Categories = (await new GetAllArticleCategoriesRequest(
            RequestManager,
            HttpClient, 
            new GetAllArticlesCategoriesHttpQuery(){InstanceId = await SessionProvider.GetCurrentInstanceId(),ParentId = Guid.Parse("F50EBC56-3D91-481C-8F61-16E47555B136")}
            ).Send()).Data;

        _isLoaded = true;
    }


    private async Task UpdateCategory() {await new UpdateArticleCategoryRequest(RequestManager, HttpClient, CategoryEdit).Send();CategoryEdit = null;}
    
    private async Task UpdateBrand(){await new UpdateArticleBrandRequest(RequestManager, HttpClient, BrandEdit).Send();BrandEdit = null;}
    
    private async Task UpdateModel(){await new UpdateArticleModelRequest(RequestManager, HttpClient, ModelEdit).Send();ModelEdit = null;}
    
    private async Task UpdateInfo(){await new UpdateArticleInfoRequest(RequestManager, HttpClient, InfoEdit).Send();ModelEdit = null;
    }
    private async Task OpenCategoryDetails(ArticleCategoryViewModel item, string name)
    {
        var parameters = new ModalParameters();
        parameters.Add(nameof(CategoryDetails.Category), item);
        var modal = Modal.Show<CategoryDetails>($"{name}", parameters);
        await modal.Result;
    }
}
