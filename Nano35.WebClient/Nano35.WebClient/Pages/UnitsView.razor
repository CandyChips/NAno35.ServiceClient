@using Microsoft.AspNetCore.Authorization
@using Nano35.Contexts.Http.Instance
@using Nano35.Contracts.Instance.Models
@using Nano35.WebClient.Helpers
@using Nano35.WebClient.Services
@attribute [Authorize]
@layout InstanceLayout
@inject NavigationManager NavigationManager
@inject RequestManager RequestManager;
@inject IInstanceService InstanceService;
@inject ISessionProvider SessionProvider;
@inject IAuthService AuthService
@inject HttpGet GetRequest
@page "/instance/units"

<LoadingContent IsLoaded="_loading">
    <RadzenTabs>
        <Tabs>
            <RadzenTabsItem Text="Текущее подразделение">
                <UnitsDetailsView></UnitsDetailsView>
            </RadzenTabsItem>
            <RadzenTabsItem Text="Все подразделения">
                <RadzenButton Click=@(_ => NewUnit()) 
                              Text="Создать"
                              Style="margin: 1rem 0;"
                              ButtonStyle="ButtonStyle.Primary"/>
                        
                <RadzenGrid EmptyText="Добавте подразделения организации..."
                            AllowPaging="true"
                            PageSize="8"
                            Data="@_data"
                            TItem="UnitViewModel">
                    <Columns>
                        <RadzenGridColumn TItem="UnitViewModel" Property="Name" Title="Название" />
                        <RadzenGridColumn TItem="UnitViewModel" Property="Address" Title="Адресс" />
                        <RadzenGridColumn TItem="UnitViewModel" Property="Phone" Title="Телефон" />
                        <RadzenGridColumn TItem="UnitViewModel" Property="WorkingFormat" Title="Формат работы" />
                        @if (_roles.Contains(RolesHelper.Manager) || _roles.Contains(RolesHelper.Admin)){
                            <RadzenGridColumn TItem="UnitViewModel"  Bubble="false" TextAlign="TextAlign.Center">
                                <Template Context="item">
                                    <RadzenButton Click=@(_ => OpenUnit(item)) Text="Изменить" ButtonStyle="ButtonStyle.Secondary"/>
                                </Template>
                            </RadzenGridColumn>
                        }
                    </Columns>
                </RadzenGrid>
            </RadzenTabsItem>
        </Tabs>
    </RadzenTabs>
</LoadingContent>

@code
{
    [CascadingParameter] BlazoredModalInstance ModalInstance { get; set; }
    [CascadingParameter] public IModalService Modal { get; set; }
    private List<UnitViewModel> _data = new();
    private bool _loading;
    private List<Guid> _roles = new();
    
    protected override async Task OnInitializedAsync()
    {
        _loading = false;
        _data = await GetAllUnits();
        _roles = await AuthService.GetCurrentRoles();
        _loading = true;
    }
    
    private async Task<List<UnitViewModel>> GetAllUnits()
    {
        var data = new List<UnitViewModel>(); 
        await GetRequest.InvokeAsync<GetAllUnitsHttpResponse>($"Units?InstanceId={await SessionProvider.GetCurrentInstanceId()}",
            resp =>
            {
                if (resp.IsSuccess()) {data = resp.Success.Units.ToList();}
                else {NavigationManager.NavigateTo("/instance-view");}
            });
        return data;
    }
    
    private async Task NewUnit()
    {
        var modalOpts = new ModalOptions(){DisableBackgroundCancel = true, FocusFirstElement = true};
        var modal = Modal.Show<UnitsCreateForm>("Новое подразделение", modalOpts);
        await modal.Result;
        _loading = false;
        _data = await GetAllUnits();
        _roles = await AuthService.GetCurrentRoles();
        _loading = true;
    }

    private async Task OpenUnit(IUnitViewModel value)
    {
        var modalOpts = new ModalOptions(){DisableBackgroundCancel = true, FocusFirstElement = true};
        var parameters = new ModalParameters();
        parameters.Add(nameof(UnitDetails.Unit), value);
        var modal = Modal.Show<UnitDetails>($"{value.Name}", parameters, modalOpts);
        await modal.Result;
        _loading = false;
        _data = await GetAllUnits();
        _roles = await AuthService.GetCurrentRoles();
        _loading = true;
    }
}
