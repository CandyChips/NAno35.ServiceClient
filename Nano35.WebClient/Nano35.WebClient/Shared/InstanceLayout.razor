@using Nano35.WebClient.Services
@using Nano35.WebClient.Pages
@using Nano35.WebClient.Helpers
@inherits LayoutComponentBase
@inject NavigationManager NavigationManager
@layout MainLayout
@inject  ISessionProvider SessionProvider
@inject  IRequestManager RequestManager
@inject  IInstanceService InstanceService
@inject IAuthService AuthService

<LoadingContent IsLoaded="_loading">
    <div class="page">
        <div class="sidebar bg-dark">
            <NavMenu/>
        </div>
        <div class="main" style="margin: 1rem;">
            @Body
        </div>
    </div>
</LoadingContent>

@code
{
    [CascadingParameter] public IModalService Modal { get; set; }
    private bool _serverAvailable = false;
    private bool _loading;
    private List<Guid> _roles = new();
        
    protected override async Task OnInitializedAsync()
    {
        _loading = false;
        _roles = await AuthService.GetCurrentRoles();
        _serverAvailable = await RequestManager.HealthCheck(RequestManager.InstanceServer);
        if(!_serverAvailable)
            NavigationManager.NavigateTo("/instances");
        if(!await SessionProvider.IsCurrentSessionIdExist())
            NavigationManager.NavigateTo("/instances");
        await InstanceService.IsInstanceExist();

        if (await SessionProvider.GetCurrentUnitId() == Guid.Empty)
        {
            var modalOpts = new ModalOptions()
            {
                DisableBackgroundCancel = true, FocusFirstElement = true, HideCloseButton = true
            };
            var modal = Modal.Show<SelectCurrentUnit>("Выберите текущее подразделение.", modalOpts);
            var result = await modal.Result;
            await SessionProvider.SetCurrentUnitId((Guid) result.Data);
        }
        _loading = true;
    }
}
