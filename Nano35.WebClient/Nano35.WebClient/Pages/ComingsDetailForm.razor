@using Nano35.WebClient.Services
@using Nano35.HttpContext.storage
@using System.Text.RegularExpressions
@inject HttpClient HttpClient
@inject IRequestManager RequestManager
@inject ISessionProvider SessionProvider
@inject NotificationService NotificationService
@inject NavigationManager NavigationManager
@inject HttpGet GetRequest

<BoxedContent Width="40">
    <LoadingContent IsLoaded="_isLoaded">
        <EditForm Model="@_model" OnValidSubmit="HandleValidSubmit">
            <DataAnnotationsValidator/>
            <InputField Title="Товар">
                <Controls>
                    <div style="display: flex; width: 100%">
                        <RadzenDropDown Data=@(StorageItems.Select(a => new {Id = a.Id, Name = $"{a.Article + " " + a.Condition}"}))
                                        TextProperty="Name"
                                        ValueProperty="Id"
                                        TValue="Guid"
                                        @bind-Value="_model.StorageItemId"
                                        Style="width: 100%;"
                                        Disabled="@(!StorageItems.Any())"
                                        FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                        FilterOperator="StringFilterOperator.Contains"
                                        AllowFiltering="true"
                                        Change="StorageItemChanged"/>
                        <RadzenButton Click=@(_ => OpenCreateStorageItem()) Text="Добавить" ButtonStyle="ButtonStyle.Secondary"/>
                    </div>
                </Controls>
                <Validation><ValidationMessage For="@(() => _model.StorageItemId)" /></Validation>
            </InputField>
            <ConditionalContent IsLoaded="Warehouse.Any()">
                <AllowedContent>
                    <InputField Title="Ячейка на складе">
                        <Controls>
                            <RadzenDropDown Data=@(Warehouse.Select(a => new { Name = a.Name}))
                                            TextProperty="Name"
                                            ValueProperty="Name"
                                            TValue="string"
                                            @bind-Value="_model.PlaceOnStorage"
                                            Style="width: 100%;"
                                            Disabled="@(!StorageItems.Any())"
                                            Placeholder="Выберите из доступных ячеек"
                                            FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                            FilterOperator="StringFilterOperator.Contains"
                                            AllowFiltering="true"/>
                        </Controls>
                        <Validation><ValidationMessage For="@(() => _model.PlaceOnStorage)" /></Validation>
                    </InputField>
                </AllowedContent>
                <RejectedContent>
                    <InputField Title="Ячейка на складе">
                        <Controls><RadzenTextBox style="display: flex; width: 100%" @bind-Value="_model.PlaceOnStorage" Placeholder="Введите название новой ячейки"/></Controls>
                        <Validation><ValidationMessage For="@(() => _model.PlaceOnStorage)" /></Validation>
                    </InputField>
                </RejectedContent>
            </ConditionalContent>
            <InputField Title="Количество">
                <Controls> <RadzenTextBox Style="width: 100%;" @bind-Value="Count" Change="( () => CountCanged())" /> </Controls>
                <Validation><ValidationMessage For="@(() => _model.Count)" /></Validation>
            </InputField>

            <InputField Title="Цена за еденицу">
                <Controls><RadzenTextBox style="width: 100%;" @bind-Value="Price" Change="( () => PriceCanged())" /></Controls>
                <Validation><ValidationMessage For="@(() => _model.Price)" /></Validation>
            </InputField>
            
            <RadzenButton type="submit" Text="Создать" ButtonStyle="ButtonStyle.Primary" Style="width: 100%" />
        </EditForm>
    </LoadingContent>
</BoxedContent>

@code
{
    // <RadzenTextBox style="width: 100%;" @bind-Value="_model.Price" ShowUpDown="true" Min="1"/>
    // <input style="width: 100%" type="number" @bind="_model.Count" min="1" />
    
    [CascadingParameter] public IModalService Modal { get; set; }
    [CascadingParameter] BlazoredModalInstance ModalInstance { get; set; }
    [Parameter] public EventCallback FormSubmitted { get; set; }
    private CreateComingDetailViewModel _model = new();
    private List<StorageItemViewModel> StorageItems { get; set; }
    private List<PlaceWithStorageItemOnUnit> Warehouse { get; set; } = new();
    private bool _isLoaded;
    private string Price;
    private string Count;

    protected override async Task OnInitializedAsync()
    {
        _model = new CreateComingDetailViewModel()
        {
            NewId = Guid.NewGuid(),
            Count = 1,
            
        };
        StorageItems = await GetAllStorageItems();
        _isLoaded = true;
    }

    private async Task HandleValidSubmit() 
    {
        await ModalInstance.CloseAsync(ModalResult.Ok(_model));
    }

    private async Task OpenCreateStorageItem()
    {
        var modalOpts = new ModalOptions(){DisableBackgroundCancel = true, FocusFirstElement = true};
        var moviesModal = Modal.Show<StorageItemsCreateForm>("Новое изделие", modalOpts);
        await moviesModal.Result;
        StorageItems = await GetAllStorageItems();
    }
    
    private async Task<List<StorageItemViewModel>> GetAllStorageItems()
    {
        var data = new List<StorageItemViewModel>();
        await GetRequest.InvokeAsync<GetAllStorageItemsSuccessHttpResponse>(
            RequestManager.StorageServer, $"StorageItems?InstanceId={await SessionProvider.GetCurrentInstanceId()}",
            resp =>
            {
                if (resp.IsSuccess()) {data = resp.Success.Data.ToList();}
                else
                {
                    Console.WriteLine(resp.Error);
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
        return data;
    }

    private async Task StorageItemChanged()
    {
        _model.PlaceOnStorage = "";
        await GetRequest.InvokeAsync<GetAllPlacesOfStorageItemOnUnitSuccessHttpResponse>(
            RequestManager.StorageServer, $"Warehouse/PlacesOfStorageItemOnUnit?StorageItemId={_model.StorageItemId}&UnitContainsStorageItemId={await SessionProvider.GetCurrentUnitId()}",
            resp =>
            {
                if (resp.IsSuccess()) {Warehouse = resp.Success.Contains.ToList();}
                else
                {
                    Console.WriteLine(resp.Error);
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
        
        _model.Price = (double) StorageItems.FirstOrDefault(a=> a.Id == _model.StorageItemId).PurchasePrice;
    }

    private async Task PriceCanged()
    {
        double.TryParse(Regex.Replace(Price, @"[^\d]", ""), out var res);
        _model.Price = res;
    }

    private async Task CountCanged()
    {
        int.TryParse(Regex.Replace(Count, @"[^\d]", ""), out var res);
        _model.Count = res;
    }
}
