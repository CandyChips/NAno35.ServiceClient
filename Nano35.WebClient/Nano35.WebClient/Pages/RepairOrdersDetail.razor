@using Nano35.WebClient.Services
@using Nano35.HttpContext.Repair
@using Nano35.WebClient.Helpers
@using Nano35.HttpContext.instance
@using Nano35.Contracts.Repair.Artifacts
@using Nano35.Contracts.Repair.Models
@using Nano35.HttpContext.storage
@inject HttpClient HttpClient
@inject IRequestManager RequestManager
@inject ISessionProvider SessionProvider
@inject IAuthService AuthService
@inject NotificationService NotificationService

<LoadingContent IsLoaded="_isLoaded">
    
    <div style="width: 60rem; height: 40rem; overflow-y: scroll;">
        @if (_states.Select(e => e.Type).Contains((int) RepairOrderStateType.Completed) &&
             !_states.Select(e => e.Type).Contains((int) RepairOrderStateType.Closed) &&
             _roles.Any(c => c == RolesHelper.Manager || c == RolesHelper.Admin))
        {
            <RadzenButton
                          Text="Закрыть заказ наряд и напечатать акт выполненых работ"
                          Style="width: 100%;"
                          ButtonStyle="ButtonStyle.Danger"/>
        }
        <div style="display: flex;">
            <RadzenFieldset Text="Информация"
                            Style="width: 100%;">
                <ul class="list-group">
                    <li class="list-group-item">
                        <b>Клиент: @_model.Client</b>
                    </li>
                    <li class="list-group-item">
                        <b>Менеджер: @_model.Manager</b>
                    </li>
                    <li class="list-group-item" style="width: 100%; display: flex;">
                        <b style="display: flex;  width: 85%; align-items: center">Устройство: @_model.Device</b>
                    </li>
                <li class="list-group-item" style="width: 100%; display: flex;">
                    <ConditionalContent IsLoaded="@(TroubleEdit == null)">
                        <AllowedContent>
                            
                        </AllowedContent>
                        <RejectedContent>
                            
                        </RejectedContent>
                    </ConditionalContent>
                    @if (TroubleEdit == null)
                    {
                        <b style="display: flex;  width: 85%; align-items: center">Неисправность со слов клиента: @_model.Trouble</b>

                        <RadzenButton Click="@(_ => TroubleEdit = new UpdateRepairOrdersTroubleHttpBody() { RepairOrderId = _model.Id })"
                                      Text="Изменить"
                                      Size="ButtonSize.Small"
                                      Style="float: right; 
                                                 display: flex; 
                                                 padding-left: 10px;
                                                 padding-right: 10px;"
                                      ButtonStyle="ButtonStyle.Secondary"/>
                    }
                    else
                    {
                        <EditForm Model="@TroubleEdit"
                                  OnValidSubmit="@UpdateTrouble"
                                  style="display: flex;
                                             width: 100%;">
                            <b style="display: flex; 
                                      width: 85%; 
                                      align-items: center; 
                                      height: 50px;
                                      margin-top: 5px;">
                                <InputField Title="Неисправность со слов клиента:">
                                    <Controls><RadzenTextBox style="display: flex; align-items: center" @bind-Value="TroubleEdit.Trouble" Placeholder="@_model.Trouble"/></Controls>
                                </InputField>
                            </b>

                            <DataAnnotationsValidator/>
                            <ValidationSummary/>

                            <div style="display: flex; align-items: center">
                                <RadzenButton type="submit"
                                              Text="Обновить"
                                              Size="ButtonSize.Small"
                                              Style="display: flex; align-items: center; height: 28px; margin-right: 25px; width: min-content;"
                                              ButtonStyle="ButtonStyle.Secondary"/>
                                <RadzenButton Click=@(_ => TroubleEdit = null)
                                              ButtonStyle="ButtonStyle.Danger"
                                              Icon="close"
                                              Style=""
                                              Size="ButtonSize.Small"/>
                            </div>
                        </EditForm>
                    }
                </li>
                    <li class="list-group-item" style="width: 100%; display: flex;">
                        <ConditionalContent IsLoaded="@(ConditionEdit == null)">
                            <AllowedContent>
                                
                            </AllowedContent>
                            <RejectedContent>
                                
                            </RejectedContent>
                        </ConditionalContent>
                        @if (ConditionEdit == null)
                        {
                            <b style="display: flex;  width: 85%; align-items: center">Внешний вид: @_model.Condition</b>
                                                               
                            <RadzenButton Click="@(_ => ConditionEdit = new UpdateRepairOrdersConditionHttpBody()
                                                 {
                                                     RepairOrderId = _model.Id
                                                 })"
                                          Text="Изменить"
                                          Size="ButtonSize.Small"
                                          Style="float: right; 
                                                 display: flex; 
                                                 padding-left: 10px;
                                                 padding-right: 10px;"
                                          ButtonStyle="ButtonStyle.Secondary"/>
                        }
                        else
                        {
                            <EditForm Model="@ConditionEdit"
                                  OnValidSubmit="@UpdateCondition"
                                  style="display: flex;
                                         width: 100%;">
                            <b style="display: flex; 
                                      width: 85%; 
                                      align-items: center; 
                                      height: 50px;
                                      margin-top: 5px;"> 
                                <InputField Title="Внешний вид:">
                                    <Controls>
                                        <RadzenTextBox style="display: flex;align-items: center"
                                                       @bind-Value="ConditionEdit.Condition"
                                                       Placeholder="@_model.Condition"/>
                                    </Controls>
                                </InputField>
                            </b>
                              
                            <DataAnnotationsValidator/>
                            <ValidationSummary/>
                        
                            <div style="display: flex; align-items: center">
                                <RadzenButton type="submit"
                                              Text="Обновить"
                                              Size="ButtonSize.Small"
                                              Style="display: flex; 
                                                    align-items: center;
                                                    height: 28px; 
                                                    margin-right: 25px; 
                                                    width: min-content;"
                                              ButtonStyle="ButtonStyle.Secondary"/>
                                <RadzenButton Click=@(_ => ConditionEdit = null)
                                              ButtonStyle="ButtonStyle.Danger"
                                              Icon="close"
                                              Style=""
                                              Size="ButtonSize.Small"/>
                            </div>
                         </EditForm>
                        }
                    </li>
                    
                    <li class="list-group-item" style="width: 100%; display: flex;">
                        <EditableField OnCancel="@(() => ComplicationEdit = null)"
                                       OnEdit="@(() => ComplicationEdit = new UpdateRepairOrdersComplicationHttpBody() {RepairOrderId = _model.Id})"
                                       OnSave="@(() => UpdateComplication())">
                            <View><p>Комплектация: @_model.Complication</p></View>
                            <Edit>
                                <InputField Title="Комплектация:">
                                    <Controls><RadzenTextBox style="display: flex;align-items: center" @bind-Value="ComplicationEdit.Complication" Placeholder="@_model.Complication"/></Controls>
                                </InputField>
                            </Edit>
                        </EditableField>
                    </li>
                
                    <li class="list-group-item" style="width: 100%; display: flex;">
                        <EditableField OnCancel="@(() => SerialEdit = null)"
                                       OnEdit="@(() => SerialEdit = new UpdateRepairOrdersSerialHttpBody() {RepairOrderId = _model.Id})"
                                       OnSave="@(() => UpdateSerial())">
                            <View>
                                <p>Серийный номер/IMEI: @_model.Serial</p>
                            </View>
                            <Edit>
                                <InputField Title="Комплектация:">
                                    <Controls>
                                        <InputField Title="Серийный номер/IMEI:">
                                            <Controls>
                                                <RadzenTextBox style="display: flex;align-items: center" @bind-Value="SerialEdit.Serial" Placeholder="@_model.Serial"/>
                                            </Controls>
                                        </InputField>
                                    </Controls>
                                </InputField>
                            </Edit>
                        </EditableField>
                    </li>
                    @if (_model.Performer != "")
                    {
                        <li class="list-group-item ">
                            <b>Исполнитель: @_model.Performer</b>
                        </li>
                    }
                </ul>
            </RadzenFieldset>
            <RadzenFieldset Text="Состояние"
                            Style="width: 70%;">
                <ul class="list-group">
                    <li class="list-group-item alert alert-primary">
                    @switch (_model.CurrentState)
                    {
                        case 0:
                        {
                            <RepairOrdersSetPerformer FormSubmitted="SetPerformer" Model="SetUserAsPerformerOfRepairOrderQuery"/>
                            break;
                        };
                        case 1:
                        {
                            <RadzenButton Text="На диагностике" Click="@(SetAsDiagnosted)"/>
                            break;
                        };
                        case 2:
                        {
                            <RadzenButton Text="Согласован с клиентом " Click="@(SetAsAgreement)"/>
                            break;
                        };
                        case 3:
                        {
                            <RadzenButton Text="Ожидает поставки запчастей" Click="@(SetAsOnWait)"/>
                            <RadzenButton Text="В работе" Click="@(SetAsOnWork)"/>
                            <RadzenButton Text="Готов" Click="@(SetAsReady)"/>
                            break;
                        };
                        case 4:
                        {
                            <RadzenButton Text="В работе" Click="@(SetAsOnWork)"/>
                            break;
                        };
                        case 5:
                        {
                            <RadzenButton Text="Ожидает поставки запчастей" Click="@(SetAsOnWait)"/>
                            <RadzenButton Text="Готов" Click="@(SetAsReady)"/>
                            break; 
                        };
                        case 6:
                        {
                            <RadzenButton Text="Завершен" Click="@(SetAsCompleted)"/>
                            break; 
                        };
                        case 7:
                        {
                            <RadzenButton Text="Закрыт" Click="@(SetAsClosed)"/>
                            break; 
                        };
                        case 8:
                        {
                            <RadzenButton Text="Закрыто" Click="@(SetAsClosed)"/>
                            break; 
                        };
                    }
                    </li>
                    @foreach (var state in _states)
                    {
                        <li class="list-group-item alert alert-primary">@($"{state.Date:dd/MM/yyyy} - {state.Comment}")</li>
                    }
                </ul>
            </RadzenFieldset>
        </div>
        <RadzenFieldset Text="Работы"
                        Style="width: 100%;">
            @if (!(_states.Select(e => e.Type).Contains((int) RepairOrderStateType.Completed) ||
                   _states.Select(e => e.Type).Contains((int) RepairOrderStateType.Closed)) &&
                 _roles.Any(c => c == RolesHelper.Master))
            {
                <RadzenButton Click=@(_ => AddWork())
                              Text="Добавить работу"
                              Style="margin: 1rem 0;"
                              ButtonStyle="ButtonStyle.Primary"/>
            }
            <RadzenGrid Data="@(_works)"
                        EmptyText="Нет проведенных работ..."
                        TItem="RepairOrderWorkViewModel">
                <Columns>
                    <RadzenGridColumn TItem="RepairOrderWorkViewModel"
                                      Property="WorkName"
                                      Title="Наименование работы"/>
                    <RadzenGridColumn TItem="RepairOrderWorkViewModel"
                                      Property="Price"
                                      Title="Цена"/>
                </Columns>
            </RadzenGrid>
        </RadzenFieldset>
        <RadzenFieldset Text="Переписка"
                        Style="width: 100%;">
        </RadzenFieldset>
    </div>
</LoadingContent>

@code
{
    
    
    [CascadingParameter] public BlazoredModalInstance ModalInstance { get; set; }
    [CascadingParameter] public IModalService Modal { get; set; }
    [Parameter] public Guid Id { get; set; }

    private RepairOrderViewModel _model;
    private List<RepairOrdersStateViewModel> _states = new();
    private List<RepairOrderWorkViewModel> _works = new();
    private List<ArticleViewModel> _devices { get; set; }
    private bool _isLoaded;
    
    private UpdateRepairOrdersDeviceHttpBody DeviceEdit { get; set; }
    private UpdateRepairOrdersSerialHttpBody SerialEdit { get; set; }
    private UpdateRepairOrdersConditionHttpBody ConditionEdit { get; set; }
    private UpdateRepairOrdersTroubleHttpBody TroubleEdit { get; set; }
    private UpdateRepairOrdersComplicationHttpBody ComplicationEdit { get; set; }
    
    private string DiagnosticResult { get; set; }
    
    private List<Guid> _roles = new();

    private async Task Update()
    {   
        _model = (await new HttpGetRequest<GetRepairOrderByIdHttpResponse>(HttpClient, NotificationService,$"{RequestManager.RepairOrdersServer}/RepairOrders/{Id}").GetAsync()).Data;
        _states = (await new HttpGetRequest<GetAllRepairOrderStatesHttpResponse>(HttpClient, NotificationService,$"{RequestManager.RepairOrdersServer}/RepairOrders/{Id}/States").GetAsync()).Data;
        _states.Reverse();
        _works = (await new HttpGetRequest<GetAllRepairOrderWorksHttpResponse>(HttpClient, NotificationService,$"{RequestManager.RepairOrdersServer}/RepairOrders/{Id}/Works").GetAsync()).Data;
        _devices = (await new HttpGetRequest<GetAllArticlesSuccessHttpResponse>(HttpClient, NotificationService,$"{RequestManager.StorageServer}/Articles").GetAsync()).Data;
        
    }

    protected override async Task OnInitializedAsync()
    {
        _isLoaded = false;
        _roles = await AuthService.GetCurrentRoles();
        await Update();
        _isLoaded = true;
    }

    private async Task AddWork()
    {
        var modalOpts = new ModalOptions()
        {
            DisableBackgroundCancel = true, FocusFirstElement = true
        };
        var parameters = new ModalParameters();
        parameters.Add(nameof(UpdateRepairOrderStateForm.RepairOrderId), Id);
        var modal = Modal.Show<UpdateRepairOrderWorkForm>($"Добавить работу", parameters, modalOpts);
        await modal.Result;
        _isLoaded = false;
        await Update();
        _isLoaded = true;
    }

    private SetPerformerOfRepairOrderHttpQuery SetUserAsPerformerOfRepairOrderQuery { get; set; } = new();
    private async Task SetPerformer()
    {
        SetUserAsPerformerOfRepairOrderQuery.RepairOrderId = _model.Id;
        await new HttpPostRequest<SetPerformerOfRepairOrderHttpQuery,SetPerformerOfRepairOrderHttpResponse>(HttpClient, $"{RequestManager.RepairOrdersServer}/RepairOrders/SetPerformerOfRepairOrder").PostAsync(SetUserAsPerformerOfRepairOrderQuery);
        _isLoaded = false;
        await Update();
        _isLoaded = true;
    }

    private async Task UpdateDevice()
    {
        await new HttpPatchRequest<UpdateRepairOrdersDeviceHttpBody, UpdateRepairOrdersDeviceHttpResponse>(HttpClient, $"{RequestManager.RepairOrdersServer}/RepairOrders/Device").PatchAsync(DeviceEdit);
        DeviceEdit = null;
        await Update();
    }
    private async Task UpdateSerial()
    {
        await new HttpPatchRequest<UpdateRepairOrdersSerialHttpBody, UpdateRepairOrdersSerialHttpResponse>(HttpClient, $"{RequestManager.RepairOrdersServer}/RepairOrders/Serial").PatchAsync(SerialEdit);
        SerialEdit = null;
        await Update();
    }
    private async Task UpdateCondition()
    {
        await new HttpPatchRequest<UpdateRepairOrdersConditionHttpBody, UpdateRepairOrdersConditionHttpResponse>(HttpClient, $"{RequestManager.RepairOrdersServer}/RepairOrders/Condition").PatchAsync(ConditionEdit);
        ConditionEdit = null;
        await Update();
    }
    private async Task UpdateTrouble()
    {
        await new HttpPatchRequest<UpdateRepairOrdersTroubleHttpBody, UpdateRepairOrdersTroubleHttpResponse>(HttpClient, $"{RequestManager.RepairOrdersServer}/RepairOrders/Trouble").PatchAsync(TroubleEdit);
        TroubleEdit = null;
        await Update();
    }
    private async Task UpdateComplication()
    {
        await new HttpPatchRequest<UpdateRepairOrdersComplicationHttpBody, UpdateRepairOrdersComplicationHttpResponse>(HttpClient, $"{RequestManager.RepairOrdersServer}/RepairOrders/Complication").PatchAsync(ComplicationEdit);
        ComplicationEdit = null;
        await Update();
    }

    private async Task SetAsDiagnosted()
    {
        await new HttpPostRequest<SetRepairOrderAsDiagnosedHttpBody,SetRepairOrderAsDiagnosedHttpResponse>(HttpClient, $"{RequestManager.RepairOrdersServer}/RepairOrders/Diagnosed").PostAsync(new SetRepairOrderAsDiagnosedHttpBody(){RepairOrderId = _model.Id});
        await Update();
    }

    private async Task SetAsAgreement()
    {
        await new HttpPostRequest<SetRepairOrderAsAgreementHttpBody,SetRepairOrderAsAgreementHttpResponse>(HttpClient, $"{RequestManager.RepairOrdersServer}/RepairOrders/Agreement").PostAsync(new SetRepairOrderAsAgreementHttpBody(){RepairOrderId = _model.Id});
        await Update();
    }
    private async Task SetAsReady()
    {
        var modal = Modal.Show<ReadyResult>($"Оплата за заказ наряд");
        var res = await modal.Result;
        await new HttpPostRequest<SetRepairOrderAsReadyHttpBody,SetRepairOrderAsReadyHttpResponse>(HttpClient, $"{RequestManager.RepairOrdersServer}/RepairOrders/Ready").PostAsync(new SetRepairOrderAsReadyHttpBody(){RepairOrderId = _model.Id, Wage = res.Data is double data ? data : 0});
        await Update();
    }
    private async Task SetAsOnWait()
    {        
        await new HttpPostRequest<SetRepairOrderAsOnWaitHttpBody,SetRepairOrderAsOnWaitHttpResponse>(HttpClient, $"{RequestManager.RepairOrdersServer}/RepairOrders/OnWait").PostAsync(new SetRepairOrderAsOnWaitHttpBody(){RepairOrderId = _model.Id});
        await Update();
    }
    private async Task SetAsOnWork()
    {
        await new HttpPostRequest<SetRepairOrderAsOnWorkHttpBody,SetRepairOrderAsOnWorkHttpResponse>(HttpClient, $"{RequestManager.RepairOrdersServer}/RepairOrders/OnWork").PostAsync(new SetRepairOrderAsOnWorkHttpBody(){RepairOrderId = _model.Id});
        await Update();
    }
    private async Task SetAsCompleted()
    {
        await new HttpPostRequest<SetRepairOrderAsCompletedHttpBody,SetRepairOrderAsCompletedHttpResponse>(HttpClient, $"{RequestManager.RepairOrdersServer}/RepairOrders/Completed").PostAsync(new SetRepairOrderAsCompletedHttpBody(){RepairOrderId = _model.Id});
        await Update();
    }
    private async Task SetAsClosed()
    {
        await new HttpPostRequest<SetRepairOrderAsClosedHttpBody,SetRepairOrderAsClosedHttpResponse>(HttpClient, $"{RequestManager.RepairOrdersServer}/RepairOrders/Close").PostAsync(new SetRepairOrderAsClosedHttpBody(){RepairOrderId = _model.Id});
        await Update();
    }
}
