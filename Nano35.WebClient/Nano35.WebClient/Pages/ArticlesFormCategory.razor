@using Nano35.WebClient.Services
@using Nano35.Contexts.Http.storage
@inject ISessionProvider SessionProvider
@inject RequestManager RequestManager
@inject HttpClient HttpClient
@inject NotificationService NotificationService
@inject HttpGet GetRequest
@inject HttpPost PostRequest
@inject NavigationManager NavigationManager

<LoadingContent IsLoaded="_isLoading">
    
    <div style="width: 100%;">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                @foreach (var t in _selectedCategories)
                {
                    <li class="breadcrumb-item active">
                        <span>
                            @t.Name
                        </span>
                    </li>
                }
            </ol>
        </nav>
        <RadzenButton Click="@(_ => OnClearCategory())" Text="Отчистить"/>
        <RadzenTabs>
            <Tabs>
                @if (_categories.Any())
                {
                    <RadzenTabsItem Text="Добавить существующую подкатегория">
                        <div style="display: flex;">
                            <RadzenDropDown Data="@(_categories)"
                                            style="width: 100%;"
                                            @bind-Value="_selectedCategory"
                                            Change="@(_ => OnAddCategory(_selectedCategory))"
                                            TValue="ArticleCategoryViewModel"
                                            AllowClear="true"
                                            Disabled="@(!_categories.Any())"
                                            Placeholder=@(_selectedCategories.Any() ? $"Выберите подкатегорию к {_selectedCategories.Last().Name}" : "Выберите категорию")
                                            TextProperty="Name"
                                            FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                            FilterOperator="StringFilterOperator.Contains"
                                            AllowFiltering="true"/>
                        </div>
                    </RadzenTabsItem>
                }
                @if (_selectedCategories.Any())
                {
                    <RadzenTabsItem Text="Создать подкатегорию">
                        <div style="display: flex;">
                            <RadzenTextBox Change=@(args => _name = args.ToString())
                                           style="width: 100%;"
                                           Placeholder=@(_selectedCategories.Any() ? $"Введите название новой подкатегории к {_selectedCategories.Last().Name}" : "Введите название новой категории" ) />
                            <RadzenButton Click="@(_ => OnCreateCategory())"
                                          Text="Добавить"
                                          ButtonStyle="ButtonStyle.Secondary" />
                        </div>
                    </RadzenTabsItem>
                }
            </Tabs>
        </RadzenTabs>
    </div>
</LoadingContent>

@code
{
    [Parameter] public EventCallback<Guid> ValueChanged { get; set; }
    [Parameter] public Guid Value { get => _value; set { if (_value == value ) return; _value = value; ValueChanged.InvokeAsync(value); } }
    private Guid _value;    
    private List<ArticleCategoryViewModel> _categories = new();
    private List<ArticleCategoryViewModel> _selectedCategories = new();
    private ArticleCategoryViewModel _selectedCategory;
    private string _name = string.Empty;
    private bool _isLoading;
    
    protected override async Task OnInitializedAsync()
    {            
        _isLoading = false;        
        await GetRequest.InvokeAsync<GetAllArticleCategoriesSuccessHttpResponse>(
            $"storage/Category?InstanceId={await SessionProvider.GetCurrentInstanceId()}",
            resp =>
            {
                if (resp.IsSuccess()) {_categories = resp.Success.Data;}
                else
                {
                    Console.WriteLine(resp.Error);
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
        _isLoading = true;
    }

    private async Task OnClearCategory()
    {
        _selectedCategories = new List<ArticleCategoryViewModel>();
        await GetRequest.InvokeAsync<GetAllArticleCategoriesSuccessHttpResponse>(
            $"storage/Category?InstanceId={await SessionProvider.GetCurrentInstanceId()}",
            resp =>
            {
                if (resp.IsSuccess()) {_categories = resp.Success.Data;}
                else
                {
                    Console.WriteLine(resp.Error);
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
    }
    
    private async Task OnAddCategory(ArticleCategoryViewModel selected)
    {
        _isLoading = false;
        _selectedCategory = null;
        _categories.Clear();
        _selectedCategories.Add(selected);
        await GetRequest.InvokeAsync<GetAllArticleCategoriesSuccessHttpResponse>(
            $"storage/Category?InstanceId={await SessionProvider.GetCurrentInstanceId()}&ParentId={_selectedCategories.Last().Id}",
            resp =>
            {
                if (resp.IsSuccess())
                {
                    _categories = resp.Success.Data;
                }
                else
                {
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
        Value = _selectedCategories.Last().Id;
        _isLoading = true;
    }

    
    private async Task OnCreateCategory()
    {
        _categories.Clear();
        var body = new CreateCategoryHttpBody()
        {
            Name = _name,
            InstanceId = await SessionProvider.GetCurrentInstanceId(),
            NewId = Guid.NewGuid(),
            ParentCategoryId = _selectedCategories.Count != 0 ? _selectedCategories.Last().Id : Guid.Empty
        };
        await PostRequest.InvokeAsync<CreateCategorySuccessHttpResponse, CreateCategoryHttpBody>(
            $"storage/Category", body,
            resp =>
            {
                if (resp.IsSuccess())
                {
                    
                }
                else
                {
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
        
        await GetRequest.InvokeAsync<GetAllArticleCategoriesSuccessHttpResponse>(
            $"storage/Category?InstanceId={await SessionProvider.GetCurrentInstanceId()}&ParentId={body.NewId}",
            resp =>
            {
                if (resp.IsSuccess()) {_categories = resp.Success.Data;}
                else
                {
                    Console.WriteLine(resp.Error);
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
        _isLoading = true;
        _selectedCategories.Add(new ArticleCategoryViewModel() { Id = body.NewId, Name = body.Name, ParentCategoryId = body.ParentCategoryId });
        
        await GetRequest.InvokeAsync<GetAllArticleCategoriesSuccessHttpResponse>(
            $"storage/Category?InstanceId={await SessionProvider.GetCurrentInstanceId()}&ParentId={_selectedCategories.Last().Id}&InstanceId={await SessionProvider.GetCurrentInstanceId()}",
            resp =>
            {
                if (resp.IsSuccess()) {_categories = resp.Success.Data;}
                else
                {
                    Console.WriteLine(resp.Error);
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
        Value = _selectedCategories.Last().Id;
    }

    private async Task OnRemoveSelectedCategory(int index)
    {
        _isLoading = false;
        _categories.Clear();
        _selectedCategories.RemoveRange(index, _selectedCategories.Count - index);
        await GetRequest.InvokeAsync<GetAllArticleCategoriesSuccessHttpResponse>(
            $"storage/Category?InstanceId={await SessionProvider.GetCurrentInstanceId()}&ParentId={_selectedCategories.Last().Id}&InstanceId={await SessionProvider.GetCurrentInstanceId()}",
            resp =>
            {
                if (resp.IsSuccess()) {_categories = resp.Success.Data;}
                else
                {
                    Console.WriteLine(resp.Error);
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
        Value = _selectedCategories.Last().Id;
        _isLoading = true;
        StateHasChanged();
    }
}