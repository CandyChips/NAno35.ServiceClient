@using Nano35.HttpContext.storage
@using Nano35.WebClient.Services
@using Nano35.Contracts.Storage.Models
@using ArticleViewModel = Nano35.HttpContext.storage.ArticleViewModel
@using Nano35.Contracts.Storage.Artifacts
@inject HttpClient HttpClient
@inject IRequestManager RequestManager
@inject ISessionProvider SessionProvider


@if (_loading)
{
    <div class="d-flex justify-content-center" style="margin-top: 5rem; margin-bottom: 5rem">
        <div class="spinner-border text-Secondary" role="status">
            <span class="visually-hidden"></span>
        </div>
    </div>
}
else
{
    <RadzenFieldset Text="Информация"
                    Style="width: 100%;">
        <ul class="list-group" >
            <li class="list-group-item" role="alert" style="width: 100%; display: flex;">
                @if (CategoryEdit == null)
                {
                    <b style="display: flex;  width: 85%; align-items: center">Категория: @Article.Category</b>
                                                    
                    <RadzenButton Click="@(_ => CategoryEdit = new UpdateArticleCategoryHttpBody(){Id = Article.Id})"
                                  Text="Изменить"
                                  Size="ButtonSize.Small"
                                  Style="margin: 1rem 0; float: right; display: flex "
                                  ButtonStyle="ButtonStyle.Secondary"/>
                }
                else
                {
                    <b style="display: flex; align-items: center; width: 85%"> 
                        <InputField Title="Категория:">
                            <Controls>
                                <RadzenDropDown style="display: flex; "
                                                AllowClear="true"
                                                TValue="Guid"
                                                Data=@(Categories.Select(g => new {Id = g.Id, Name = g.Name}))
                                                TextProperty="Name"
                                                ValueProperty="Id"
                                                @bind-Value="CategoryEdit.CategoryId">
                                    <Template Context="data">
                                        <div style="display: flex; flex-direction: row">
                                            <div style="width: 90%;">@(data.Name)</div>
                                            <RadzenButton 
                                                Click="@(_ => OpenCategoryDetails(Categories.First(h=> h.Id == data.Id), data.Name))"
                                                Size="ButtonSize.Small"
                                                Text="🖉"
                                                Style="height: 20px;
                                                    display: flex;
                                                    padding-left: revert;
                                                    padding-right: revert;
                                                    align-items: center;"/>
                                        </div>
                                    </Template>
                                </RadzenDropDown>
                            </Controls>
                        </InputField>
                    </b>
                    
                    <div style="display: flex; align-items: center">
                        <RadzenButton Click="@(_ => UpdateCategory())"
                                      Text="Обновить"
                                      Size="ButtonSize.Small"
                                      Style="display: flex; align-items: center;height: 40px; margin-right: 25px;"
                                      ButtonStyle="ButtonStyle.Secondary"/>
                        <RadzenButton Click=@(_ => CategoryEdit = null)
                                  ButtonStyle="ButtonStyle.Danger"
                                  Icon="close"
                                  Style="height: 40px; width: 40px"
                                  Size="ButtonSize.Small"/>
                    </div>
                }
            </li>
            <li class="list-group-item" role="alert" style="width: 100%; display: flex;">
                @if (BrandEdit == null)
                {
                    <b style="display: flex;  width: 85%; align-items: center">Бренд: @Article.Brand</b>
                                                    
                    <RadzenButton Click="@(_ => BrandEdit = new UpdateArticleBrandHttpBody()
                                         {
                                             Id = Article.Id
                                         })"
                                  Text="Изменить"
                                  Size="ButtonSize.Small"
                                  Style="margin: 1rem 0; float: right; display: flex "
                                  ButtonStyle="ButtonStyle.Secondary"/>
                }
                else
                {
                    <b style="display: flex; align-items: center; width: 85%"> 
                        <InputField Title="Бренд:">
                            <Controls>
                                <RadzenTextBox style="display: flex;align-items: center"
                                               @bind-Value="BrandEdit.Brand"
                                               Placeholder="@Article.Brand"/>
                            
                            
                            </Controls>
                        </InputField>
                    </b>
                    
                    <div style="display: flex; align-items: center">
                        <RadzenButton Click="@(_ => UpdateBrand())"
                                      Text="Обновить"
                                      Size="ButtonSize.Small"
                                      Style="display: flex; align-items: center;height: 40px; margin-right: 25px;"
                                      ButtonStyle="ButtonStyle.Secondary"/>
                        <RadzenButton Click=@(_ => BrandEdit = null)
                                  ButtonStyle="ButtonStyle.Danger"
                                  Icon="close"
                                  Style="height: 40px; width: 40px"
                                  Size="ButtonSize.Small"/>
                    </div>
                }
            </li>
            <li class="list-group-item" role="alert" style="width: 100%; display: flex;">
                @if (ModelEdit == null)
                {
                    <b style="display: flex;  width: 85%; align-items: center">Модель: @Article.Model</b>
                                                    
                    <RadzenButton Click="@(_ => ModelEdit = new UpdateArticleModelHttpBody()
                                         {
                                             Id = Article.Id
                                         })"
                                  Text="Изменить"
                                  Size="ButtonSize.Small"
                                  Style="margin: 1rem 0; float: right; display: flex "
                                  ButtonStyle="ButtonStyle.Secondary"/>
                }
                else
                {
                    <b style="display: flex; align-items: center; width: 85%"> 
                        <InputField Title="Модель:">
                            <Controls>
                                <RadzenTextBox style="display: flex;align-items: center"
                                               @bind-Value="ModelEdit.Model"
                                               Placeholder="@Article.Model"/>
                            
                            
                            </Controls>
                        </InputField>
                    </b>
                    
                    <div style="display: flex; align-items: center">
                        <RadzenButton Click="@(_ => UpdateModel())"
                                      Text="Обновить"
                                      Size="ButtonSize.Small"
                                      Style="display: flex; align-items: center;height: 40px; margin-right: 25px;"
                                      ButtonStyle="ButtonStyle.Secondary"/>
                        <RadzenButton Click=@(_ => ModelEdit = null)
                                  ButtonStyle="ButtonStyle.Danger"
                                  Icon="close"
                                  Style="height: 40px; width: 40px"
                                  Size="ButtonSize.Small"/>
                    </div>
                }
            </li>
            <li class="list-group-item" role="alert" style="width: 100%; display: flex;">
                @if (InfoEdit == null)
                {
                    <b style="display: flex;  width: 85%; align-items: center">Информация: @Article.Info</b>
                                                    
                    <RadzenButton Click="@(_ => InfoEdit = new UpdateArticleInfoHttpBody()
                                         {
                                             Id = Article.Id
                                         })"
                                  Text="Изменить"
                                  Size="ButtonSize.Small"
                                  Style="margin: 1rem 0; float: right; display: flex "
                                  ButtonStyle="ButtonStyle.Secondary"/>
                }
                else
                {
                    <b style="display: flex; align-items: center; width: 85%"> 
                        <InputField Title="Информация:">
                            <Controls>
                                <RadzenTextBox style="display: flex;align-items: center"
                                               @bind-Value="InfoEdit.Info"
                                               Placeholder="@Article.Info"/>
                            
                            
                            </Controls>
                        </InputField>
                    </b>
                    
                    <div style="display: flex; align-items: center">
                        <RadzenButton Click="@(_ => UpdateInfo())"
                                      Text="Обновить"
                                      Size="ButtonSize.Small"
                                      Style="display: flex; align-items: center;height: 40px; margin-right: 25px;"
                                      ButtonStyle="ButtonStyle.Secondary"/>
                        <RadzenButton Click=@(_ => InfoEdit = null)
                                  ButtonStyle="ButtonStyle.Danger"
                                  Icon="close"
                                  Style="height: 40px; width: 40px"
                                  Size="ButtonSize.Small"/>
                    </div>
                }
            </li>
        </ul>
    </RadzenFieldset>
    
    <RadzenFieldset Text="Характеристики"
                    Style="width: 60rem">
        <RadzenGrid Data="@(Article.Specs)"
                    EmptyText="Нет указаных характеристик"
                    TItem="SpecHttpContext">
            <Columns>
                <RadzenGridColumn TItem="SpecHttpContext"
                                  Property="Key"
                                  Title="Характеристика"/>
                <RadzenGridColumn TItem="SpecHttpContext"
                                  Property="Value"
                                  Title="Значение"/>
            </Columns>
        </RadzenGrid>
    </RadzenFieldset>
}

@code
{
    [CascadingParameter] public IModalService Modal { get; set; }
    [CascadingParameter] BlazoredModalInstance ModalInstance { get; set; }

    [Parameter] public Guid Id { get; set; }
    private ArticleViewModel Article { get; set; } = new ();
    
    private List<ArticleCategoryViewModel> Categories { get; set; }
    
    private UpdateArticleInfoHttpBody InfoEdit { get; set; }
    private UpdateArticleModelHttpBody ModelEdit { get; set; }
    private UpdateArticleCategoryHttpBody CategoryEdit { get; set; }
    private UpdateArticleBrandHttpBody BrandEdit { get; set; }
    private bool _loading = true;

    
    protected override async Task OnInitializedAsync()
    {
        _loading = true;
        Article = (await new GetArticleByIdRequest(
            RequestManager,
            HttpClient, 
            new GetArticleByIdHttpQuery() {Id = Id}
            ).Send()).Data;
        
        Categories = (await new GetAllArticleCategoriesRequest(
            RequestManager,
            HttpClient, 
            new GetAllArticlesCategoriesHttpQuery(){InstanceId = await SessionProvider.GetCurrentInstanceId(),ParentId = Guid.Parse("F50EBC56-3D91-481C-8F61-16E47555B136")}
            ).Send()).Data;

        _loading = false;
    }


    private async Task UpdateCategory()
    {
        await new UpdateArticleCategoryRequest(RequestManager, HttpClient, CategoryEdit).Send();
        CategoryEdit = null;
    }
    
    private async Task UpdateBrand()
    {
        await new UpdateArticleBrandRequest(RequestManager, HttpClient, BrandEdit).Send();
        BrandEdit = null;
    }
    
    private async Task UpdateModel()
    {
        await new UpdateArticleModelRequest(RequestManager, HttpClient, ModelEdit).Send();
        ModelEdit = null;
    }
    
    private async Task UpdateInfo()
    {
        await new UpdateArticleInfoRequest(RequestManager, HttpClient, InfoEdit).Send();
        ModelEdit = null;
    }
    private async Task OpenCategoryDetails(ArticleCategoryViewModel item, string name)
    {
        var parameters = new ModalParameters();
        parameters.Add(nameof(CategoryDetails.Category), item);
        var modal = Modal.Show<CategoryDetails>($"{name}", parameters);
        await modal.Result;
    }
}
