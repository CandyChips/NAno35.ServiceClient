@using Nano35.WebClient.Services
@using Nano35.Contexts.Http.storage
@inject HttpClient HttpClient
@inject RequestManager RequestManager
@inject ISessionProvider SessionProvider
@inject NotificationService NotificationService
@inject HttpGet GetRequest
@inject NavigationManager NavigationManager

<div style="margin-top:20px">Номер оприходования:</div>
<b>@Cancellation.Number</b>
<div style="margin-top:20px">Дата:</div>
<b>@Cancellation.Date</b>
<div style="margin-top:20px">Целевое подразделение:</div>
<b>@Cancellation.Unit</b>
<div style="margin-top:20px">Поставщик:</div>
<b>@Cancellation.Client</b>

<RadzenFieldset Text="Оприходуемые товары"
                Style="width: 60rem">
    <RadzenGrid Data="@Details"
                EmptyText="Добавте оприходуемые товары..."
                TItem="CancellationDetailViewModel">
        <Columns>
            <RadzenGridColumn TItem="CancellationDetailViewModel"
                              Property="StorageItem" 
                              Title="Товар" />
            <RadzenGridColumn TItem="CancellationDetailViewModel" 
                              Property="PlaceOnStorage" 
                              Title="Место на складе" />
            <RadzenGridColumn TItem="CancellationDetailViewModel"
                              Property="Count"
                              Title="Количество" />
            <RadzenGridColumn TItem="CancellationDetailViewModel"
                              Property="Price" 
                              Title="Цена" />
            <RadzenGridColumn TItem="CancellationDetailViewModel"
                              Bubble="false"
                              Sortable="false"
                              Filterable="false"
                              Width="250px"
                              TextAlign="TextAlign.Center">
                <Template Context="item">
                    <a href="http://192.168.100.124:5002/StorageItems/Ticket?storageItemId=@item.StorageItemId.ToString()" target="_blank">Этикетка</a>
                </Template>
            </RadzenGridColumn>
        </Columns>
    </RadzenGrid>
</RadzenFieldset>

@code
{
    [Parameter] public CancellationViewModel Cancellation { get; set; }
    private List<CancellationDetailViewModel> Details { get; set; }
    
    protected override async Task OnInitializedAsync()
    {
        await GetRequest.InvokeAsync<GetAllCancellationDetailsSuccessHttpResponse>($"Cancellations/{Cancellation.Id}/Details",
            resp =>
            {
                if (resp.IsSuccess()) {Details = resp.Success.Data;}
                else
                {
                    Console.WriteLine(resp.Error);
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
    }
}
