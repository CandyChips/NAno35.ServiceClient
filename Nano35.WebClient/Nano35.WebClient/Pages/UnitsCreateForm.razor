@using Nano35.WebClient.Services
@using Nano35.Contracts.Instance.Models
@using Nano35.Contexts.Http.Instance
@using System.Text.RegularExpressions
@inject RequestManager RequestManager
@inject ISessionProvider SessionProvider
@inject NavigationManager NavigationManager
@inject HttpPost PostRequest
@inject HttpGet GetRequest


<BoxedContent Width="40">
        <EditForm Model="@Model" OnValidSubmit="HandleValidSubmit">
            <DataAnnotationsValidator />
    
            <InputField Title="Название подразделения*"
                        Helper="...">
                <Controls><RadzenTextBox Style="width: 100%;" @bind-Value="Model.Name"/></Controls>
                <Validation><ValidationMessage For="@(() => Model.Name)" /></Validation>
            </InputField>
    
            <InputField Title="Адресс*"
                        Helper="...">
                <Controls><RadzenTextBox Style="width: 100%;" @bind-Value="Model.Address"/></Controls>
                <Validation><ValidationMessage For="@(() => Model.Address)" /></Validation>
            </InputField>
    
            <InputField Title="Формат работы"
                        Helper="...">
                <Controls><RadzenTextBox Style="width: 100%;" @bind-Value="Model.WorkingFormat"/></Controls>
                <Validation><ValidationMessage For="@(() => Model.WorkingFormat)" /></Validation>
            </InputField>
    
            <InputField Title="Номер телефона*"
                        Helper="...">
                <Controls><RadzenTextBox Style="width: 100%;" @bind-Value="Phone" Change="PhoneMask" /></Controls>
                <Validation><ValidationMessage For="@(() => Model.Phone)" /></Validation>
            </InputField>
    
        <LoadingContent IsLoaded="_isLoading">
            <InputField Title="Тип подразделения*"
                        Helper="...">
                <Controls>
                    <RadzenDropDown Data=@(_types.Select(a => new {Id = a.Id, Name = a.Name}))
                                    TextProperty="Name" ValueProperty="Id" TValue="Guid"
                                    @bind-Value="Model.UnitTypeId" style="width: 100%"/>
                </Controls>
                <Validation><ValidationMessage For="@(() => Model.UnitTypeId)" /></Validation>
            </InputField>
        </LoadingContent>
                        
            @if (!string.IsNullOrEmpty(Error))
            {
                <div class="alert alert-danger mt-3 mb-0">@Error</div>
            }
            
            <RadzenButton type="submit" Text="Создать" ButtonStyle="ButtonStyle.Primary" Style="width: 100%" />
        </EditForm>
</BoxedContent>

@code
{
    [CascadingParameter] public IModalService Modal { get; set; }
    [CascadingParameter] BlazoredModalInstance ModalInstance { get; set; }
    private CreateUnitHttpBody Model = new();
    private string Error { get; set; }
    private List<UnitTypeViewModel> _types = new();
    private string Phone { get ; set ; } = "+7";
    private bool _isLoading;
    
    protected override async Task OnInitializedAsync()
    {
        _isLoading = false;
        await GetRequest.InvokeAsync<GetAllUnitTypesHttpResponse>(
            $"instance/Units/Types",
            resp =>
            {
                if (resp.IsSuccess()) {_types = resp.Success.UnitTypes.ToList();}
                else {NavigationManager.NavigateTo("/instance-view");}
            });
        Model = new CreateUnitHttpBody
        {
            Id = Guid.NewGuid(),
            InstanceId = await SessionProvider.GetCurrentInstanceId()
        };
        _isLoading = true;
    }
    
    private async Task HandleValidSubmit()
    {
        _isLoading = false;
        try
        {
            await PostRequest.InvokeAsync<CreateUnitHttpResponse, CreateUnitHttpBody>(
                $"instance/Units", Model,
                resp =>
                {
                    if (resp.IsSuccess())
                    {
                        ModalInstance.CloseAsync();
                    }
                    else
                    {   
                        NavigationManager.NavigateTo("/instance-view");
                    }
                });
            _isLoading = true;
        }
        catch (Exception e)
        {
            Error = e.Message;
        }
    }
    
    private async Task PhoneMask()
    {

        Phone = Regex.Replace(Phone, @"[^\d]", "");

        var countryCode = "+7";

        if (Phone.StartsWith("7"))
            Phone = Phone.Remove(0, 1);

        if (Phone.StartsWith("8"))
            Phone = Phone.Remove(0, 1);

        if (Phone.Length < 10)
            Phone = Phone.PadRight(10);

        if (Phone.Length > 10)
            Phone = Phone.Substring(0, 10);
        
        Model.Phone = Phone;
        
        Phone = $"{countryCode}({Phone.Substring(0, 3)}) {Phone.Substring(3, 3)}-{Phone.Substring(6, 2)}-{Phone.Substring(8, 2)}";
    }
}
