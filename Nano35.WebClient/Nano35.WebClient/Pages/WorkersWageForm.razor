@using Nano35.Contracts.Cashbox.Artifacts
@using Nano35.Contracts.Cashbox.Models
@using Nano35.HttpContext.Cashbox
@using Nano35.WebClient.Services
@inject HttpClient HttpClient
@inject IRequestManager RequestManager
@inject ISessionProvider SessionProvider
@inject IAuthService AuthService


<BoxedContent Width="40">
    <LoadingContent IsLoaded="_isLoaded">
        <RadzenFieldset Text="Ожидаемые выплаты"
                        Style="width: 100%;">
            <EditForm Model=@(Model) OnValidSubmit="HandleValidSubmit">
                <DataAnnotationsValidator />
                <RadzenGrid Data="@_operations"
                            EmptyText="Нет ожидаемых выплат"
                            TItem="WageOperationViewModel">
                    <Columns>
                        <RadzenGridColumn TItem="WageOperationViewModel"
                                          Title="Дата">
                            <Template Context="item">
                                @item.Date.ToString("d")
                            </Template>
                        </RadzenGridColumn>
                        
                        <RadzenGridColumn TItem="WageOperationViewModel"
                                          Title="К выплате">
                           <Template Context="item">
                               @item.Cash руб.
                           </Template>
                       </RadzenGridColumn>
                    </Columns>
                </RadzenGrid>
            </EditForm>
        </RadzenFieldset>
        <RadzenFieldset Text="Сумма к выплате"
                        Style="width: 100%;">
            <div style="text-align: center">
                @_operations.Sum(e => e.Cash) руб.
            </div>
        </RadzenFieldset>
        <RadzenButton Click=@(_ => { }) Text="Выплатить из кассы" ButtonStyle="ButtonStyle.Primary" style="width: 100%; margin-top: 1rem"/>
    </LoadingContent>
</BoxedContent>

@code {
    [Parameter] public CreateWageOperationHttpBody Model { get; set; }
    [Parameter] public EventCallback FormSubmitted { get; set; }
    [Parameter] public string Error { get; set; }
    [CascadingParameter] public IModalService Modal { get; set; }
    private List<WageOperationViewModel> _operations = new();
    private bool _isLoaded;
    
    protected override async Task OnInitializedAsync()
    {
        _isLoaded = false;
        _operations = (await new HttpGetRequest<GetAllWageOperationsHttpResponse>(HttpClient, $"{RequestManager.CashboxServer}/Cashbox/WageOperations?unitId={await SessionProvider.GetCurrentUnitId()}&userId={Model.CreatorId}&isWageConfirmed={(int) WageSelection.NotConfirmed}").GetAsync()).Operations;
        _isLoaded = true;
    }

    private async Task HandleValidSubmit()
    {
        await FormSubmitted.InvokeAsync();
    }
}