@using Microsoft.AspNetCore.Authorization
@using Nano35.Contracts.Instance.Models
@using Nano35.HttpContext.instance
@using Nano35.WebClient.Services
@attribute [Authorize]
@page "/instances"
@inject NavigationManager NavigationManager
@inject IRequestManager RequestManager
@inject IInstanceService InstanceService 
@inject ISessionProvider SessionProvider
@inject HttpClient HttpClient

<AuthorizeView>
    <CenterContent Width="50">
        <LoadingContent IsLoaded="_loading">
            <RadzenHeading Text="Организации"/>
            <RadzenButton Click=@(_ => NewInstance()) 
                          Text="Создать"
                          Style="margin: 1rem 0;"
                          ButtonStyle="ButtonStyle.Secondary"/>
    
            <RadzenGrid Data=@(_data)
                        EmptyText="..."
                        TItem="InstanceViewModel">
                <Columns>
                    <RadzenGridColumn TItem="InstanceViewModel"
                                      Property="OrgName" 
                                      Title="Название" />
                    <RadzenGridColumn TItem="InstanceViewModel" 
                                      Property="OrgRealName" 
                                      Title="Организация" />
                    <RadzenGridColumn TItem="InstanceViewModel"
                                      Context="order"
                                      Bubble="false"
                                      TextAlign="TextAlign.Center" 
                                      Width="200px">
                        <Template Context="item">
                            <RadzenButton
                                ButtonStyle="ButtonStyle.Primary"
                                Click="@(_ => OpenOrg(item.Id))">
                                Войти
                            </RadzenButton>
                        </Template>
                    </RadzenGridColumn>
                </Columns>
            </RadzenGrid>
        </LoadingContent>
    </CenterContent>
</AuthorizeView>

@code
{
    private bool _loading;
    private IEnumerable<InstanceViewModel> _data;
    [CascadingParameter] public IModalService Modal { get; set; }
    
    protected override async Task OnInitializedAsync()
    {
        _loading = false;
        _data = (await new HttpGetRequest<GetAllInstancesHttpResponse>(HttpClient, $"{RequestManager.InstanceServer}/Instances/Current").GetAsync()).Data;
        _loading = true;
    }
    
    private async Task NewInstance()
    {
        var modal = Modal.Show<InstancesCreate>("Новая организация");
        await modal.Result;
        _loading = false;
        _data = (await new HttpGetRequest<GetAllInstancesHttpResponse>(HttpClient, $"{RequestManager.InstanceServer}/Instances/Current").GetAsync()).Data;
        _loading = true;
    }

    private async Task OpenOrg(Guid id)
    {
        await InstanceService.SetInstanceById(id);         //get session
        await SessionProvider.SetCurrentInstanceId(id);    //set instance id
        NavigationManager.NavigateTo("/instance-view");
    }
}
