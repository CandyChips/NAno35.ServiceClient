@using Nano35.WebClient.Services
@using UnitViewModel = Nano35.Contracts.Instance.Models.UnitViewModel
@using UnitTypeViewModel = Nano35.Contracts.Instance.Models.UnitTypeViewModel
@using Nano35.Contexts.Http.Instance
@inject HttpClient HttpClient
@inject RequestManager RequestManager
@inject ISessionProvider SessionProvider
@inject NotificationService NotificationService
@inject NavigationManager NavigationManager
@inject HttpGet GetRequest
@inject HttpPatch PatchRequest

<LoadingContent IsLoaded="_isLoaded">
        <FieldList Title="Информация">
            <FieldListItem Title="Тип подразделения">
                <EditableField OnCancel="@(() => TypeEdit = null)"
                               OnEdit="@(() => TypeEdit = new UpdateUnitsTypeHttpBody(){UnitId = Unit.Id})"
                               OnSave="@(async () => await UpdateType())">
                    <View>@Unit.UnitType</View>
                    <Edit>
                        <RadzenDropDown style="display: flex; "
                                        AllowClear="true"
                                        TValue="Guid"
                                        Data=@(UnitTypes.Select(g => new {g.Id, g.Name}))
                                        TextProperty="Name"
                                        ValueProperty="Id"
                                        @bind-Value="TypeEdit.TypeId">
                        </RadzenDropDown>
                    </Edit>
                </EditableField>
            </FieldListItem>
            
            <FieldListItem Title="Имя подразделения">
                <EditableField OnCancel="@(() => NameEdit = null)"
                               OnEdit="@(() => NameEdit = new UpdateUnitsNameHttpBody(){UnitId = Unit.Id})"
                               OnSave="@(async () => await UpdateName())">
                    <View>@Unit.Name</View>
                    <Edit>
                        <RadzenTextBox style="display: flex;align-items: center"
                                       @bind-Value="NameEdit.Name"
                                       Placeholder="@Unit.Name"/>
                    </Edit>
                </EditableField>
            </FieldListItem>
            
            <FieldListItem Title="Телефон подразделенияи">
                <EditableField OnCancel="@(() => PhoneEdit = null)"
                               OnEdit="@(() => PhoneEdit = new UpdateUnitsPhoneHttpBody(){UnitId = Unit.Id})"
                               OnSave="@(async () => await UpdatePhone())">
                    <View>@Unit.Phone</View>
                    <Edit>
                        <RadzenTextBox style="display: flex;align-items: center"
                                       @bind-Value="PhoneEdit.Phone"
                                       Placeholder="@Unit.Phone"/>
                    </Edit>
                </EditableField>
            </FieldListItem>
            
            <FieldListItem Title="Адресс подразделения">
                <EditableField OnCancel="@(() => AddressEdit = null)"
                               OnEdit="@(() => AddressEdit = new UpdateUnitsAddressHttpBody(){UnitId = Unit.Id})"
                               OnSave="@(async () => await UpdateAddress())">
                    <View>@Unit.Address</View>
                    <Edit>
                        <RadzenTextBox style="display: flex;align-items: center"
                                       @bind-Value="AddressEdit.Address"
                                       Placeholder="@Unit.Address"/>
                    </Edit>
                </EditableField>
            </FieldListItem>
            
            <FieldListItem Title="Формат работы">
                <EditableField OnCancel="@(() => WorkingFormatEdit = null)"
                               OnEdit="@(() => WorkingFormatEdit = new UpdateUnitsWorkingFormatHttpBody(){UnitId = Unit.Id})"
                               OnSave="@(async () => await UpdateWorkingFormat())">
                    <View>@Unit.WorkingFormat</View>
                    <Edit>
                        <RadzenTextBox style="display: flex;align-items: center"
                                       @bind-Value="WorkingFormatEdit.WorkingFormat"
                                       Placeholder="@Unit.WorkingFormat"/>
                    </Edit>
                </EditableField>
            </FieldListItem>
        </FieldList>
</LoadingContent>

@code
{
    [CascadingParameter] public IModalService Modal { get; set; }
    [CascadingParameter] BlazoredModalInstance ModalInstance { get; set; }
    [Parameter] public UnitViewModel Unit { get; set; }
    private List<UnitTypeViewModel> UnitTypes { get; set; }
    private UpdateUnitsNameHttpBody NameEdit { get; set; }
    private UpdateUnitsPhoneHttpBody PhoneEdit { get; set; }
    private UpdateUnitsAddressHttpBody AddressEdit { get; set; }
    private UpdateUnitsTypeHttpBody TypeEdit { get; set; }
    private UpdateUnitsWorkingFormatHttpBody WorkingFormatEdit { get; set; }
    
    private bool _isLoaded;

    protected override async Task OnInitializedAsync()
    {
        await GetRequest.InvokeAsync<GetAllUnitTypesHttpResponse>($"UnitsTypes",
            resp =>
            {
                if (resp.IsSuccess()) {UnitTypes = resp.Success.UnitTypes.ToList();}
                else
                {
                    Console.WriteLine(resp.Error);
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
        _isLoaded = true;
    }

    private async Task LoadData()
    {
        await GetRequest.InvokeAsync<GetAllUnitTypesHttpResponse>($"UnitsTypes",
            resp =>
            {
                if (resp.IsSuccess()) {UnitTypes = resp.Success.UnitTypes.ToList();}
                else
                {
                    Console.WriteLine(resp.Error);
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
        
        await GetRequest.InvokeAsync<GetUnitByIdHttpResponse>($"Units/{Unit.Id}",
            resp =>
            {
                if (resp.IsSuccess()) {Unit = resp.Success.Data;}
                else
                {
                    Console.WriteLine(resp.Error);
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
        StateHasChanged();
    }


    private async Task UpdateName()
    {
        await PatchRequest.InvokeAsync<UpdateUnitsNameHttpResponse, UpdateUnitsNameHttpBody>($"Units/{NameEdit.UnitId}/Name", NameEdit,
            resp =>
            {
                if (resp.IsSuccess()) {}
                else
                {
                    Console.WriteLine(resp.Error);
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
        
        
        NameEdit = null;
        await LoadData();
    }
    
    private async Task UpdatePhone()
    {
        await PatchRequest.InvokeAsync<UpdateUnitsPhoneHttpResponse, UpdateUnitsPhoneHttpBody>($"Units/{PhoneEdit.UnitId}/Phone", PhoneEdit,
            resp =>
            {
                if (resp.IsSuccess()) {}
                else
                {
                    Console.WriteLine(resp.Error);
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
        PhoneEdit = null;
        await LoadData();
    }
    
    private async Task UpdateAddress()
    {
        await PatchRequest.InvokeAsync<UpdateUnitsAddressHttpResponse, UpdateUnitsAddressHttpBody>($"Units/{AddressEdit.UnitId}/Address", AddressEdit,
            resp =>
            {
                if (resp.IsSuccess()) {}
                else
                {
                    Console.WriteLine(resp.Error);
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
            
        AddressEdit = null;
        await LoadData();
    }
    
    private async Task UpdateType()
    {
        await PatchRequest.InvokeAsync<UpdateUnitsTypeHttpResponse, UpdateUnitsTypeHttpBody>($"Units/{TypeEdit.UnitId}/Type", TypeEdit,
            resp =>
            {
                if (resp.IsSuccess()) {}
                else
                {
                    Console.WriteLine(resp.Error);
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
            
        TypeEdit = null;
        await LoadData();
    }
    
    private async Task UpdateWorkingFormat()
    {
        await PatchRequest.InvokeAsync<UpdateUnitsWorkingFormatHttpResponse, UpdateUnitsWorkingFormatHttpBody>($"Units/{WorkingFormatEdit.UnitId}/WorkingFormat", WorkingFormatEdit,
            resp =>
            {
                if (resp.IsSuccess()) {}
                else
                {
                    Console.WriteLine(resp.Error);
                    NavigationManager.NavigateTo("/instance-view");
                }
            });
            
        WorkingFormatEdit = null;
        await LoadData();
    }
}
