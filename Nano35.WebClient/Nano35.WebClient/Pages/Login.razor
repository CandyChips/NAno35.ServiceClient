@page "/log-in"
@using Nano35.WebClient.Services
@using System.Text.RegularExpressions
@using Nano35.Contexts.Http.Identity
@inject IAuthService AuthService
@inject RequestManager RequestManager
@inject NavigationManager NavigationManager
@inject HttpPost PostRequest
@inject JsConsole JsConsole

<CenterContent>
    <LoadingContent IsLoaded="_isLoaded">
        <RadzenPanel>
            <ChildContent>
                <RadzenHeading Text="Авторизация"/>
                <EditForm Model="@_model" OnValidSubmit="HandleValidSubmit">
                    <DataAnnotationsValidator />
                    <InputField Title="Номер телефона">
                        <Controls><RadzenTextBox Style="width: 100%;" @bind-Value="Phone" Change=@(PhoneMask) /></Controls>
                        <Validation><ValidationMessage For="@(() => _model.Login)" /></Validation>
                    </InputField>
                    <InputField Title="Пароль">
                        <Controls><InputText @bind-Value="_model.Password" type="password" class="form-control"/></Controls>
                        <Validation><ValidationMessage For="@(() => _model.Password)" /></Validation>
                    </InputField>
                    <RadzenButton type="submit" Text="Войти" ButtonStyle="ButtonStyle.Primary"/>
                    <NavLink href="registration">
                        <RadzenButton type="button" Text="Регистрация" ButtonStyle="ButtonStyle.Secondary"/>
                    </NavLink>
                    @if (!string.IsNullOrEmpty(_error))
                    {
                        <div class="alert alert-danger mt-3 mb-0">@_error</div>
                    }
                </EditForm>
            </ChildContent>
        </RadzenPanel>
    </LoadingContent>
</CenterContent>

@code
{
    private GenerateUserTokenHttpBody _model = new();
    private bool _isLoaded = true;
    private string _error;
    private string Phone { get ; set ; } = "+7";
    
    protected override void OnInitialized()
    {
        _isLoaded = true;
    }

    private async Task HandleValidSubmit()
    {
        try
        {
            var response = "";
            await PostRequest.InvokeAsync<GenerateUserTokenHttpResponse, GenerateUserTokenHttpBody>($"Identity/Authenticate", _model,
                resp =>
                {
                    if (resp.IsSuccess())
                    {
                        JsConsole.LogAsync(resp.Success.Token);
                        response = resp.Success.Token;
                    }
                    else
                    {
                        Console.WriteLine(resp.Error);
                    }
                });
            
            await AuthService.Login(response);
            NavigationManager.NavigateTo("/");
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }
    
    private void PhoneMask()
    {

        Phone = Regex.Replace(Phone, @"[^\d]", "");
        
        var countryCode = "+7";
        
        if (Phone.StartsWith("7"))
            Phone = Phone.Remove(0,1);
        
        if (Phone.StartsWith("8"))
            Phone = Phone.Remove(0,1);
        
        if (Phone.Length < 10)
            Phone = Phone.PadRight(10);

        if (Phone.Length > 10)
            Phone = Phone.Substring(0, 10);
        
        _model.Login = Phone;
        
        Phone = $"{countryCode}({Phone.Substring(0, 3)}) {Phone.Substring(3, 3)}-{Phone.Substring(6, 2)}-{Phone.Substring(8, 2)}";
        
        
    }
}
